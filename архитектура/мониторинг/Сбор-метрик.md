---
aliases: ["Сбор метрик фронтенда", "Метрики производительности", "Мониторинг производительности"]
tags: [monitoring, metrics, frontend, performance, observability]
---

# Сбор метрик фронтенд-приложений

## Общее понимание

Сбор метрик представляет собой процесс измерения и фиксации различных показателей производительности, доступности и пользовательского опыта в фронтенд-приложениях. В условиях российских реалий 2025 года, сбор метрик становится критически важным для обеспечения стабильной работы приложений в условиях нестабильной инфраструктуры и санкционных ограничений.

## Категории метрик

### 1. Метрики производительности

#### Web Vitals (Core Web Vitals 2025)
- **Largest Contentful Paint (LCP)** - время открытия страницы до появления самого большого элемента
- **First Input Delay (FID)** - задержка между первым взаимодействием пользователя и реакцией приложения
- **Cumulative Layout Shift (CLS)** - стабильность визуального представления
- **Interaction to Next Paint (INP)** - новая метрика, заменяющая FID в 2025 году
- **First Contentful Paint (FCP)** - время первого отображения контента

#### Дополнительные метрики производительности
- Total Blocking Time (TBT)
- Time to Interactive (TTI)
- Speed Index
- First Meaningful Paint (FMP)

### 2. Бизнес-метрики

- Количество уникальных пользователей
- Время сессии
- Путь пользователя по приложению
- Конверсии и ключевые события
- Частота ошибок

### 3. Технические метрики

- Загрузка JavaScript/CSS
- Размеры пакетов
- Количество HTTP-запросов
- Время загрузки ресурсов
- Использование памяти и CPU

## Методы сбора метрик

### 1. Browser APIs

#### Navigation Timing API
```javascript
// Сбор метрик времени загрузки страницы
const perfData = performance.getEntriesByType('navigation')[0];
const loadTime = perfData.loadEventEnd - perfData.loadEventStart;
```

#### Resource Timing API
```javascript
// Сбор метрик загрузки ресурсов
const resources = performance.getEntriesByType('resource');
resources.forEach(resource => {
  console.log(`Resource: ${resource.name}, Load time: ${resource.responseEnd - resource.startTime}ms`);
});
```

#### Paint Timing API
```javascript
// Сбор метрик времени отрисовки
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    console.log(`${entry.name}: ${entry.startTime}ms`);
  }
});
observer.observe({entryTypes: ['paint']});
```

#### Long Tasks API
```javascript
// Обнаружение долгих задач, блокирующих UI
const observer = new PerformanceObserver((list) => {
  for (const entry of list.getEntries()) {
    console.log(`Long task detected: ${entry.duration}ms`);
  }
});
observer.observe({entryTypes: ['longtask']});
```

### 2. Custom Metrics

Создание собственных метрик для измерения бизнес-важных показателей:
```javascript
// Измерение времени до загрузки критического контента
function measureCriticalContentLoad() {
  const startTime = Date.now();
  
  // Ждем загрузки критического контента
  const criticalElement = document.querySelector('.critical-content');
  if (criticalElement) {
    const loadTime = Date.now() - startTime;
    // Отправка метрики в систему мониторинга
    sendMetric('critical_content_load_time', loadTime);
  }
}
```

## Инструменты для сбора метрик

### 1. Web Vitals Library

Google Web Vitals Library предоставляет стандартизированный способ измерения Core Web Vitals:
```javascript
import {getCLS, getFID, getFCP, getLCP, getINP} from 'web-vitals';

function sendToAnalytics(metric) {
  // Отправка метрики в аналитическую систему
  analytics.track(metric.name, metric.value);
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getINP(sendToAnalytics);
```

### 2. Custom Metrics Library

Разработка собственной библиотеки для специфичных метрик:
```javascript
class FrontendMetrics {
  constructor() {
    this.metrics = {};
  }
  
  measure(name, value) {
    this.metrics[name] = {
      value,
      timestamp: Date.now(),
      userAgent: navigator.userAgent
    };
    this.send(name, value);
  }
  
  send(name, value) {
    // Отправка метрики в систему мониторинга
    fetch('/api/metrics', {
      method: 'POST',
      body: JSON.stringify({
        name,
        value,
        timestamp: Date.now()
      })
    });
  }
}

const metrics = new FrontendMetrics();
```

## Российские особенности 2025 года

### 1. Отечественные инструменты

В связи с ограничениями на зарубежные сервисы, в 2025 году наблюдается переход к:
- Российским системам аналитики (Мегагруп, Аналитика.ру)
- Локальным решениям для мониторинга (например, на базе ClickHouse)
- Отказу от Google Analytics в пользу отечественных аналогов

### 2. Инфраструктурные особенности

- Учет специфики работы в сетях российских провайдеров
- Адаптация метрик к различной скорости интернета в регионах
- Мониторинг работы в условиях санкционных ограничений

### 3. Требования безопасности

- Обезличивание данных пользователей при сборе метрик
- Соответствие 152-ФЗ "О персональных данных"
- Локальное хранение метрик без передачи за границу

## Практические рекомендации

### 1. Оптимизация отправки метрик

```javascript
// Группировка и отложенная отправка метрик
class MetricsBatchSender {
  constructor(batchSize = 10, timeout = 5000) {
    this.batch = [];
    this.batchSize = batchSize;
    this.timeout = timeout;
  }
  
  add(metric) {
    this.batch.push(metric);
    
    if (this.batch.length >= this.batchSize) {
      this.sendBatch();
    } else if (this.batch.length === 1) {
      // Устанавливаем таймаут для отправки
      setTimeout(() => this.sendBatch(), this.timeout);
    }
  }
  
  sendBatch() {
    if (this.batch.length > 0) {
      fetch('/api/metrics/batch', {
        method: 'POST',
        body: JSON.stringify(this.batch)
      });
      this.batch = [];
    }
  }
}
```

### 2. Учет ограничений браузеров

- Ограничение на частоту отправки метрик
- Использование Beacon API для надежной отправки:
```javascript
// Использование Navigator.sendBeacon для отправки метрик
navigator.sendBeacon('/api/metrics', JSON.stringify(metrics));
```

### 3. Адаптивный сбор метрик

```javascript
// Адаптивный сбор метрик в зависимости от производительности устройства
function shouldCollectMetrics() {
  const connection = navigator.connection;
  const deviceMemory = navigator.deviceMemory;
  
  // Снижение частоты сбора метрик на слабых устройствах
  if (deviceMemory && deviceMemory < 4) {
    return Math.random() < 0.3; // Только 30% сэмплирование
  }
  
  // Снижение частоты при медленном соединении
  if (connection && connection.effectiveType.includes('slow')) {
    return Math.random() < 0.5; // Только 50% сэмплирование
  }
  
  return true;
}
```

## Стратегии сэмплирования

### 1. Вероятностное сэмплирование

```javascript
function sampleMetric(probability = 0.1) {
  return Math.random() < probability;
}

// Пример использования
if (sampleMetric(0.05)) { // Сэмплирование 5%
  sendMetric('user_interaction', interactionData);
}
```

### 2. Адаптивное сэмплирование

```javascript
class AdaptiveSampler {
  constructor(initialRate = 0.1) {
    this.rate = initialRate;
    this.metricsCount = 0;
    this.errorCount = 0;
  }
  
  shouldSample() {
    // Увеличиваем сэмплирование при увеличении ошибок
    if (this.errorCount > 10) {
      this.rate = Math.min(1.0, this.rate * 1.5);
    } else if (this.errorCount === 0 && this.metricsCount > 1000) {
      this.rate = Math.max(0.01, this.rate * 0.9);
    }
    
    this.metricsCount++;
    return Math.random() < this.rate;
  }
  
  reportError() {
    this.errorCount++;
  }
}
```

## Заключение

Сбор метрик фронтенд-приложений в 2025 году требует учета как международных стандартов, так и российской специфики. Важно строить гибкую систему сбора, которая может адаптироваться к изменяющимся требованиям и ограничениям внешней среды, при этом обеспечивая надежную и безопасную передачу данных.

> [!tip] Совет
> Регулярно пересматривайте набор собираемых метрик, удаляя неиспользуемые показатели для снижения нагрузки на приложение и повышения эффективности мониторинга.

> [!warning] Важно
> При сборе метрик строго соблюдайте требования законодательства о защите персональных данных и не передавайте чувствительную информацию за границу.