---
aliases: ["Сервис-воркеры", "Service Worker", "SW"]
tags: [pwa, service-worker, javascript, web-api, caching]
---

# Service Workers

Service Worker — это скрипт, который позволяет веб-приложениям перехватывать сетевые запросы, кэшировать ресурсы и работать в автономном режиме. Это ключевая технология для создания прогрессивных веб-приложений (PWA).

## Что такое Service Worker

Service Worker — это специальный JavaScript-файл, который работает в фоновом режиме, отдельно от основного потока веб-страницы. Он действует как прокси-сервер между веб-приложением, браузером и сетью (при наличии).

## Основные возможности

- **Кэширование ресурсов** — позволяет хранить статические и динамические данные локально
- **Автономная работа** — обеспечивает работу приложения без подключения к интернету
- **Push-уведомления** — позволяет отправлять уведомления даже когда вкладка закрыта
- **Перехват сетевых запросов** — позволяет управлять тем, как приложение взаимодействует с сервером
- **Фоновая синхронизация** — позволяет синхронизировать данные в фоновом режиме

## Жизненный цикл Service Worker

Service Worker проходит через несколько этапов:

1. **Регистрация** — браузер регистрирует Service Worker
2. **Установка** — происходит загрузка и кэширование ресурсов
3. **Активация** — Service Worker становится активным и может перехватывать запросы
4. **Обслуживание** — Service Worker обрабатывает запросы и события
5. **Обновление** — происходит обновление Service Worker при изменении кода

## Пример регистрации Service Worker

```javascript
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then((registration) => {
        console.log('Service Worker зарегистрирован с scope:', registration.scope);
      })
      .catch((error) => {
        console.log('Регистрация Service Worker не удалась:', error);
      });
  });
}
```

## Пример базового Service Worker

```javascript
const CACHE_NAME = 'my-pwa-cache-v1';
const urlsToCache = [
  '/',
  '/styles/main.css',
  '/scripts/main.js',
  '/images/logo.png'
];

self.addEventListener('install', (event) => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('Открыт кэш');
        return cache.addAll(urlsToCache);
      })
  );
});

self.addEventListener('fetch', (event) => {
  event.respondWith(
    caches.match(event.request)
      .then((response) => {
        // Возвращаем кэшированный ответ или делаем сетевой запрос
        if (response) {
          return response;
        }
        return fetch(event.request);
      }
    )
  );
});
```

## Особенности работы Service Worker

- Service Worker не имеет доступа к DOM
- Работает только по HTTPS (кроме localhost)
- Имеет ограниченный жизненный цикл — может быть остановлен браузером
- Может использовать IndexedDB для хранения данных
- Использует события для взаимодействия с основным приложением

## Стратегии кэширования

Service Worker позволяет реализовать различные стратегии кэширования:

- **Cache First** — сначала проверяет кэш, затем сеть
- **Network First** — сначала сеть, затем кэш
- **Cache Only** — только кэшированные ресурсы
- **Network Only** — только сетевые ресурсы
- **Stale While Revalidate** — возвращает кэш, но обновляет его в фоне

## Особенности для российского рынка

В России при работе с Service Workers необходимо учитывать:

- Ограничения на доступ к зарубежным CDN и сервисам
- Необходимость локализации ресурсов для автономной работы
- Особенности работы с российскими браузерами (Яндекс.Браузер, Mail.Ru Browser)
- Потенциальные ограничения на push-уведомления в некоторых регионах

## Отладка Service Workers

Для отладки Service Workers в Chrome DevTools:

1. Откройте DevTools → Application → Service Workers
2. Используйте консоль для логирования событий
3. Включите опцию "Update on reload" для разработки
4. Используйте "Bypass for network" для обхода Service Worker

## Проблемы и решения

- **Проблема обновления** — Service Worker может не обновляться при изменении кода
  - Решение: Изменение имени кэша при каждом обновлении
  
- **Проблема с HTTPS** — Service Worker требует безопасное соединение
  - Решение: Использование HTTPS на продакшене, localhost на разработке

- **Проблема с долгим ожиданием** — Service Worker может быть остановлен
  - Решение: Использование Background Sync API для критических задач

## Заключение

Service Workers являются ключевой технологией для создания автономных веб-приложений. Они обеспечивают возможность работы без интернета, кэширование ресурсов и push-уведомления, что делает их незаменимыми для современных PWA.

> [!tip] Совет
> Начинайте с простых стратегий кэширования и постепенно усложняйте логику Service Worker.

> [!warning] Важно
> В России могут действовать ограничения на использование некоторых API, связанных с Service Workers, особенно в государственных и корпоративных сетях.

Следующие темы: [[Введение в PWA]], [[Web App Manifest]], [[Кэширование]], [[Оффлайн работа]]