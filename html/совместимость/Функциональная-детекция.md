---
aliases: ["Feature Detection", "Определение возможностей", "Детекция возможностей"]
tags: [html, javascript, compatibility, feature-detection]
---

# Функциональная детекция (Feature Detection)

**Функциональная детекция** — это техника определения наличия или отсутствия определённых возможностей в браузере пользователя. Вместо определения версии браузера или типа устройства, функциональная детекция проверяет, поддерживает ли браузер конкретную функцию или API.

## Основные принципы

### 1. Проверка возможностей, а не браузеров
- Вместо определения "какой браузер", проверяем "что может браузер"
- Это позволяет избежать ложных срабатываний при определении браузера
- Поддержка функций может различаться даже в рамках одной версии браузера

### 2. Постепенное улучшение
- Базовая функциональность доступна всем пользователям
- Дополнительные возможности включаются при наличии поддержки
- Обеспечивается fallback для неподдерживаемых возможностей

### 3. Безопасность проверок
- Проверки не должны вызывать ошибок в старых браузерах
- Используются безопасные методы доступа к свойствам и методам
- Обрабатываются исключения при выполнении проверок

## Техники функциональной детекции

### 1. Проверка свойств объектов

```javascript
// Проверка поддержки Canvas
if (window.HTMLCanvasElement) {
  // Код для работы с Canvas
  var canvas = document.getElementById('myCanvas');
  var ctx = canvas.getContext('2d');
  // Рисуем что-то
} else {
  // Альтернативный способ отображения информации
  document.getElementById('myCanvas').innerHTML = 'Здесь должно быть изображение';
}

// Проверка поддержки localStorage
if (typeof(Storage) !== "undefined") {
  // Код для работы с localStorage
  localStorage.setItem("test", "value");
} else {
  // Альтернативное хранилище данных
  document.cookie = "test=value";
}
```

### 2. Проверка методов

```javascript
// Проверка поддержки методов массива
if (Array.prototype.forEach) {
  // Используем forEach
  myArray.forEach(function(item) {
    console.log(item);
  });
} else {
  // Альтернативный способ перебора
  for (var i = 0; i < myArray.length; i++) {
    console.log(myArray[i]);
  }
}

// Проверка поддержки методов DOM
if (document.querySelector) {
  // Используем современные селекторы
  var element = document.querySelector('.my-class');
} else {
  // Используем старые методы
  var element = document.getElementsByClassName('my-class')[0];
}
```

### 3. Проверка CSS-свойств

```javascript
// Проверка поддержки CSS-свойства
function supportsCSSProperty(property) {
  var div = document.createElement('div');
  var prefixes = ['', '-webkit-', '-moz-', '-ms-', '-o-'];
  
  for (var i = 0; i < prefixes.length; i++) {
    var prefixedProperty = prefixes[i] + property;
    if (prefixedProperty in div.style) {
      return true;
    }
  }
  return false;
}

// Использование
if (supportsCSSProperty('flex')) {
  // Используем flexbox
  document.body.classList.add('flex-supported');
} else {
  // Используем альтернативные стили
  document.body.classList.add('flex-not-supported');
}
```

### 4. Проверка событий

```javascript
// Проверка поддержки сенсорных событий
function isTouchDevice() {
  return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
}

if (isTouchDevice()) {
  // Добавляем сенсорные обработчики
  element.addEventListener('touchstart', handleTouchStart);
  element.addEventListener('touchmove', handleTouchMove);
} else {
  // Добавляем мышиные обработчики
  element.addEventListener('mousedown', handleMouseDown);
  element.addEventListener('mousemove', handleMouseMove);
}
```

## Современные подходы

### 1. CSS Feature Queries

```css
/* Проверка поддержки flexbox */
@supports (display: flex) {
  .container {
    display: flex;
  }
}

/* Проверка поддержки CSS Grid */
@supports (display: grid) {
  .grid-container {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Проверка поддержки нескольких свойств */
@supports (display: grid) and (min-resolution: 2dppx) {
  .high-res-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
  }
}
```

### 2. Modernizr

```javascript
// Проверка с помощью Modernizr
if (Modernizr.canvas) {
  // Код для работы с Canvas
} else {
  // Альтернативный код
}

if (Modernizr.webgl) {
  // Используем WebGL
} else {
  // Используем Canvas 2D или другую альтернативу
}

if (Modernizr.localstorage) {
  // Используем localStorage
} else {
  // Используем cookie или другой способ хранения
}
```

### 3. Встроенные проверки в JavaScript

```javascript
// Проверка поддержки Promise
if (typeof Promise !== 'undefined') {
  // Используем Promise
  new Promise(function(resolve, reject) {
    // ...
  });
} else {
  // Используем полифил или альтернативный подход
  // (например, библиотека es6-promise)
}

// Проверка поддержки async/await
if (typeof Symbol !== 'undefined' && Symbol.asyncIterator) {
  // Код с async/await
  async function fetchData() {
    // ...
  }
} else {
  // Альтернативный подход
}
```

## Практические примеры

### Пример 1: Детекция поддержки Web Workers

```javascript
// Проверка поддержки Web Workers
if (window.Worker) {
  // Создание веб-воркера
  var worker = new Worker('worker.js');
  
  worker.postMessage('Привет из основного потока');
  
  worker.onmessage = function(e) {
    console.log('Получено из воркера: ' + e.data);
  };
} else {
  // Альтернативная реализация для старых браузеров
  console.log('Web Workers не поддерживаются, выполнение в основном потоке');
  // Выполняем задачу в основном потоке
}
```

### Пример 2: Детекция поддержки MediaRecorder API

```javascript
// Проверка поддержки MediaRecorder API
if (navigator.mediaDevices && window.MediaRecorder) {
  // Запись аудио/видео
  navigator.mediaDevices.getUserMedia({ audio: true, video: true })
    .then(function(stream) {
      var mediaRecorder = new MediaRecorder(stream);
      // Начинаем запись
    })
    .catch(function(err) {
      console.log('Ошибка доступа к медиаустройствам: ' + err);
    });
} else {
  // Альтернативный способ захвата медиа
  console.log('MediaRecorder API не поддерживается');
  // Предлагаем пользователю загрузить файл
}
```

### Пример 3: Детекция поддержки WebAssembly

```javascript
// Проверка поддержки WebAssembly
if (typeof WebAssembly === 'object' && typeof WebAssembly.instantiate === 'function') {
  // Загрузка и выполнение WebAssembly модуля
  fetch('module.wasm')
    .then(response => response.arrayBuffer())
    .then(bytes => WebAssembly.instantiate(bytes))
    .then(results => {
      // Использование WebAssembly модуля
      console.log('WebAssembly работает');
    })
    .catch(error => {
      console.log('Ошибка загрузки WebAssembly: ' + error);
    });
} else {
  // Альтернативная реализация на JavaScript
  console.log('WebAssembly не поддерживается, используем JavaScript реализацию');
}
```

## Лучшие практики

### 1. Проверяйте возможности безопасно

```javascript
// Правильно: безопасная проверка
function supportsGeolocation() {
  return 'geolocation' in navigator;
}

// Правильно: проверка с try-catch
function supportsWebP() {
  try {
    var canvas = document.createElement('canvas');
    canvas.toDataURL('image/webp');
    return canvas.toDataURL('image/webp').indexOf('data:image/webp') === 0;
  } catch(e) {
    return false;
  }
}
```

### 2. Используйте полифилы при необходимости

```javascript
// Проверка и добавление полифила для Object.assign
if (typeof Object.assign !== 'function') {
  // Полифил для Object.assign
  Object.assign = function(target) {
    if (target == null) {
      throw new TypeError('Cannot convert undefined or null to object');
    }
    
    var to = Object(target);
    
    for (var index = 1; index < arguments.length; index++) {
      var nextSource = arguments[index];
      
      if (nextSource != null) {
        for (var nextKey in nextSource) {
          if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {
            to[nextKey] = nextSource[nextKey];
          }
        }
      }
    }
    return to;
  };
}
```

### 3. Кэшируйте результаты проверок

```javascript
// Кэширование результатов проверок
var featureTests = {
  canvas: function() {
    return !!window.HTMLCanvasElement;
  },
  
  webgl: function() {
    var canvas = document.createElement('canvas');
    return !!(window.WebGLRenderingContext && 
              (canvas.getContext('webgl') || canvas.getContext('experimental-webgl')));
  },
  
  localStorage: function() {
    try {
      var test = '__storage_test__';
      localStorage.setItem(test, test);
      localStorage.removeItem(test);
      return true;
    } catch(e) {
      return false;
    }
  }
};

// Кэш результатов
var featureCache = {};

function supports(feature) {
  if (featureCache[feature] === undefined) {
    featureCache[feature] = featureTests[feature]();
  }
  return featureCache[feature];
}

// Использование
if (supports('canvas')) {
  // Используем canvas
}
```

## Особенности для российского рынка (2025)

В России в 2025 году особенно важно учитывать:

1. **Широкое использование отечественных браузеров**: Яндекс.Браузер, Mail.ru Browser и другие отечественные решения могут иметь особенности в реализации стандартов, что требует тщательной проверки поддержки функций.

2. **Разнообразие версий браузеров**: В корпоративных сетях и государственных учреждениях могут использоваться устаревшие версии браузеров, что требует проверки поддержки базовых возможностей.

3. **Ограниченные возможности устройств**: В регионах могут использоваться более старые устройства с ограниченными возможностями, что требует проверки поддержки ресурсоемких функций.

4. **Специфика работы с локальными API**: Некоторые отечественные браузеры могут иметь ограничения или особенности в работе с определенными API, что требует дополнительной проверки.

## Инструменты для функциональной детекции

- **Modernizr**: Библиотека для автоматической проверки поддержки возможностей
- **Feature.js**: Легковесная библиотека для детекции возможностей
- **caniuse-api**: API для проверки совместимости возможностей с браузерами
- **polyfill.io**: Автоматическое подключение полифилов для поддержки устаревших браузеров

## Связанные темы

- [[Graceful-degradation]]
- [[Progressive-enhancement]]
- [[Совместимость-с-различными-устройствами]]
- [[Современные-и-устаревшие-функции]]

## Источники и дополнительные ресурсы

- [MDN Web Docs: Feature Detection](https://developer.mozilla.org/ru/docs/Learn/Tools_and_testing/Cross_browser_testing/Feature_detection)
- [Modernizr Documentation](https://modernizr.com/docs)
- [Feature.js GitHub](https://github.com/viljamis/feature.js)
- [Web.dev: Feature Detection](https://web.dev/feature-policy/)