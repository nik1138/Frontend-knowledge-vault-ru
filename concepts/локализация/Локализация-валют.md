---
aliases: [Форматирование валют, Работа с деньгами, Валютная локализация]
tags: [programming, localization, currencies, frontend, javascript]
---

# Локализация валют

## Обзор

Локализация валют — это процесс адаптации отображения денежных сумм в соответствии с региональными и культурными стандартами. Это включает в себя правильное форматирование чисел, использование соответствующих символов валюты, а также соблюдение правил округления и отображения дробных частей.

## Основные аспекты локализации валют

### Форматы отображения

Разные регионы используют различные форматы для отображения валют:

- США: $1,234.56
- Германия: 1.234,56 €
- Япония: ¥1,234
- Россия: 1 234,56 ₽

### Символы валюты

- Позиция символа (до или после числа)
- Использование аббревиатур (USD, EUR) или символов ($, €)
- Локальные символы валюты

## Встроенные возможности JavaScript

### Intl.NumberFormat для валют

```javascript
// Базовое форматирование валюты
const amount = 1234.56;

const formattedUSD = new Intl.NumberFormat('en-US', {
  style: 'currency',
  currency: 'USD'
}).format(amount);
console.log(formattedUSD); // $1,234.56

const formattedEUR = new Intl.NumberFormat('de-DE', {
  style: 'currency',
  currency: 'EUR'
}).format(amount);
console.log(formattedEUR); // 1.234,56 €

const formattedRUB = new Intl.NumberFormat('ru-RU', {
  style: 'currency',
  currency: 'RUB'
}).format(amount);
console.log(formattedRUB); // 1 234,56 ₽
```

### Настройка форматирования валюты

```javascript
const amount = 1234.567;

// Различные опции форматирования
const options = {
  style: 'currency',
  currency: 'USD',
  currencyDisplay: 'symbol', // 'symbol', 'code', 'name'
  minimumFractionDigits: 2,
  maximumFractionDigits: 2,
  useGrouping: true
};

const formatted = new Intl.NumberFormat('en-US', options).format(amount);
console.log(formatted); // $1,234.57 (с округлением)

// Отображение кода валюты вместо символа
const optionsCode = {
  style: 'currency',
  currency: 'USD',
  currencyDisplay: 'code'
};

const formattedCode = new Intl.NumberFormat('en-US', optionsCode).format(amount);
console.log(formattedCode); // USD 1,234.57
```

## Работа с различными валютами

### Словарь валют

```javascript
// Словарь с информацией о валютах
const currencyInfo = {
  'USD': { symbol: '$', name: 'Доллар США', fraction: 2 },
  'EUR': { symbol: '€', name: 'Евро', fraction: 2 },
  'JPY': { symbol: '¥', name: 'Японская иена', fraction: 0 },
  'RUB': { symbol: '₽', name: 'Российский рубль', fraction: 2 },
  'CNY': { symbol: '¥', name: 'Китайский юань', fraction: 2 }
};

function formatCurrency(amount, currencyCode, locale = 'en-US') {
  const currency = currencyInfo[currencyCode];
  if (!currency) {
    throw new Error(`Неизвестная валюта: ${currencyCode}`);
  }

  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: currencyCode,
    minimumFractionDigits: currency.fraction,
    maximumFractionDigits: currency.fraction
  }).format(amount);
}

// Использование
console.log(formatCurrency(1234.5, 'USD', 'en-US')); // $1,234.50
console.log(formatCurrency(1234.5, 'JPY', 'ja-JP')); // ¥1,235 (без копеек)
console.log(formatCurrency(1234.5, 'RUB', 'ru-RU')); // 1 234,50 ₽
```

### Конвертация валют

```javascript
class CurrencyConverter {
  constructor(exchangeRates) {
    // exchangeRates: объект с курсами валют относительно базовой
    this.rates = exchangeRates;
  }

  convert(amount, fromCurrency, toCurrency) {
    if (fromCurrency === toCurrency) {
      return amount;
    }

    // Конвертация через базовую валюту
    const amountInBase = amount / this.rates[fromCurrency];
    const convertedAmount = amountInBase * this.rates[toCurrency];
    
    return convertedAmount;
  }

  format(amount, currency, locale = 'en-US') {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: currency === 'JPY' ? 0 : 2,
      maximumFractionDigits: currency === 'JPY' ? 0 : 2
    }).format(amount);
  }

  convertAndFormat(amount, fromCurrency, toCurrency, locale = 'en-US') {
    const converted = this.convert(amount, fromCurrency, toCurrency);
    return this.format(converted, toCurrency, locale);
  }
}

// Использование
const converter = new CurrencyConverter({
  'USD': 1,
  'EUR': 0.93,
  'RUB': 90,
  'JPY': 149
});

console.log(converter.convertAndFormat(100, 'USD', 'EUR', 'de-DE')); // 93,00 €
console.log(converter.convertAndFormat(100, 'USD', 'RUB', 'ru-RU')); // 9 000,00 ₽
```

## Практические примеры использования

### Форматирование цен в интернет-магазине

```javascript
class PriceFormatter {
  constructor(defaultLocale = 'en-US', defaultCurrency = 'USD') {
    this.defaultLocale = defaultLocale;
    this.defaultCurrency = defaultCurrency;
  }

  formatPrice(price, currency = this.defaultCurrency, locale = this.defaultLocale) {
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(price);
  }

  formatWithSavings(price, originalPrice, currency = this.defaultCurrency, locale = this.defaultLocale) {
    const formattedPrice = this.formatPrice(price, currency, locale);
    const formattedOriginal = this.formatPrice(originalPrice, currency, locale);
    
    if (originalPrice > price) {
      const savingsPercent = Math.round(((originalPrice - price) / originalPrice) * 100);
      return {
        current: formattedPrice,
        original: formattedOriginal,
        savings: `${savingsPercent}%`,
        savingsAmount: this.formatPrice(originalPrice - price, currency, locale)
      };
    }
    
    return { current: formattedPrice };
  }
}

// Использование
const formatter = new PriceFormatter('ru-RU', 'RUB');
const result = formatter.formatWithSavings(8990, 9990, 'RUB', 'ru-RU');

console.log(result);
// {
//   current: "8 990,00 ₽",
//   original: "9 990,00 ₽",
//   savings: "10%",
//   savingsAmount: "1 000,00 ₽"
// }
```

### Работа с криптовалютами

```javascript
// Форматирование криптовалют с высокой точностью
function formatCrypto(amount, cryptoCode, locale = 'en-US', maxDigits = 8) {
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: cryptoCode,
    currencyDisplay: 'code',
    minimumFractionDigits: 0,
    maximumFractionDigits: maxDigits
  }).format(amount);
}

// Пример для биткоина
console.log(formatCrypto(0.12345678, 'BTC', 'en-US')); // BTC 0.12345678
```

## Работа с библиотеками

### Accounting.js

```javascript
// Библиотека для точных вычислений с валютой
import accounting from 'accounting';

// Форматирование с настройками
const formatted = accounting.formatMoney(1234.56, {
  symbol: "₽",
  format: "%s%v", // символ перед значением
  decimal: ",",
  thousand: " ",
  precision: 2
});

console.log(formatted); // ₽1 234,56
```

### Dinero.js

```javascript
import Dinero from 'dinero.js';

// Создание денежной суммы
const price = Dinero({ amount: 123456, currency: 'RUB' });

// Форматирование с локализацией
const formatted = price.setLocale('ru-RU').toFormat(); 
console.log(formatted); // 1 234,56 ₽

// Математические операции с сохранением точности
const total = price.multiply(2).add(Dinero({ amount: 10000, currency: 'RUB' }));
console.log(total.toFormat()); // 2 569,12 ₽
```

## Работа с API и внешними сервисами

### Получение актуальных курсов валют

```javascript
class ExchangeRateService {
  constructor(apiUrl) {
    this.apiUrl = apiUrl;
  }

  async getExchangeRates(baseCurrency) {
    try {
      const response = await fetch(`${this.apiUrl}/latest?base=${baseCurrency}`);
      const data = await response.json();
      return data.rates;
    } catch (error) {
      console.error('Ошибка получения курсов валют:', error);
      return {};
    }
  }

  async formatWithLiveRates(amount, fromCurrency, toCurrency, locale = 'en-US') {
    const rates = await this.getExchangeRates(fromCurrency);
    const rate = rates[toCurrency];
    
    if (!rate) {
      throw new Error(`Курс для ${toCurrency} не найден`);
    }

    const convertedAmount = amount * rate;
    
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: toCurrency,
      minimumFractionDigits: toCurrency === 'JPY' ? 0 : 2,
      maximumFractionDigits: toCurrency === 'JPY' ? 0 : 2
    }).format(convertedAmount);
  }
}
```

## Практические рекомендации

### 1. Точность вычислений

```javascript
// Проблема с плавающей точкой в JavaScript
console.log(0.1 + 0.2); // 0.30000000000000004

// Решение: работа с целыми числами (копейками, центами)
function formatCentsAsCurrency(cents, currency, locale) {
  const amount = cents / 100; // для валют с 2 знаками после запятой
  return new Intl.NumberFormat(locale, {
    style: 'currency',
    currency: currency
  }).format(amount);
}

// Использование
console.log(formatCentsAsCurrency(12345, 'USD', 'en-US')); // $123.45
```

### 2. Кэширование форматированных значений

```javascript
class CachedCurrencyFormatter {
  constructor() {
    this.cache = new Map();
  }

  format(amount, currency, locale) {
    const cacheKey = `${amount}_${currency}_${locale}`;
    
    if (this.cache.has(cacheKey)) {
      return this.cache.get(cacheKey);
    }

    const formatted = new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency
    }).format(amount);
    
    this.cache.set(cacheKey, formatted);
    return formatted;
  }

  clearCache() {
    this.cache.clear();
  }
}
```

### 3. Обработка ошибок

```javascript
function safeCurrencyFormat(amount, currency, locale = 'en-US') {
  try {
    // Проверка на корректность входных данных
    if (typeof amount !== 'number' || isNaN(amount)) {
      console.warn(`Некорректная сумма: ${amount}`);
      return 'N/A';
    }

    // Проверка на поддерживаемую валюту
    if (!isCurrencySupported(currency)) {
      console.warn(`Валюта не поддерживается: ${currency}`);
      return amount.toString();
    }

    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency
    }).format(amount);
  } catch (error) {
    console.error(`Ошибка форматирования валюты: ${error.message}`);
    return amount.toString();
  }
}

function isCurrencySupported(currencyCode) {
  try {
    new Intl.NumberFormat('en-US', { style: 'currency', currency: currencyCode });
    return true;
  } catch {
    return false;
  }
}
```

## Тестирование локализации валют

### Unit-тесты

```javascript
import { describe, it, expect } from 'vitest';

describe('Currency localization', () => {
  it('should format USD correctly in en-US locale', () => {
    const amount = 1234.56;
    const formatted = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(amount);
    
    expect(formatted).toBe('$1,234.56');
  });

  it('should format RUB correctly in ru-RU locale', () => {
    const amount = 1234.56;
    const formatted = new Intl.NumberFormat('ru-RU', {
      style: 'currency',
      currency: 'RUB'
    }).format(amount);
    
    expect(formatted).toContain('₽');
    expect(formatted).toContain('1 234,56');
  });

  it('should handle zero amount correctly', () => {
    const formatted = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(0);
    
    expect(formatted).toBe('$0.00');
  });

  it('should round correctly', () => {
    const formatted = new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD'
    }).format(1234.567);
    
    expect(formatted).toBe('$1,234.57');
  });
});
```

## Заключение

Локализация валют — важный аспект создания интернационализованных приложений, особенно в сфере электронной коммерции и финансовых сервисов. Правильное форматирование валютных значений повышает доверие пользователей и улучшает пользовательский опыт.

> [!tip]
> Всегда учитывайте культурные особенности отображения валют. В разных странах могут использоваться разные символы, позиции и форматы.

> [!warning]
> Обращайте внимание на точность вычислений с валютами. Используйте целочисленные значения (например, в копейках или центах) для избежания ошибок с плавающей точкой.