---
aliases: ["Иммутабельность", "Немутабельность", "Иммутабельные объекты"]
tags: 
  - programming
  - functional-programming
  - state-management
  - performance
  - concurrency
---

# Иммутабельность (Immutability)

## Определение иммутабельности

**Иммутабельность** (от английского "immutable" - неизменяемый) - это свойство объекта, значение которого не может быть изменено после его создания. При попытке изменения создается новый объект с новым значением, а старый остается неизменным.

В контексте программирования иммутабельный объект - это объект, состояние которого не может быть изменено после его инициализации. Это противоположность **мутабельности**, когда объекты могут изменяться после создания.

## Мутабельные vs Иммутабельные объекты

### Мутабельные объекты

Мутабельные объекты могут изменяться после создания. В JavaScript, например:

```javascript
let arr = [1, 2, 3];
arr.push(4); // arr теперь [1, 2, 3, 4] - изменен оригинальный массив
console.log(arr); // [1, 2, 3, 4]
```

### Иммутабельные объекты

Иммутабельные объекты не могут быть изменены после создания. Любые "изменения" приводят к созданию нового объекта:

```javascript
const arr = [1, 2, 3];
const newArr = [...arr, 4]; // создание нового массива, старый остается неизменным
console.log(arr); // [1, 2, 3]
console.log(newArr); // [1, 2, 3, 4]
```

## Преимущества иммутабельности

- **Предсказуемость кода**: значения не изменяются неожиданно, что упрощает отладку
- **Безопасность при многопоточности**: отсутствие состояния гонки при доступе из разных потоков
- **Упрощение тестирования**: проще тестировать функции, которые не изменяют внешнее состояние
- **Упрощение логики отмены/повтора**: можно легко сохранять предыдущие состояния
- **Эффективность сравнений**: можно использовать ссылочное равенство для проверки неизменности

## Иммутабельные структуры данных

### Примитивные типы

В большинстве языков примитивные типы (числа, строки, булевы значения) являются иммутабельными:

```javascript
let x = 5;
let y = x;
x = 10; // y по-прежнему равно 5
```

### Структуры данных

Для сложных структур данных часто используются специальные библиотеки, такие как Immutable.js в JavaScript, или встроенные функции:

```javascript
// Использование Object.freeze для создания иммутабельного объекта
const obj = Object.freeze({ a: 1, b: 2 });
// obj.a = 3; // ошибка в strict mode
```

## Реализация в разных языках

### JavaScript

```javascript
// Использование spread-оператора
const originalArray = [1, 2, 3];
const newArray = [...originalArray, 4];

// Использование Object.assign
const originalObj = { a: 1, b: 2 };
const newObj = { ...originalObj, c: 3 };

// Использование библиотеки Immutable.js
import { Map } from 'immutable';
const immutableMap = Map({ a: 1, b: 2 });
const newMap = immutableMap.set('c', 3);
```

### Java

```java
// Использование final
final List<String> list = Arrays.asList("a", "b", "c"); // неизменяемый список

// Использование record (Java 14+)
public record Person(String name, int age) {}
```

### C#

```csharp
// Использование readonly
public readonly struct Point
{
    public double X { get; }
    public double Y { get; }
    
    public Point(double x, double y) => (X, Y) = (x, y);
}
```

## Связь с функциональным программированием

Иммутабельность является фундаментальным принципом функционального программирования. Функции, которые не изменяют внешнее состояние и возвращают одинаковые результаты при одинаковых аргументах (чистые функции), зависят от иммутабельности:

```javascript
// Чистая функция
const add = (a, b) => a + b;

// Функция, не изменяющая состояние
const incrementArray = (arr) => arr.map(x => x + 1);
```

См. также: [[функциональное программирование]]

## Рассмотрение производительности

### Преимущества

- Упрощение логики кэширования
- Возможность оптимизации сравнений
- Уменьшение количества ошибок, связанных с изменением состояния

### Недостатки

- Повышенное потребление памяти из-за создания новых объектов
- Потенциально более медленные операции при частых изменениях

Для решения этих проблем используются структуры данных с эффективным обновлением (persistent data structures), которые разделяют неизмененные части между версиями.

## Иммутабельность в управлении состоянием

В приложениях с управляемым состоянием (например, Redux, Zustand) иммутабельность помогает отслеживать изменения и предотвращает неожиданные мутации:

```javascript
// Redux Reducer
const counterReducer = (state = 0, action) => {
  switch (action.type) {
    case 'INCREMENT':
      return state + 1; // возвращаем новое состояние, не изменяя старое
    default:
      return state;
  }
};
```

См. также: [[управление состоянием]]

## Иммутабельность в параллельном программировании

В многопоточных приложениях иммутабельные объекты устраняют необходимость синхронизации, так как не могут быть изменены:

```java
// Java - потокобезопасный, потому что объект неизменяем
public final class ImmutablePoint {
    private final int x, y;
    
    public ImmutablePoint(int x, int y) {
        this.x = x;
        this.y = y;
    }
    
    public int getX() { return x; }
    public int getY() { return y; }
}
```

См. также: [[параллельное программирование]]

## Лучшие практики

- Используйте `const` в JavaScript для объявления переменных, которые не должны изменяться
- Создавайте новые объекты при "изменениях", а не модифицируйте существующие
- Используйте библиотеки для работы с иммутабельными структурами данных при необходимости
- Документируйте, какие объекты должны быть иммутабельными
- Избегайте передачи мутабельных объектов между функциями, если не предполагается их изменение

## См. также

- [[функциональное программирование]]
- [[управление состоянием]]
- [[параллельное программирование]]
- [[чистые функции]]
- [[структуры данных]]
