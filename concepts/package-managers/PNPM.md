---
aliases: [Performant NPM, Быстрый менеджер пакетов]
tags: [pnpm, package-manager, frontend, dependencies, performance]
---

# PNPM (Performant NPM)

## Введение

PNPM (Performant NPM) - это быстрый, надежный и экономичный менеджер пакетов для JavaScript, созданный Зивом Сассу (Zoltan Kochan) в 2016 году. PNPM отличается уникальной архитектурой хранения пакетов, которая обеспечивает значительную экономию дискового пространства и ускорение установки пакетов по сравнению с традиционными менеджерами пакетов.

## История и развитие

PNPM был создан как решение проблем, связанных с размером node_modules и временем установки пакетов в традиционных менеджерах пакетов. С момента своего создания PNPM прошел путь от альтернативного инструмента до полноценного конкурента NPM и Yarn, набирая популярность среди разработчиков благодаря своей производительности и эффективности использования дискового пространства.

## Уникальные особенности

### Архитектура хранения

Основное отличие PNPM от других менеджеров пакетов - его уникальная архитектура хранения:

#### Content-Addressable Storage

PNPM использует content-addressable storage (CAS) для хранения пакетов. Каждый пакет хранится только один раз в глобальном хранилище, идентифицируется по хэшу содержимого. Это позволяет:

- Экономить значительное дисковое пространство
- Избежать дублирования пакетов
- Ускорить установку пакетов за счет повторного использования

#### Символические ссылки

Вместо копирования файлов, PNPM создает символические ссылки на пакеты из глобального хранилища в node_modules проекта. Это позволяет:

- Мгновенно устанавливать пакеты
- Экономить дисковое пространство
- Обеспечивать изоляцию зависимостей

### Структура node_modules

В отличие от NPM и Yarn, PNPM создает строгую структуру node_modules, где:

- Только прямые зависимости находятся в корне node_modules
- Косвенные зависимости находятся в отдельной директории (node_modules/.pnpm)
- Обеспечивается изоляция зависимостей и предотвращается "dependency hell"

## Установка и настройка

### Установка PNPM

PNPM можно установить несколькими способами:

```bash
# Установка через NPM
npm install -g pnpm

# Установка через Yarn
yarn global add pnpm

# Установка через Homebrew (macOS)
brew install pnpm

# Установка через скрипт
curl -fsSL https://get.pnpm.io/install.sh | sh -

# Установка через Corepack (если поддерживается)
corepack enable pnpm
```

### Инициализация проекта

```bash
# Создание нового проекта
pnpm init

# Инициализация с ответами по умолчанию
pnpm init --yes
```

## Основные команды

### Управление пакетами

```bash
# Установка всех зависимостей
pnpm install

# Установка конкретного пакета
pnpm add package-name

# Установка как зависимости разработки
pnpm add package-name --save-dev

# Установка как peer зависимости
pnpm add package-name --save-peer

# Установка как опциональной зависимости
pnpm add package-name --save-optional

# Удаление пакета
pnpm remove package-name

# Обновление пакета
pnpm update package-name

# Обновление всех пакетов
pnpm update --latest
```

### Работа со скриптами

```bash
# Запуск скриптов из package.json
pnpm run script-name

# Запуск скрипта (сокращенная форма)
pnpm script-name

# Просмотр доступных скриптов
pnpm run
```

### Информация о проекте

```bash
# Просмотр установленных пакетов
pnpm list

# Просмотр информации о конкретном пакете
pnpm info package-name

# Проверка устаревших пакетов
pnpm outdated

# Аудит безопасности
pnpm audit
```

## Файлы конфигурации

### package.json

PNPM использует стандартный файл package.json:

```json
{
  "name": "my-pnpm-project",
  "version": "1.0.0",
  "main": "index.js",
  "scripts": {
    "start": "node index.js",
    "test": "jest",
    "build": "webpack --mode production"
  },
  "dependencies": {
    "react": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "jest": "^29.0.0"
  }
}
```

### pnpm-lock.yaml

PNPM использует файл pnpm-lock.yaml (в формате YAML) вместо package-lock.json:

```yaml
lockfileVersion: '6.0'

settings:
  autoInstallPeers: true
  excludeLinksFromLockfile: false

dependencies:
  react:
    specifier: ^18.0.0
    version: 18.2.0

devDependencies:
  jest:
    specifier: ^29.0.0
    version: 29.3.1

packages:
  /react/18.2.0:
    resolution: {integrity: sha512-/3IjMdb2L9QbBdWiW5e3P2/npwMBaU9mHCSCUzNln0ZCYbcfTsGbTJrU/kGemdH2IWmB2ioZ+zkxtmq2Y5ZQhg==}
    engines: {node: '>=0.10.0'}
```

### .pnpmrc

Файл .pnpmrc позволяет настраивать поведение PNPM:

```
# Установка режима строгой установки
strict-peer-dependencies=false

# Включение режима shamefully-hoist (для совместимости)
shamefully-hoist=true

# Установка глобального пути установки
store-dir=/path/to/pnpm/store

# Установка количества параллельных операций
network-concurrency=16

# Включение режима offline
offline=true

# Установка режима работы
node-linker=hoisted
```

## Производительность и преимущества

### Экономия дискового пространства

PNPM может экономить до 67% дискового пространства по сравнению с NPM благодаря своей архитектуре хранения:

- Пакеты хранятся только один раз в глобальном хранилище
- Используются символические ссылки вместо копирования файлов
- Общие зависимости между проектами не дублируются

### Ускорение установки

- Установка пакетов может быть до 2 раз быстрее, чем у NPM
- Повторная установка пакетов происходит почти мгновенно
- Эффективное кэширование и повторное использование

### Изоляция зависимостей

PNPM обеспечивает строгую изоляцию зависимостей, что предотвращает:
- Использование неявных зависимостей
- Конфликты версий
- Проблемы совместимости

## Работа с версиями

### Стратегии версионирования

PNPM поддерживает все стандартные стратегии версионирования:
- Точная версия: "1.0.0"
- Карет: "^1.0.0"
- Тильда: "~1.0.0"
- Диапазоны: ">=1.0.0 <2.0.0"

### Управление версиями

```bash
# Проверка текущей версии PNPM
pnpm --version

# Повышение версии проекта
pnpm version major
pnpm version minor
pnpm version patch

# Обновление PNPM до последней версии
pnpm add -g pnpm@latest
```

## Безопасность

### Аудит зависимостей

PNPM предоставляет встроенные механизмы безопасности:

```bash
# Проверка уязвимостей
pnpm audit

# Проверка с отчетом
pnpm audit --audit-level high

# Автоматическое исправление
pnpm audit --fix
```

### Целостность пакетов

PNPM использует хэши для проверки целостности пакетов, что предотвращает установку измененных или вредоносных пакетов.

### Работа с приватными репозиториями

```bash
# Настройка приватного репозитория
pnpm config set @mycompany:registry https://npm.mycompany.com

# Установка токена аутентификации
pnpm config set //npm.mycompany.com/:_authToken TOKEN
```

## Работа в команде

### Совместимость между разработчиками

PNPM обеспечивает согласованность благодаря:
- Файлу pnpm-lock.yaml
- Стандартизированной архитектуре node_modules
- Проверке версий зависимостей

### Работа с моно-репозиториями

PNPM имеет отличную поддержку моно-репозиториев:

```yaml
# pnpm-workspace.yaml
packages:
  - 'packages/*'
  - 'apps/*'
  - '!packages/docs'
```

```bash
# Установка зависимостей для всех пакетов
pnpm install

# Запуск скрипта во всех пакетах
pnpm -r run build

# Запуск скрипта в конкретном пакете
pnpm --filter package-name run build

# Запуск скрипта с зависимостями
pnpm --filter package-name... run build
```

## Сравнение с другими менеджерами пакетов

### PNPM vs NPM

| Характеристика | PNPM | NPM |
|----------------|------|-----|
| Дисковое пространство | Экономичное | Потребляет много |
| Скорость установки | Высокая | Средняя |
| Структура node_modules | Строгая изоляция | Флат-структура |
| Совместимость | Высокая | Стандартная |

### PNPM vs Yarn

| Характеристика | PNPM | Yarn |
|----------------|------|------|
| Дисковое пространство | Наиболее экономичное | Экономичное |
| Скорость установки | Очень высокая | Высокая |
| Zero-Installs | Нет (но эффективное кэширование) | Поддерживается |
| Совместимость с Node.js | Полная | Хорошая |

## Практические примеры

### Создание проекта с PNPM

```bash
mkdir my-pnpm-project
cd my-pnpm-project
pnpm init
pnpm add react react-dom
pnpm add --save-dev jest eslint webpack
```

### Работа с зависимостями

```bash
# Установка зависимости с конкретной версией
pnpm add react@18.2.0

# Установка нескольких зависимостей
pnpm add express cors helmet

# Удаление нескольких зависимостей
pnpm remove jest eslint

# Обновление всех зависимостей
pnpm update --latest
```

### Работа с моно-репозиторием

```bash
# Создание структуры моно-репозитория
mkdir monorepo
cd monorepo
pnpm init
echo "packages:
  - 'packages/*'
  - 'apps/*'" > pnpm-workspace.yaml

# Создание пакетов
mkdir -p packages/shared packages/utils
pnpm --filter shared add lodash
pnpm --filter utils add @types/node
```

## Лучшие практики

### Управление зависимостями

- Регулярное обновление зависимостей
- Использование pnpm-lock.yaml для обеспечения стабильности
- Проверка безопасности перед установкой новых пакетов
- Удаление неиспользуемых зависимостей

### Оптимизация производительности

- Использование глобального хранилища
- Регулярная очистка кэша
- Использование pnpm install --frozen-lockfile в продакшене
- Оптимизация структуры зависимостей

### Работа в команде

- Всегда коммитить pnpm-lock.yaml
- Использовать одинаковую версию PNPM
- Регулярно обновлять pnpm-lock.yaml
- Обучать команду работе с PNPM

## Миграция с других менеджеров

### Миграция с NPM

```bash
# Удаление node_modules и package-lock.json
rm -rf node_modules package-lock.json

# Инициализация с PNPM
pnpm install
```

### Миграция с Yarn

```bash
# Удаление node_modules и yarn.lock
rm -rf node_modules yarn.lock

# Инициализация с PNPM
pnpm install
```

## Расширенные возможности

### Peer Dependencies

PNPM строго обрабатывает peer зависимости, что помогает избежать конфликтов:

```bash
# Установка peer зависимости
pnpm add react --save-peer
```

### Hooks

PNPM поддерживает хуки для выполнения скриптов в определенные моменты:

```javascript
// pnpmfile.js
module.exports = {
  hooks: {
    readPackage(pkg, context) {
      // Манипуляции с метаданными пакета
      return pkg;
    }
  }
};
```

### Скрипты в моно-репозиториях

```bash
# Параллельный запуск скриптов
pnpm -r --parallel run test

# Запуск с ограничением количества процессов
pnpm -r --stream run build

# Запуск в зависимости от графа зависимостей
pnpm -r --sort run build
```

## Устранение неполадок

### Распространенные проблемы

#### Совместимость с инструментами

Некоторые инструменты могут ожидать традиционную структуру node_modules. В таких случаях можно использовать:

```
shamefully-hoist=true
```

В файле .pnpmrc для создания флат-структуры.

#### Глобальные пакеты

```bash
# Установка глобального пакета
pnpm add -g package-name

# Просмотр глобальных пакетов
pnpm list -g

# Удаление глобального пакета
pnpm remove -g package-name
```

## Заключение

PNPM представляет собой передовой инструмент для управления зависимостями в JavaScript проектах. Его уникальная архитектура хранения, высокая производительность и экономичное использование дискового пространства делают его отличным выбором для современных проектов.

PNPM особенно полезен в крупных проектах и моно-репозиториях, где традиционные менеджеры пакетов могут сталкиваться с проблемами производительности и управления зависимостями.

## Связанные концепции

- [[Dependency Management]] - Управление зависимостями
- [[Version Management]] - Управление версиями
- [[NPM]] - Стандартный менеджер пакетов
- [[Yarn]] - Альтернативный менеджер пакетов
- [[Package Management]] - Общие принципы управления пакетами