---
aliases: [SRI, Subresource Integrity, Подписи ресурсов]
tags: [security, web-security, sri, integrity, frontend-security]
---

# Подробная реализация Subresource Integrity (SRI)

## Введение в Subresource Integrity

Subresource Integrity (SRI) — это важная функция безопасности веб-браузеров, которая позволяет проверять целостность внешних ресурсов, загружаемых на веб-страницу. Эта технология помогает предотвратить атаки, связанные с подменой внешних скриптов или стилей, например, при использовании файлов из CDN.

SRI особенно важна в современной веб-разработке, где часто используются внешние библиотеки и фреймворки, загружаемые из сторонних источников. Без SRI вредоносный код может быть внедрен в эти внешние ресурсы, что приведет к компрометации безопасности веб-приложения.

## Что такое SRI и зачем она нужна

Subresource Integrity (SRI) — это механизм безопасности, который позволяет браузеру проверять, что файлы, полученные из внешних источников (например, CDN), не были изменены вредоносным кодом. Он использует криптографические хэши для проверки целостности загружаемых ресурсов.

### Зачем нужна SRI?

- **Защита от подмены ресурсов**: Предотвращает выполнение вредоносного кода, если внешние ресурсы были скомпрометированы
- **Гарантия целостности**: Убедиться, что загруженный файл соответствует ожидаемому содержимому
- **Улучшенная безопасность CDN**: Позволяет безопасно использовать сторонние CDN, не опасаясь за целостность ресурсов
- **Соответствие требованиям**: Многие стандарты безопасности требуют использования SRI для внешних ресурсов

## Как работает SRI

SRI работает путем добавления атрибута `integrity` к тегам `<script>` и `<link>`, содержащего криптографический хэш ожидаемого содержимого файла. Когда браузер загружает ресурс, он вычисляет хэш загруженного содержимого и сравнивает его с хэшем, указанным в атрибуте `integrity`. Если хэши не совпадают, браузер отказывается выполнить или применить ресурс.

### Формат атрибута integrity

Атрибут `integrity` имеет следующий формат:

```
integrity = "алгоритм-хэша-значение-хэша"
```

Например:
- `sha384-...` — хэш, созданный с помощью алгоритма SHA-384
- `sha512-...` — хэш, созданный с помощью алгоритма SHA-512

### Процесс проверки

1. Разработчик вычисляет хэш внешнего ресурса
2. Добавляет хэш в атрибут `integrity` тега `<script>` или `<link>`
3. Браузер загружает ресурс
4. Вычисляет хэш загруженного содержимого
5. Сравнивает вычисленный хэш с указанным в атрибуте `integrity`
6. Если хэши совпадают, ресурс используется, иначе — отклоняется

## Генерация хэшей для SRI

Для использования SRI необходимо сгенерировать криптографический хэш для каждого внешнего ресурса. Существует несколько способов генерации хэшей:

### Использование командной строки

С помощью утилиты `openssl` можно сгенерировать хэши различными алгоритмами:

```bash
# Генерация SHA-384 хэша
openssl dgst -sha384 -binary файл.js | openssl base64 -A

# Генерация SHA-512 хэша
openssl dgst -sha512 -binary файл.js | openssl base64 -A

# Генерация SHA-256 хэша
openssl dgst -sha256 -binary файл.js | openssl base64 -A
```

### Использование Node.js

```javascript
const crypto = require('crypto');
const fs = require('fs');

function generateSRIHash(filePath, algorithm = 'sha384') {
  const content = fs.readFileSync(filePath);
  const hash = crypto
    .createHash(algorithm)
    .update(content)
    .digest('base64');
  
  return `${algorithm}-${hash}`;
}

// Пример использования
const sriHash = generateSRIHash('./path/to/script.js');
console.log(sriHash);
```

### Использование онлайн-генераторов

Существуют онлайн-инструменты для генерации SRI хэшей, такие как:
- SRI Hash Generator от Mozilla
- Онлайн-генераторы на various websites

> [!warning]
> При использовании онлайн-генераторов убедитесь, что вы доверяете источнику, особенно при работе с конфиденциальными файлами.

## Примеры использования в HTML

### Пример с JavaScript файлом

```html
<script src="https://cdn.example.com/lib.js"
        integrity="sha384-abcdefghijklmnopqrstuvwxyz1234567890"
        crossorigin="anonymous">
</script>
```

### Пример со стилями

```html
<link rel="stylesheet" href="https://cdn.example.com/styles.css"
      integrity="sha384-abcdefghijklmnopqrstuvwxyz1234567890"
      crossorigin="anonymous">
```

### Пример с несколькими хэшами

```html
<script src="https://cdn.example.com/lib.js"
        integrity="sha384-abcdefghijklmnopqrstuvwxyz1234567890 sha512-0987654321zyxwvutsrqponmlkjihgfedcba"
        crossorigin="anonymous">
</script>
```

> [!note]
> Можно указать несколько хэшей, разделенных пробелами. Браузер примет ресурс, если хотя бы один из хэшей совпадает.

## Совместимость с браузерами

SRI поддерживается большинством современных браузеров:

- **Chrome**: с версии 45
- **Firefox**: с версии 43
- **Safari**: с версии 10.1
- **Edge**: с версии 17
- **Opera**: с версии 32

> [!tip]
> Для старых браузеров, которые не поддерживают SRI, рекомендуется использовать полифиллы или альтернативные методы защиты.

## Инструменты для генерации SRI

### Онлайн-генераторы

- [SRI Hash Generator](https://www.srihash.org/)
- [KeyCDN SRI Generator](https://www.keycdn.com/sri-generator)

### Node.js пакеты

- `sri-toolbox` — инструмент для генерации и проверки SRI
- `subresource-integrity` — пакет для работы с SRI в Node.js

### CLI инструменты

- `sri-toolbox-cli` — командная строка для генерации SRI хэшей
- `webpack-subresource-integrity` — плагин для Webpack

## Автоматизация процесса

### Использование Webpack

Для автоматической генерации SRI в процессе сборки можно использовать плагин `webpack-subresource-integrity`:

```javascript
const SriPlugin = require('webpack-subresource-integrity');

module.exports = {
  // ... остальная конфигурация
  plugins: [
    new SriPlugin({
      hashFuncNames: ['sha256', 'sha384'],
      enabled: true
    })
  ]
};
```

### Использование Gulp

```javascript
const gulp = require('gulp');
const sri = require('gulp-sri');

gulp.task('sri', function() {
  return gulp.src('dist/*.js')
    .pipe(sri())
    .pipe(gulp.dest('dist'));
});
```

### Использование Grunt

```javascript
module.exports = function(grunt) {
  grunt.initConfig({
    sri: {
      options: {
        algorithms: ['sha384']
      },
      dist: {
        src: ['dist/*.js', 'dist/*.css'],
        dest: 'dist/sri.json'
      }
    }
  });
};
```

## Тонкости реализации

### CORS и атрибут crossorigin

При использовании SRI обязательно нужно указывать атрибут `crossorigin`, даже если ресурс загружается с того же домена. Это связано с тем, что SRI требует CORS-запрос для проверки целостности.

```html
<!-- Правильно -->
<script src="https://cdn.example.com/lib.js"
        integrity="sha384-..."
        crossorigin="anonymous">
</script>

<!-- Неправильно -->
<script src="https://cdn.example.com/lib.js"
        integrity="sha384-...">
</script>
```

### Поддержка разных алгоритмов

Рекомендуется использовать алгоритмы SHA-384 или SHA-512, так как они обеспечивают более высокий уровень безопасности по сравнению с SHA-256.

### Работа с динамическими ресурсами

SRI не может быть использована с динамически генерируемыми ресурсами, так как хэш должен быть известен заранее. В таких случаях необходимо использовать другие методы обеспечения безопасности.

## Возможные проблемы и решения

### Проблема: "Failed to find a valid digest in the 'integrity' attribute"

**Причина**: Хэш в атрибуте `integrity` не соответствует фактическому содержимому файла.

**Решение**: 
1. Перегенерировать хэш для файла
2. Убедиться, что файл не был изменен после генерации хэша
3. Проверить, что используется правильный алгоритм хэширования

### Проблема: Ресурс не загружается в старых браузерах

**Причина**: Некоторые старые браузеры не поддерживают SRI.

**Решение**: 
1. Использовать полифиллы для поддержки SRI в старых браузерах
2. Предоставить резервные копии ресурсов без SRI для старых браузеров

### Проблема: Не работает с Content Security Policy (CSP)

**Причина**: CSP может блокировать загрузку ресурсов, даже если они прошли проверку SRI.

**Решение**: 
1. Настроить CSP так, чтобы она не конфликтовала с SRI
2. Использовать CSP и SRI совместно, учитывая их взаимодействие

## Лучшие практики

### 1. Используйте надежные алгоритмы хэширования

Предпочтительно использовать SHA-384 или SHA-512, избегая более слабых алгоритмов.

### 2. Регулярно обновляйте хэши

При обновлении внешних библиотек обязательно перегенерируйте хэши SRI.

### 3. Автоматизируйте процесс

Используйте инструменты сборки для автоматической генерации и обновления хэшей SRI.

### 4. Проверяйте совместимость с браузерами

Убедитесь, что ваша реализация SRI работает во всех поддерживаемых браузерах.

### 5. Используйте SRI вместе с CSP

Комбинируйте SRI с Content Security Policy для усиления безопасности.

### 6. Документируйте использование SRI

Хорошо документируйте, какие ресурсы защищены SRI и как обновлять хэши.

## Примеры с CDN

### Пример с CDNJS

```html
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
        integrity="sha384-..."
        crossorigin="anonymous">
</script>
```

### Пример с jsDelivr

```html
<script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"
        integrity="sha384-..."
        crossorigin="anonymous">
</script>
```

### Пример с unpkg

```html
<link rel="stylesheet" href="https://unpkg.com/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      integrity="sha384-..."
      crossorigin="anonymous">
```

## SRI и CSP

Subresource Integrity и Content Security Policy (CSP) работают вместе для усиления безопасности веб-приложений. CSP позволяет контролировать, какие ресурсы могут быть загружены, а SRI проверяет целостность этих ресурсов.

### Взаимодействие SRI и CSP

- CSP может ограничивать источники, с которых можно загружать ресурсы
- SRI проверяет целостность ресурсов, даже если они разрешены CSP
- Вместе они обеспечивают многоуровневую защиту

### Пример CSP с SRI

```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; script-src 'self' https://cdn.example.com;">
```

```html
<script src="https://cdn.example.com/lib.js"
        integrity="sha384-..."
        crossorigin="anonymous">
</script>
```

## Тестирование SRI

### Ручное тестирование

1. Проверить, что ресурсы с правильными хэшами загружаются корректно
2. Проверить, что ресурсы с неправильными хэшами блокируются
3. Проверить работу в разных браузерах

### Автоматизированное тестирование

Можно использовать инструменты автоматизации тестирования для проверки SRI:

```javascript
// Пример с Puppeteer
const puppeteer = require('puppeteer');

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  
  // Включить логирование ошибок
  page.on('console', msg => console.log(msg.text()));
  
  await page.goto('your-page-with-sri.html');
  
  // Проверить, нет ли ошибок SRI в консоли
  await browser.close();
})();
```

### Тестирование с измененными хэшами

Для проверки корректности работы SRI можно временно изменить хэш в атрибуте `integrity` и убедиться, что ресурс не загружается.

## Ссылки на другие связанные файлы

- [[Content-Security-Policy]] - Политика безопасности контента, которая работает вместе с SRI
- [[HTTP-Security-Headers]] - Заголовки безопасности, которые усиливают защиту
- [[XSS-защита]] - Защита от межсайтового скриптинга
- [[CSRF-защита]] - Защита от подделки межсайтовых запросов
- [[Secure-Coding-Practices]] - Практики безопасного программирования
- [[Dependency-Security]] - Безопасность зависимостей
- [[Feature-Policy]] - Политика функций для ограничения возможностей браузера
- [[Secure-Storage]] - Безопасное хранение данных в браузере
- [[Тестирование-безопасности]] - Методы тестирования безопасности веб-приложений
- [[Безопасность-в-браузере]] - Общие аспекты безопасности в браузере
- [[Безопасность-в-веб-приложениях-с-AI-ML]] - Особенности безопасности в приложениях с ИИ и МЛ
- [[Безопасность-в-SPA]] - Безопасность в одностраничных приложениях
- [[Безопасность-PWA]] - Безопасность прогрессивных веб-приложений
- [[Безопасность-в-системах-с-несколькими-доменами]] - Особенности безопасности в мультидоменных системах
- [[Безопасность-в-системах-с-поддержкой-плагинов]] - Безопасность в системах с плагинами
- [[Безопасность-в-микросервисной-архитектуре]] - Безопасность в микросервисной архитектуре
- [[Безопасность-в-облачных-средах]] - Безопасность в облачных средах
- [[Безопасность-в-системах-сборки]] - Безопасность в системах сборки
- [[Secure-Storage]] - Безопасное хранение данных
- [[Безопасность-в-веб-компонентах]] - Безопасность веб-компонентов