---
aliases: ["Проверка целостности ресурсов", "Контроль целостности SRI", "Валидация хешей ресурсов"]
tags: [security, sri, integrity-check, web-security, validation]
created: 2025-11-18
updated: 2025-11-18
---

# Проверка целостности

## Обзор

Проверка целостности - это процесс, при котором браузер сравнивает криптографический хеш загруженного ресурса с ожидаемым значением, указанным в атрибуте `integrity`. Этот процесс обеспечивает, что загруженный ресурс не был изменен между моментом его создания и загрузкой пользователем.

## Механизм проверки целостности

### Как работает проверка

1. **Вычисление ожидаемого хеша**: Браузер извлекает ожидаемый хеш из атрибута `integrity`
2. **Загрузка ресурса**: Ресурс загружается с указанного URL
3. **Вычисление хеша загруженного ресурса**: Браузер вычисляет хеш для загруженного содержимого
4. **Сравнение хешей**: Сравнение вычисленного хеша с ожидаемым
5. **Решение о загрузке**: Если хеши совпадают, ресурс исполняется; если нет - загрузка блокируется

### Алгоритмы проверки

Поддерживаются следующие алгоритмы хеширования:

- **SHA-256**: 256-битный хеш, представленный в Base64
- **SHA-384**: 384-битный хеш, рекомендуется для более высокой безопасности
- **SHA-512**: 512-битный хеш, максимальная степень защиты

## Процесс проверки в браузере

### Этапы проверки

#### 1. Разбор атрибута integrity

Браузер анализирует значение атрибута integrity, которое имеет формат:
```
<algorithm>-<base64-hash-value>
```

Например:
```
sha384-ZPjR8Q68u8WL2qYJL7w9z5iFi0M8W5q55Z7h5j4Q5y2Q3m7z8K9L2n6v4w3x7y2z1
```

#### 2. Загрузка ресурса

Ресурс загружается обычным образом, но с учетом атрибута `crossorigin`, если ресурс загружается с другого домена.

#### 3. Вычисление хеша

Браузер применяет тот же алгоритм хеширования к загруженному содержимому ресурса.

#### 4. Сравнение значений

Браузер сравнивает вычисленный хеш с ожидаемым значением из атрибута `integrity`.

#### 5. Принятие решения

- Если хеши совпадают: ресурс загружается и исполняется
- Если хеши не совпадают: загрузка блокируется, и в консоль выводится ошибка

### Пример ошибки проверки целостности

```
Failed to find a valid digest in the 'integrity' attribute for resource 
'https://cdn.example.com/library.js' with computed SHA-384 integrity 
'actual-hash-value', but the developer specified 
'expected-hash-value'.
```

## Влияние на производительность

### Плюсы

- **Однократная проверка**: Хеш вычисляется один раз при загрузке ресурса
- **Кэширование**: Проверенные ресурсы могут быть закэшированы с результатом проверки
- **Раннее прерывание**: Неверные ресурсы отбрасываются до выполнения

### Минусы

- **Дополнительные вычисления**: Требуется вычисление хеша для каждого ресурса
- **Возможное увеличение времени загрузки**: Небольшое увеличение времени на проверку
- **Потребление памяти**: Хранение ожидаемых хешей

## Практические аспекты проверки

### Поддержка браузерами

Современные браузеры, как правило, поддерживают SRI:

- Chrome: с версии 45
- Firefox: с версии 43
- Safari: с версии 10.1
- Edge: с версии 17

### Проверка поддержки

```javascript
// Проверка поддержки SRI
function supportsSRI() {
  const testEl = document.createElement('script');
  return 'integrity' in testEl;
}

if (supportsSRI()) {
  console.log('SRI поддерживается');
} else {
  console.log('SRI не поддерживается, требуется резервный вариант');
}
```

### Обработка ошибок проверки

```javascript
// Обработка ошибки загрузки ресурса с SRI
document.addEventListener('error', function(e) {
  if (e.target.src && e.target.integrity) {
    console.warn('Ошибка проверки целостности для:', e.target.src);
    // Загрузка резервного ресурса
    loadFallbackScript(e.target.src);
  }
}, true);

function loadFallbackScript(originalSrc) {
  // Загрузка резервного скрипта с локального сервера
  const fallbackScript = document.createElement('script');
  fallbackScript.src = originalSrc.replace('cdn.example.com', 'fallback.example.com');
  document.head.appendChild(fallbackScript);
}
```

## Ручная проверка целостности

### Проверка с помощью командной строки

```bash
# Загрузка файла и проверка его хеша
curl -s https://cdn.example.com/library.js > library.js
ACTUAL_HASH=$(openssl dgst -sha384 -binary library.js | openssl base64 -A)
echo "Actual hash: $ACTUAL_HASH"
```

Сравните с ожидаемым значением из атрибута integrity.

### Проверка в JavaScript

```javascript
// Функция для проверки целостности ресурса
async function verifyResourceIntegrity(url, expectedIntegrity) {
  try {
    const response = await fetch(url);
    const content = await response.text();
    
    const [algorithm, expectedHash] = expectedIntegrity.split('-');
    const encoder = new TextEncoder();
    const data = encoder.encode(content);
    
    const hashBuffer = await crypto.subtle.digest(algorithm, data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    const actualHash = btoa(String.fromCharCode.apply(null, hashArray));
    
    return actualHash === expectedHash;
  } catch (error) {
    console.error('Ошибка проверки целостности:', error);
    return false;
  }
}

// Использование
verifyResourceIntegrity('https://cdn.example.com/library.js', 'sha384-expected-hash')
  .then(isValid => {
    console.log('Целостность проверена:', isValid);
  });
```

## Распространенные ошибки проверки

### Несовпадение хешей

**Причины:**
- Изменение содержимого файла на CDN
- Неправильная генерация хеша
- Использование разных алгоритмов
- Проблемы с кодировкой

**Решения:**
- Перегенерировать хеш для актуального файла
- Проверить алгоритм хеширования
- Убедиться в правильной кодировке

### Проблемы с CORS

```html
<!-- Правильно -->
<script src="https://cdn.example.com/library.js" 
        integrity="sha384-..." 
        crossorigin="anonymous">
</script>

<!-- Неправильно - проверка не будет выполнена -->
<script src="https://cdn.example.com/library.js" 
        integrity="sha384-...">
</script>
```

### Несколько значений хешей

Можно указать несколько хешей, разделенных пробелом:

```html
<script src="https://cdn.example.com/library.js"
        integrity="sha384-first-hash sha512-second-hash"
        crossorigin="anonymous">
</script>
```

Ресурс будет загружен, если хотя бы один из хешей совпадает.

## Инструменты для проверки целостности

### Автоматические инструменты

- **SRI Hash Generator**: Онлайн-инструмент для генерации хешей
- **Webpack Subresource Integrity**: Плагин для автоматической генерации
- **gulp-sri**: Плагин для Gulp
- **rollup-plugin-sri**: Плагин для Rollup

### Проверка в DevTools

1. Откройте вкладку Network
2. Найдите ресурс с атрибутом integrity
3. Проверьте заголовки и статус
4. Вкладка Console покажет ошибки проверки целостности

## Лучшие практики проверки

### Для разработчиков

1. **Автоматизация**: Интегрируйте генерацию хешей в процесс сборки
2. **Резервные копии**: Обеспечьте резервные варианты на случай сбоя проверки
3. **Мониторинг**: Отслеживайте ошибки проверки целостности в продакшене
4. **Тестирование**: Проверяйте SRI в разных браузерах и условиях

### Для систем безопасности

1. **Анализ логов**: Мониторинг попыток загрузки с нарушенной целостностью
2. **Алерты**: Настройка оповещений о сбоях проверки
3. **Анализ причин**: Изучение причин сбоев для предотвращения повторений

## Заключение

Проверка целостности через SRI - это важный механизм безопасности, который защищает пользователей от загрузки измененных или вредоносных ресурсов. Понимание процесса проверки целостности позволяет разработчикам эффективно использовать SRI и обеспечивать высокий уровень безопасности веб-приложений.

> [!note] Примечание
> Проверка целостности выполняется автоматически браузером, но разработчики должны понимать, как она работает, для правильной реализации.

> [!warning] Важно
> Неправильная реализация SRI может привести к отказу в обслуживании, если хеши не будут обновлены при изменении ресурсов.

Связанные темы: [[Реализация-SRI]], [[Безопасность-CDN]], [[Лучшие-практики-SRI]]