---
aliases: ["Проверка ввода", "Валидация данных", "Фильтрация входных данных"]
tags: ["#security", "#input-validation", "#web-security", "#secure-coding"]
---

# Проверка ввода

## Введение

Проверка ввода (input validation) - это критический элемент безопасности веб-приложений, заключающийся в проверке, фильтрации и санитизации всех данных, поступающих от пользователей или внешних источников. Правильная проверка ввода предотвращает множество уязвимостей, включая XSS, SQL-инъекции, командные инъекции и другие.

## Принципы проверки ввода

### 1. Принцип "не доверяй пользовательским данным"

Все данные, поступающие от пользователей, должны считаться потенциально вредоносными до тех пор, пока не будут проверены и санитизированы.

### 2. Принцип "белого списка"

Предпочтительно использовать белые списки (whitelist) - разрешать только известные безопасные значения, а не черные списки (blacklist) - запрещать известные опасные значения.

### 3. Принцип "проверки на стороне сервера"

Проверка ввода на клиенте не должна быть единственной защитой. Все проверки должны дублироваться на сервере.

## Типы проверки ввода

### 1. Проверка типа данных

Проверка, соответствует ли ввод ожидаемому типу данных.

```javascript
// Пример проверки числового значения
function validateUserId(input) {
    const userId = parseInt(input);
    if (isNaN(userId) || userId <= 0) {
        throw new Error('Invalid user ID');
    }
    return userId;
}

// Проверка email
function validateEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}
```

### 2. Проверка диапазона и длины

Ограничение допустимого размера и диапазона входных данных.

```javascript
function validateStringLength(input, min, max) {
    if (input.length < min || input.length > max) {
        throw new Error(`Длина должна быть от ${min} до ${max} символов`);
    }
    return true;
}

function validateNumberRange(value, min, max) {
    if (value < min || value > max) {
        throw new Error(`Значение должно быть в диапазоне от ${min} до ${max}`);
    }
    return true;
}
```

### 3. Проверка формата

Использование регулярных выражений или специализированных библиотек для проверки формата данных.

```javascript
// Проверка номера телефона
function validatePhone(phone) {
    const phoneRegex = /^\+?[\d\s\-\(\)]{10,}$/;
    return phoneRegex.test(phone);
}

// Проверка URL
function validateUrl(url) {
    try {
        new URL(url);
        return true;
    } catch {
        return false;
    }
}
```

### 4. Проверка содержимого

Анализ содержимого на наличие потенциально опасных паттернов.

```javascript
function detectXSS(input) {
    const xssPatterns = [
        /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
        /javascript:/gi,
        /on\w+\s*=/gi,
        /<iframe/gi,
        /<object/gi,
        /<embed/gi
    ];
    
    return xssPatterns.some(pattern => pattern.test(input));
}
```

## Методы проверки ввода

### 1. Строгая проверка (Strict Validation)

Разрешение только заранее определенных безопасных значений.

```javascript
const allowedActions = ['create', 'read', 'update', 'delete'];

function validateAction(action) {
    if (!allowedActions.includes(action)) {
        throw new Error('Недопустимое действие');
    }
    return action;
}
```

### 2. Слабая проверка (Loose Validation)

Более гибкий подход с фильтрацией опасных паттернов.

```javascript
function sanitizeInput(input) {
    // Удаление потенциально опасных тегов
    return input.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
}
```

### 3. Контекстно-зависимая проверка

Проверка, учитывающая контекст использования данных.

```javascript
// Проверка HTML для безопасного отображения
function sanitizeHtml(html) {
    const allowedTags = ['p', 'br', 'strong', 'em', 'ul', 'ol', 'li'];
    // Использование библиотеки для санитизации HTML
    return DOMPurify.sanitize(html, {
        ALLOWED_TAGS: allowedTags,
        FORBID_ATTR: ['style', 'on*']
    });
}
```

## Проверка ввода на стороне клиента

### HTML5 валидация

```html
<form>
    <input type="email" required placeholder="Email">
    <input type="number" min="1" max="100" required placeholder="Возраст">
    <input type="url" placeholder="Веб-сайт">
    <input type="text" pattern="[A-Za-z]{3,10}" title="Только буквы, 3-10 символов">
    <button type="submit">Отправить</button>
</form>
```

### JavaScript валидация

```javascript
function validateForm(formData) {
    const errors = [];
    
    // Проверка email
    if (!validateEmail(formData.email)) {
        errors.push('Некорректный email');
    }
    
    // Проверка длины имени
    if (formData.name.length < 2 || formData.name.length > 50) {
        errors.push('Имя должно быть от 2 до 50 символов');
    }
    
    // Проверка пароля
    if (!isValidPassword(formData.password)) {
        errors.push('Пароль не соответствует требованиям');
    }
    
    return errors;
}

function isValidPassword(password) {
    // Минимум 8 символов, содержит заглавную, строчную и цифру
    const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,}$/;
    return passwordRegex.test(password);
}
```

## Проверка ввода на стороне сервера

### Пример с Express.js

```javascript
const express = require('express');
const { body, validationResult } = require('express-validator');

const app = express();

// Валидация данных регистрации
app.post('/register', [
    body('email').isEmail().normalizeEmail(),
    body('password').isLength({ min: 8 }).matches(/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/),
    body('username').isAlphanumeric().isLength({ min: 3, max: 20 })
], (req, res) => {
    const errors = validationResult(req);
    if (!errors.isEmpty()) {
        return res.status(400).json({ errors: errors.array() });
    }
    
    // Обработка валидных данных
    const { email, password, username } = req.body;
    // ...
});
```

### Проверка файлов

```javascript
const multer = require('multer');
const path = require('path');

// Конфигурация загрузки файлов
const fileFilter = (req, file, cb) => {
    // Разрешаем только определенные типы файлов
    const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
    if (allowedTypes.includes(file.mimetype)) {
        cb(null, true);
    } else {
        cb(new Error('Недопустимый тип файла'), false);
    }
};

const limits = {
    fileSize: 5 * 1024 * 1024 // 5MB
};

const upload = multer({ 
    dest: 'uploads/',
    fileFilter,
    limits
});
```

## Проверка сложных данных

### JSON-данные

```javascript
function validateJsonData(data, schema) {
    // Проверка структуры JSON
    if (typeof data !== 'object' || data === null) {
        throw new Error('Некорректный JSON');
    }
    
    // Проверка по схеме
    for (const [key, value] of Object.entries(schema)) {
        if (data[key] === undefined) {
            if (value.required) {
                throw new Error(`Поле ${key} обязательно`);
            }
        } else {
            // Проверка типа
            if (typeof data[key] !== value.type) {
                throw new Error(`Поле ${key} должно быть типа ${value.type}`);
            }
            
            // Проверка дополнительных условий
            if (value.validator && !value.validator(data[key])) {
                throw new Error(`Поле ${key} не прошло валидацию`);
            }
        }
    }
    
    return true;
}
```

### Массивы данных

```javascript
function validateArray(arr, validator) {
    if (!Array.isArray(arr)) {
        throw new Error('Ожидается массив');
    }
    
    return arr.every((item, index) => {
        try {
            return validator(item, index);
        } catch (error) {
            throw new Error(`Ошибка валидации элемента ${index}: ${error.message}`);
        }
    });
}
```

## Лучшие практики

### 1. Ранняя проверка

Проверяйте ввод как можно раньше в процессе обработки запроса.

### 2. Проверка всех входных данных

Проверяйте не только пользовательский ввод, но и данные из API, файлов, базы данных и других источников.

### 3. Использование специализированных библиотек

```javascript
// Пример использования библиотеки validator.js
const validator = require('validator');

function validateUserData(userData) {
    const errors = [];
    
    if (!validator.isEmail(userData.email)) {
        errors.push('Некорректный email');
    }
    
    if (!validator.isLength(userData.username, { min: 3, max: 20 })) {
        errors.push('Некорректная длина имени пользователя');
    }
    
    if (!validator.isStrongPassword(userData.password)) {
        errors.push('Слабый пароль');
    }
    
    return errors;
}
```

### 4. Логирование и мониторинг

```javascript
function logValidationFailures(req, errors) {
    console.log({
        timestamp: new Date().toISOString(),
        ip: req.ip,
        userAgent: req.get('User-Agent'),
        errors: errors,
        url: req.originalUrl,
        method: req.method
    });
}
```

### 5. Обработка ошибок

```javascript
app.use((error, req, res, next) => {
    if (error.validationErrors) {
        return res.status(400).json({
            error: 'Validation failed',
            details: error.validationErrors
        });
    }
    next(error);
});
```

## Распространенные ошибки

### 1. Неполная проверка

```javascript
// Плохо - проверка только типа
function badValidation(input) {
    if (typeof input === 'string') {
        return true; // Не проверяет содержимое!
    }
    return false;
}
```

### 2. Неправильная обработка исключений

```javascript
// Плохо - не обрабатывает все возможные ошибки
function unsafeValidation(input) {
    return JSON.parse(input); // Может вызвать исключение
}
```

### 3. Отсутствие проверки на стороне сервера

```javascript
// Плохо - только клиентская проверка
app.post('/data', (req, res) => {
    // Нет проверки ввода!
    processUserData(req.body);
    res.send('OK');
});
```

## Инструменты и библиотеки

### Серверные библиотеки
- express-validator
- Joi
- Yup
- validator.js

### Клиентские библиотеки
- Yup (для валидации форм)
- Joi-browser
- Validator.js

## Связанные темы

- [[Типы-XSS]]
- [[Кодирование-вывода]]
- [[Методы-санитизации]]
- [[Secure-Coding-Practices]]
- [[Тестирование-безопасности]]