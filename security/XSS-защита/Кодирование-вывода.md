---
aliases: ["Output Encoding", "Кодирование вывода", "Экранирование данных"]
tags: [security, output-encoding, xss, web-security]
---

# Кодирование вывода

## Обзор

Кодирование вывода (output encoding) - это процесс преобразования специальных символов в безопасные эквиваленты перед отображением данных в веб-приложении. Это важная мера безопасности, которая предотвращает межсайтовый скриптинг (XSS) и другие атаки, связанные с внедрением вредоносного кода в веб-страницы.

## Почему необходимо кодирование вывода

### Угроза XSS

Когда пользовательский ввод отображается в веб-странице без надлежащего кодирования, злоумышленник может внедрить вредоносный JavaScript-код, который будет выполнен в браузере других пользователей.

```html
<!-- НЕБЕЗОПАСНО - уязвимо для XSS -->
<div>Привет, <?php echo $_GET['name']; ?>!</div>

<!-- БЕЗОПАСНО - с кодированием вывода -->
<div>Привет, <?php echo htmlspecialchars($_GET['name']); ?>!</div>
```

Если пользователь передаст в параметре `name` значение `<script>alert('XSS')</script>`, в первом случае будет выполнено вредоносное скрипт, а во втором - безопасно отображено как текст.

### Контексты кодирования

Различные контексты требуют разных методов кодирования:

1. **HTML-контент** - для отображения в теле HTML
2. **HTML-атрибуты** - для значений атрибутов
3. **JavaScript** - для вставки в JavaScript-код
4. **CSS** - для стилей
5. **URL** - для параметров URL

## Методы кодирования вывода

### HTML-кодирование

Преобразует специальные HTML-символы в безопасные HTML-сущности:

```javascript
// Функция для HTML-кодирования
function htmlEncode(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
    '/': '&#x2F;',
    '`': '&#x60;',
    '=': '&#x3D;'
  };
  
  return text.replace(/[&<>"'`=\/]/g, m => map[m]);
}

// Пример использования
const userInput = '<script>alert("XSS")</script>';
const safeOutput = htmlEncode(userInput);
console.log(safeOutput); // &lt;script&gt;alert(&quot;XSS&quot;)&lt;&#x2F;script&gt;
```

### JavaScript-кодирование

Используется при вставке данных в JavaScript-код:

```javascript
function jsEncode(text) {
  // Кодируем специальные символы для JavaScript
  return text
    .replace(/\\/g, '\\\\')  // экранируем обратный слеш
    .replace(/'/g, "\\'")    // экранируем одинарные кавычки
    .replace(/"/g, '\\"')    // экранируем двойные кавычки
    .replace(/\n/g, '\\n')   // экранируем символ новой строки
    .replace(/\r/g, '\\r')   // экранируем символ возврата каретки
    .replace(/\t/g, '\\t')   // экранируем табуляцию
    .replace(/</g, '\\u003C') // экранируем < для предотвращения </script>
    .replace(/>/g, '\\u003E'); // экранируем > для предотвращения </script>
}

// Пример использования
const userInput = '"; alert("XSS"); "';
const safeJsOutput = jsEncode(userInput);
console.log(safeJsOutput); // \\"; alert(\\"XSS\\"); \\"
```

### URL-кодирование

Используется для безопасной передачи данных в URL:

```javascript
// Встроенные функции JavaScript для URL-кодирования
const userInput = 'hello world & special chars';
const encodedUrl = encodeURIComponent(userInput);
console.log(encodedUrl); // hello%20world%20%26%20special%20chars

// Для полного URL
const baseUrl = 'https://example.com/search';
const query = 'search term with spaces';
const fullUrl = `${baseUrl}?q=${encodeURIComponent(query)}`;
console.log(fullUrl); // https://example.com/search?q=search%20term%20with%20spaces
```

### CSS-кодирование

Используется при вставке данных в CSS:

```javascript
function cssEncode(text) {
  // Кодируем текст для использования в CSS
  return text.replace(/[^a-zA-Z0-9]/g, function(match) {
    return '\\' + match.charCodeAt(0).toString(16);
  });
}

// Пример использования
const userInput = 'red; background: url(javascript:alert("XSS"))';
const safeCssOutput = cssEncode(userInput);
console.log(safeCssOutput); // \72\65\64\3b\20\62\61\63\6b\67\72\6f\75\6e\64\3a\20\75\72\6c\28\6a\61\76\61\73\63\72\69\70\74\3a\61\6c\65\72\74\28\22\58\53\53\22\29\29
```

## Контекстно-зависимое кодирование

### HTML-контент

```html
<!-- Правильное кодирование в HTML-контенте -->
<div>Имя пользователя: <?= htmlspecialchars($username, ENT_QUOTES, 'UTF-8') ?></div>

<!-- НЕПРАВИЛЬНОЕ использование -->
<div>Имя пользователя: <?= $username ?></div>
```

### HTML-атрибуты

```html
<!-- Правильное кодирование в атрибутах -->
<button onclick="alert('<?= htmlspecialchars($message, ENT_QUOTES, 'UTF-8') ?>')">Нажми меня</button>

<!-- Или использование data-атрибутов -->
<div data-message="<?= htmlspecialchars($data, ENT_QUOTES, 'UTF-8') ?>">...</div>
```

### JavaScript-контекст

```html
<script>
  // Правильное кодирование для JavaScript
  var message = "<?= addslashes($message) ?>";
  
  // Или безопасное внедрение JSON
  var data = <?= json_encode($data, JSON_HEX_TAG | JSON_HEX_AMP) ?>;
</script>
```

## Практические примеры

### Класс безопасного вывода

```javascript
class SafeOutput {
  static html(text) {
    if (typeof text !== 'string') {
      text = String(text);
    }
    
    const map = {
      '&': '&amp;',
      '<': '&lt;',
      '>': '&gt;',
      '"': '&quot;',
      "'": '&#039;',
      '/': '&#x2F;',
      '`': '&#x60;',
      '=': '&#x3D;'
    };
    
    return text.replace(/[&<>"'`=\/]/g, m => map[m]);
  }
  
  static js(text) {
    if (typeof text !== 'string') {
      text = String(text);
    }
    
    return text
      .replace(/\\/g, '\\\\')
      .replace(/'/g, "\\'")
      .replace(/"/g, '\\"')
      .replace(/\n/g, '\\n')
      .replace(/\r/g, '\\r')
      .replace(/\t/g, '\\t')
      .replace(/[\b]/g, '\\b')
      .replace(/\f/g, '\\f')
      .replace(/</g, '\\u003C')
      .replace(/>/g, '\\u003E');
  }
  
  static css(text) {
    if (typeof text !== 'string') {
      text = String(text);
    }
    
    return text.replace(/[^a-zA-Z0-9]/g, (match) => {
      return '\\' + match.charCodeAt(0).toString(16) + ' ';
    });
  }
  
  static url(text) {
    if (typeof text !== 'string') {
      text = String(text);
    }
    
    return encodeURIComponent(text);
  }
  
  static attribute(text) {
    // Специальное кодирование для HTML-атрибутов
    return this.html(text);
  }
  
  static json(value) {
    // Безопасное преобразование в JSON для вставки в JavaScript
    const jsonString = JSON.stringify(value);
    // Дополнительно экранируем потенциально опасные последовательности
    return jsonString
      .replace(/</g, '\\u003C')
      .replace(/>/g, '\\u003E')
      .replace(/&/g, '\\u0026');
  }
}

// Пример использования
const userInput = {
  name: '<script>alert("XSS")</script>',
  bio: 'I\'m a developer',
  website: 'https://example.com?param=<script>'
};

// Безопасный вывод в HTML
document.getElementById('name').innerHTML = SafeOutput.html(userInput.name);

// Безопасный вывод в JavaScript
const jsSafeData = SafeOutput.json(userInput);

// Безопасный вывод в URL
const safeUrl = `/search?q=${SafeOutput.url(userInput.name)}`;
```

### Функции для разных фреймворков

#### Express.js с EJS

```javascript
// В EJS шаблоне
<%- escapeHtml(userInput) %>

// В контроллере
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  
  return text.replace(/[&<>"']/g, m => map[m]);
}

// Или использование встроенного механизма EJS
app.locals.escapeHtml = (text) => {
  return text ? text.toString()
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;') : '';
};
```

#### React (автоматическое кодирование)

```jsx
// React автоматически кодирует вывод
function UserProfile({ user }) {
  // React автоматически кодирует значения в JSX
  return (
    <div>
      <h1>{user.name}</h1> {/* Безопасно, React кодирует автоматически */}
      <p>{user.bio}</p>     {/* Безопасно, React кодирует автоматически */}
    </div>
  );
}

// При использовании dangerouslySetInnerHTML нужно быть осторожным
function UnsafeComponent({ htmlContent }) {
  return (
    <div dangerouslySetInnerHTML={{
      __html: DOMPurify.sanitize(htmlContent) // Используем библиотеку для очистки
    }} />
  );
}
```

## Использование библиотек безопасности

### DOMPurify для очистки HTML

```javascript
// Установка: npm install dompurify
const DOMPurify = require('dompurify');

// Использование
const userInput = '<p>Safe text</p><script>alert("XSS")</script>';
const cleanOutput = DOMPurify.sanitize(userInput);
console.log(cleanOutput); // <p>Safe text</p> - скрипт удален
```

### Lodash для безопасного кодирования

```javascript
const _ = require('lodash');

// Использование _.escape для HTML-кодирования
const userInput = '<script>alert("XSS")</script>';
const safeOutput = _.escape(userInput);
console.log(safeOutput); // &lt;script&gt;alert(&quot;XSS&quot;)&lt;&#x2F;script&gt;
```

## Кодирование в различных языках

### PHP

```php
<?php
// HTML-кодирование
$safe_output = htmlspecialchars($user_input, ENT_QUOTES, 'UTF-8');

// URL-кодирование
$safe_url = urlencode($user_input);

// JavaScript-кодирование
$safe_js = json_encode($user_input, JSON_HEX_TAG | JSON_HEX_AMP | JSON_HEX_APOS | JSON_HEX_QUOT);
?>
```

### Java

```java
import org.apache.commons.text.StringEscapeUtils;

// HTML-кодирование
String safeHtml = StringEscapeUtils.escapeHtml4(userInput);

// JavaScript-кодирование
String safeJs = StringEscapeUtils.escapeEcmaScript(userInput);

// XML-кодирование
String safeXml = StringEscapeUtils.escapeXml11(userInput);

// URL-кодирование
String safeUrl = URLEncoder.encode(userInput, "UTF-8");
```

### Python

```python
import html
import urllib.parse
import json

# HTML-кодирование
safe_html = html.escape(user_input)

# URL-кодирование
safe_url = urllib.parse.quote(user_input)

# JSON-кодирование для JavaScript
safe_json = json.dumps(user_input).replace('<', '\\u003c').replace('>', '\\u003e')
```

## Лучшие практики

### 1. Используйте подход "defense in depth"

```javascript
// Комбинирование нескольких методов безопасности
function comprehensiveOutputEncoding(value, context) {
  // Сначала валидируем данные
  if (!isValidOutput(value)) {
    return '';
  }
  
  // Затем применяем соответствующее кодирование
  switch(context) {
    case 'html':
      return SafeOutput.html(value);
    case 'js':
      return SafeOutput.js(value);
    case 'css':
      return SafeOutput.css(value);
    case 'url':
      return SafeOutput.url(value);
    default:
      return SafeOutput.html(value); // безопасный вариант по умолчанию
  }
}

function isValidOutput(value) {
  // Проверка на допустимые типы и размер
  if (typeof value !== 'string' && typeof value !== 'number') {
    return false;
  }
  
  if (typeof value === 'string' && value.length > 10000) { // 10KB лимит
    return false;
  }
  
  return true;
}
```

### 2. Используйте Content Security Policy (CSP)

```javascript
// Установка CSP заголовков
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline'; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self'; " +
    "connect-src 'self'"
  );
  next();
});
```

### 3. Регулярное тестирование безопасности

```javascript
// Тестирование кодирования вывода
function testOutputEncoding() {
  const testCases = [
    { input: '<script>alert("XSS")</script>', expected: '&lt;script&gt;alert(&quot;XSS&quot;)&lt;&#x2F;script&gt;' },
    { input: 'Hello & "World"', expected: 'Hello &amp; &quot;World&quot;' },
    { input: 'user@example.com', expected: 'user@example.com' }
  ];
  
  for (const testCase of testCases) {
    const result = SafeOutput.html(testCase.input);
    console.assert(result === testCase.expected, 
      `Тест не пройден: ожидаем "${testCase.expected}", получили "${result}"`);
  }
  
  console.log('Все тесты кодирования вывода пройдены');
}

testOutputEncoding();
```

## Заключение

Кодирование вывода - критически важный элемент безопасности веб-приложений. Правильное применение методов кодирования в зависимости от контекста помогает предотвратить XSS-атаки и другие уязвимости. Всегда кодируйте пользовательские данные перед их отображением, используйте проверенные библиотеки безопасности и применяйте многоуровневый подход к защите.

## Связанные темы

- [[Проверка-ввода]]
- [[Руководство-по-безопасному-коду]]
- [[Безопасность-CORS]]
- [[Функции-безопасности-браузера]]
- [[Лучшие-практики-безопасности-API]]
- [[Тестирование-безопасности]]