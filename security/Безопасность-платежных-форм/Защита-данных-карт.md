---
aliases: ["Card Data Protection", "Payment Card Security"]
tags: [security, payment-security, card-data, data-protection]
---

# Защита-данных-карт

## Введение

Защита данных карт - это критически важный аспект безопасности веб-приложений, обрабатывающих платежные транзакции. Номера кредитных и дебетовых карт содержат чувствительную информацию, которая должна быть защищена от несанкционированного доступа, утечки и мошенничества.

## Типы данных карт

### Primary Account Number (PAN)
- Основной номер счета карты
- Обычно 16-19 цифр
- Должен быть защищен в соответствии с требованиями PCI DSS

### Данные магнитной полосы
- Данные с магнитной полосы карты
- Включают номер карты, срок действия, имя держателя
- Запрещено хранить после авторизации транзакции

### Коды проверки
- CVV (Card Verification Value)
- CVC (Card Validation Code)
- CID (Card Identification Number)
- Эти коды не должны храниться после обработки транзакции

## Методы защиты данных карт

### Шифрование данных
- Использование сильных криптографических алгоритмов (AES-256)
- Шифрование PAN при хранении и передаче
- Безопасное управление ключами шифрования

```javascript
// Пример шифрования данных карты с использованием Web Crypto API
async function encryptCardData(cardData, key) {
    const encoder = new TextEncoder();
    const data = encoder.encode(JSON.stringify(cardData));
    
    const encrypted = await window.crypto.subtle.encrypt(
        {
            name: "AES-GCM",
            iv: window.crypto.getRandomValues(new Uint8Array(12)),
            tagLength: 128,
        },
        key,
        data
    );
    
    return {
        encryptedData: Array.from(new Uint8Array(encrypted)),
        iv: Array.from(new Uint8Array(12))
    };
}
```

### Токенизация
- Замена чувствительных данных уникальными идентификаторами (токенами)
- Токены не имеют криптографического значения
- Позволяет избежать хранения чувствительных данных

```javascript
// Пример токенизации номера карты
class CardTokenization {
    constructor() {
        this.tokenMap = new Map();
    }
    
    tokenize(cardNumber) {
        const token = this.generateSecureToken();
        this.tokenMap.set(token, this.encryptCardNumber(cardNumber));
        return token;
    }
    
    detokenize(token) {
        return this.tokenMap.get(token);
    }
    
    generateSecureToken() {
        // Генерация уникального токена
        return 'tok_' + Math.random().toString(36).substr(2, 9);
    }
    
    encryptCardNumber(cardNumber) {
        // Реализация шифрования номера карты
        // В реальном приложении используйте криптографически стойкие методы
        return btoa(cardNumber);
    }
}
```

### Маскировка данных
- Показывать только часть номера карты (например, ****-****-****-1234)
- Использовать маскировку при отображении и в логах
- Ограничить доступ к полным номерам карт

## Безопасность на фронтенде

### Валидация ввода
- Проверка формата номера карты
- Проверка по алгоритму Луна
- Проверка срока действия карты

```javascript
// Пример валидации данных карты
class CardValidator {
    static validateCardNumber(cardNumber) {
        // Удалить все нецифровые символы
        const cleanNumber = cardNumber.replace(/\D/g, '');
        
        // Проверить длину (обычно 13-19 цифр)
        if (cleanNumber.length < 13 || cleanNumber.length > 19) {
            return false;
        }
        
        // Проверить по алгоритму Луна
        return this.luhnCheck(cleanNumber);
    }
    
    static luhnCheck(cardNumber) {
        let sum = 0;
        let isEven = false;
        
        for (let i = cardNumber.length - 1; i >= 0; i--) {
            let digit = parseInt(cardNumber.charAt(i));
            
            if (isEven) {
                digit *= 2;
                if (digit > 9) {
                    digit -= 9;
                }
            }
            
            sum += digit;
            isEven = !isEven;
        }
        
        return (sum % 10) === 0;
    }
    
    static validateExpiryDate(month, year) {
        const currentDate = new Date();
        const currentMonth = currentDate.getMonth() + 1; // Месяцы начинаются с 0
        const currentYear = currentDate.getFullYear();
        
        // Преобразовать двухзначный год в четырехзначный, если нужно
        const fullYear = year.length === 2 ? 2000 + parseInt(year) : parseInt(year);
        
        if (fullYear > currentYear) {
            return true;
        } else if (fullYear === currentYear) {
            return parseInt(month) >= currentMonth;
        }
        
        return false;
    }
    
    static validateCVV(cvv, cardType) {
        const cvvLength = {
            visa: 3,
            mastercard: 3,
            amex: 4,
            discover: 3
        };
        
        const expectedLength = cvvLength[cardType.toLowerCase()];
        return cvv.length === expectedLength && /^\d+$/.test(cvv);
    }
}
```

### Защита от XSS
- Санитизация вывода данных карты
- Использование Content Security Policy
- Избегать вставки данных карты в DOM без защиты

```javascript
// Пример безопасного отображения частично скрытого номера карты
function maskCardNumber(cardNumber) {
    const cleanNumber = cardNumber.replace(/\D/g, '');
    if (cleanNumber.length < 8) {
        return 'Некорректный номер карты';
    }
    
    const first4 = cleanNumber.substring(0, 4);
    const last4 = cleanNumber.substring(cleanNumber.length - 4);
    const masked = '*'.repeat(cleanNumber.length - 8);
    
    return `${first4}${masked}${last4}`;
}

// Использование безопасного отображения
const maskedNumber = maskCardNumber('4111111111111111');
console.log(maskedNumber); // 4111********1111
```

### Защита от утечки через формы
- Не сохранять данные карт в автозаполнении браузера
- Использовать атрибуты `autocomplete="off"`
- Очистка полей после отправки формы

```html
<form id="payment-form">
    <input type="text" 
           name="card-number" 
           autocomplete="off" 
           placeholder="Номер карты"
           onpaste="return false"
           oncopy="return false">
    <input type="text" 
           name="expiry-date" 
           autocomplete="off" 
           placeholder="MM/YY">
    <input type="text" 
           name="cvv" 
           autocomplete="off" 
           placeholder="CVV"
           onpaste="return false"
           oncopy="return false">
</form>
```

## Безопасность передачи данных

### HTTPS и TLS
- Использование HTTPS для всех страниц с вводом данных карты
- Поддержка современных версий TLS (1.2 и выше)
- Проверка сертификатов сервера

### Защита от CSRF
- Использование CSRF токенов
- Проверка заголовков Origin и Referer
- Использование SameSite атрибутов для куки

```javascript
// Пример защиты от CSRF при отправке платежных данных
async function submitPayment(paymentData) {
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    
    const response = await fetch('/api/process-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(paymentData)
    });
    
    return response.json();
}
```

## Хранение данных карты

### Запрещенные практики
- Не хранить полные номера карт в открытом виде
- Не хранить коды CVV/CVC после обработки транзакции
- Не хранить данные магнитной полосы

### Рекомендуемые практики
- Использование внешних платежных провайдеров
- Токенизация данных
- Шифрование при хранении (если необходимо)

## Безопасность в браузере

### Content Security Policy
- Ограничение загрузки скриптов с внешних источников
- Запрет inline-скриптов
- Защита от XSS атак

```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline' https://payment-provider.com; 
               style-src 'self' 'unsafe-inline'; 
               img-src 'self' data: https:; 
               frame-src https://payment-provider.com;">
```

### Subresource Integrity
- Проверка целостности загружаемых скриптов
- Использование SRI для внешних библиотек

```html
<script src="https://payment-provider.com/sdk.js" 
        integrity="sha384-..." 
        crossorigin="anonymous"></script>
```

## Мониторинг и аудит

### Логирование
- Логирование попыток доступа к данным карт
- Мониторинг необычной активности
- Аудит изменений в системах обработки платежей

### Обнаружение утечек
- Регулярные проверки на наличие чувствительных данных
- Использование DLP (Data Loss Prevention) решений
- Автоматизированные сканирования кода

## Заключение

Защита данных карт требует комплексного подхода, включающего как технические меры, так и организационные. Важно следовать лучшим практикам безопасности, регулярно обновлять системы и следить за новыми угрозами.

> [!warning] Важно
> Нарушение требований по защите данных карт может привести к серьезным финансовым и репутационным последствиям, а также к юридической ответственности.

> [!tip] Совет
> Используйте проверенные платежные провайдеры и сторонние решения для обработки данных карт, чтобы минимизировать область вашей ответственности за безопасность.

Связанные темы: [[Соответствие-PCI-DSS]], [[Безопасность-обработки-платежей]], [[Безопасность-в-веб-приложениях-с-P2P-коммуникациями]]