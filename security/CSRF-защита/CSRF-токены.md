---
aliases: [CSRF токены, Защита CSRF токенами, Anti-CSRF токены]
tags: [security, csrf, authentication, web-security]
---

# CSRF-токены

## Обзор

CSRF-токены (Cross-Site Request Forgery tokens) - это уникальные, непредсказуемые значения, которые генерируются сервером и отправляются клиенту для защиты от атак подделки межсайтовых запросов. Токены обеспечивают проверку того, что запрос действительно исходит от доверенного источника.

## Принцип работы CSRF-токенов

### 1. Генерация токена
- Сервер генерирует криптографически стойкий случайный токен
- Токен связывается с сессией пользователя
- Токен должен быть непредсказуемым и уникальным

### 2. Внедрение токена
- Токен встраивается в формы как скрытое поле
- Токен может передаваться через HTTP-заголовки
- Токен может храниться в JavaScript-переменной

### 3. Проверка токена
- При получении запроса сервер проверяет наличие токена
- Сервер сравнивает токен из запроса с токеном в сессии
- Запрос отклоняется, если токены не совпадают

## Типы CSRF-токенов

### 1. Synchronizer Token Pattern
- Токен генерируется на сервере и хранится в сессии
- Токен вставляется в формы как hidden input
- При отправке формы токен проверяется на сервере

### 2. Double Submit Cookie Pattern
- Токен хранится в cookie и отправляется с запросом
- Токен также вставляется в форму или заголовок
- Сервер сравнивает токены из cookie и запроса

### 3. Encrypted Token Pattern
- Токен шифруется перед отправкой клиенту
- Сервер может расшифровать токен для проверки
- Обеспечивает дополнительный уровень безопасности

## Реализация CSRF-токенов

### Пример на Node.js с Express
```javascript
const csrf = require('csurf');
const csrfProtection = csrf({ cookie: true });

// Применение middleware
app.use(csrfProtection);

// Отправка токена в шаблон
app.get('/form', (req, res) => {
  res.render('sendData', { csrfToken: req.csrfToken() });
});

// Проверка токена при отправке формы
app.post('/process', parseForm, csrfProtection, (req, res) => {
  // Обработка данных
});
```

### Пример на PHP
```php
// Генерация токена
if (empty($_SESSION['csrf_token'])) {
    $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
}

// Проверка токена
if (!hash_equals($_SESSION['csrf_token'], $_POST['csrf_token'])) {
    die('CSRF token mismatch');
}
```

### Пример на Python (Flask)
```python
from flask_wtf.csrf import CSRFProtect

csrf = CSRFProtect(app)

@app.route('/submit', methods=['POST'])
def submit():
    # Защита автоматически включена через CSRFProtect
    # Обработка данных
```

## Лучшие практики использования CSRF-токенов

### 1. Безопасная генерация
- Используйте криптографически стойкие генераторы случайных чисел
- Обеспечьте достаточную длину токена (минимум 128 бит)
- Избегайте предсказуемых паттернов

### 2. Правильное хранение
- Храните токены в защищенных сессиях, а не в URL
- Используйте защищенные cookie при необходимости
- Ограничьте срок действия токенов

### 3. Проверка на сервере
- Проверяйте токены для всех изменяющих данных запросов (POST, PUT, DELETE)
- Используйте безопасные методы сравнения строк (time-constant)
- Обрабатывайте ошибки проверки токенов корректно

## Защита токенов от компрометации

### 1. Защита от XSS
- Токены могут быть скомпрометированы через XSS-атаки
- Используйте дополнительные меры безопасности (CSP, HttpOnly cookies)
- Регулярно обновляйте токены

### 2. Защита от логирования
- Не записывайте токены в логи
- Используйте фильтрацию в системах логирования
- Ограничьте доступ к логам

### 3. Правильное использование SameSite
- Используйте атрибут SameSite для cookie с токенами
- Выбирайте подходящее значение (Lax или Strict)

## Сравнение методов защиты

| Метод | Безопасность | Сложность | Совместимость |
|-------|-------------|------------|---------------|
| Synchronizer Token | Высокая | Средняя | Высокая |
| Double Submit Cookie | Средняя | Низкая | Высокая |
| Custom Headers | Высокая | Низкая | Ограниченная |
| SameSite Cookies | Высокая | Низкая | Зависит от браузера |

## Связанные темы

- [[Анти-CSRF-токены]]
- [[SameSite-куки]]
- [[Методы-защиты-от-CSRF]]
- [[Типы-CSRF-атак]]

> [!tip] Совет
> Используйте комбинацию методов защиты CSRF для максимальной безопасности, особенно в критически важных приложениях.

> [!warning] Важно
> CSRF-токены должны обновляться при входе/выходе пользователя и при изменении привилегий для предотвращения атак с использованием устаревших токенов.