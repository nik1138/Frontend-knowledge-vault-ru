---
aliases: ["SameSite-атрибут куки", "CSRF-защита через SameSite"]
tags: ["#security", "#web-security", "#csrf", "#cookies", "#browser-security"]
---

# SameSite-куки: Защита от CSRF-атак в веб-приложениях

## Введение в SameSite атрибут куки

SameSite - это атрибут HTTP cookie, который помогает предотвратить CSRF-атаки (Cross-Site Request Forgery), ограничивая отправку cookie с межсайтовых запросов. Этот атрибут был введен для повышения безопасности веб-приложений и стал важным элементом современной защиты от межсайтовой подделки запросов.

CSRF-атаки происходят, когда злонамеренный сайт заставляет браузер пользователя выполнить нежелательное действие на сайте, где пользователь аутентифицирован. SameSite-куки позволяют разработчикам указать, когда cookie должны быть отправлены с запросами, тем самым предотвращая непреднамеренную отправку аутентификационных данных с межсайтовых запросов.

## История и развитие SameSite

Атрибут SameSite был впервые предложен в 2016 году как часть инициативы по улучшению безопасности веб-приложений. Первоначально он был включен в черновик спецификации HTTP State Management Mechanism, а затем был стандартизирован в RFC 6265bis.

Первоначально существовал только один режим - "Strict", который был слишком ограничительным для большинства веб-приложений. Впоследствии был добавлен режим "Lax", который обеспечивал лучший баланс между безопасностью и функциональностью. В 2019 году Google Chrome объявил о планах по изменению поведения по умолчанию, что привело к необходимости явного указания атрибута SameSite для всех cookie.

С течением времени поддержка SameSite была добавлена во все основные браузеры, включая Chrome, Firefox, Safari и Edge, что сделало его универсальным инструментом защиты от CSRF-атак.

## Три режима SameSite

SameSite атрибут может принимать три значения:

1. **Strict** - cookie отправляются только в рамках одного сайта (same-site)
2. **Lax** - cookie отправляются в рамках одного сайта и при межсайтовой навигации верхнего уровня
3. **None** - cookie отправляются во всех контекстах, включая межсайтовые запросы

## Как работает каждый режим

### Strict режим

В режиме Strict cookie отправляются только тогда, когда запрос исходит с того же сайта, что и целевой ресурс. Это наиболее защищенный режим, но он может нарушать функциональность приложений, которые полагаются на межсайтовые запросы.

**Пример:**
- Пользователь аутентифицирован на сайте example.com
- Пользователь переходит по ссылке с badsite.com на example.com
- Cookie не будут отправлены с этим запросом
- Пользователь будет восприниматься как неаутентифицированный

### Lax режим

Режим Lax более снисходительный. Cookie отправляются в рамках одного сайта и при межсайтовой навигации верхнего уровня (например, при переходе по ссылке), но не отправляются с межсайтовыми под запросами (например, AJAX-запросами или формами).

**Пример:**
- Пользователь аутентифицирован на сайте example.com
- Пользователь переходит по ссылке с badsite.com на example.com - cookie будут отправлены
- AJAX-запрос с badsite.com на example.com - cookie НЕ будут отправлены

### None режим

Режим None позволяет отправлять cookie во всех контекстах, включая межсайтовые запросы. Однако, при использовании этого режима, cookie должны быть помечены как Secure (т.е. передаваться только по HTTPS).

## Примеры использования и реализации

### Установка SameSite-куки на сервере (Node.js/Express)

```javascript
// Установка куки с режимом Lax
res.cookie('session', sessionId, {
  secure: true,           // Куки должны передаваться только по HTTPS
  sameSite: 'lax',        // Режим SameSite
  httpOnly: true,         // Защита от XSS
  maxAge: 24 * 60 * 60 * 1000 // Время жизни куки
});

// Установка куки с режимом Strict
res.cookie('auth', authToken, {
  secure: true,
  sameSite: 'strict',
  httpOnly: true
});

// Установка куки с режимом None (требует Secure)
res.cookie('tracking', trackingId, {
  secure: true,
  sameSite: 'none',
  httpOnly: false         // Может быть доступна из JavaScript
});
```

### Установка SameSite-куки на клиенте (JavaScript)

```javascript
// Установка куки с помощью JavaScript (только для SameSite=Lax или Strict)
document.cookie = "myCookie=value; SameSite=Lax; Secure";

// Для SameSite=None также требуется Secure
document.cookie = "myCookie=value; SameSite=None; Secure";
```

### Пример на PHP

```php
// Установка куки с SameSite в PHP 7.3+
setcookie('session', $sessionId, [
  'expires' => time() + 3600,
  'secure' => true,
  'httponly' => true,
  'samesite' => 'Lax'
]);

// Или с помощью header()
header('Set-Cookie: session=' . $sessionId . '; SameSite=Lax; Secure; HttpOnly');
```

## Совместимость с браузерами

Поддержка SameSite-куки в основных браузерах:

- **Chrome**: с версии 51 (полная поддержка с 80+)
- **Firefox**: с версии 60 (полная поддержка с 79+)
- **Safari**: с версии 12 (ограниченная поддержка в более ранних версиях)
- **Edge**: с версии 79 (на базе Chromium)
- **Internet Explorer**: не поддерживается

Важно учитывать, что старые версии браузеров могут игнорировать атрибут SameSite или обрабатывать его неправильно, поэтому рекомендуется использовать его в сочетании с другими методами защиты от CSRF.

## Практические рекомендации по настройке

### Выбор подходящего режима

1. **Strict** - подходит для чувствительных операций, таких как изменение пароля, платежи и т.д.
2. **Lax** - оптимальный выбор для большинства веб-приложений, обеспечивает баланс безопасности и удобства
3. **None** - используется только когда необходимо отправлять cookie с межсайтовых запросов (например, для встраивания контента)

### Проверка настроек

Для проверки правильности настройки SameSite-куки можно использовать инструменты разработчика в браузере:

1. Открыть вкладку Network
2. Выполнить запрос, который должен отправить cookie
3. Проверить заголовки запроса и ответа на наличие атрибута SameSite

### Тестирование

Важно протестировать приложение с разными режимами SameSite, особенно если оно использует iframe или межсайтовые запросы. Необходимо убедиться, что функциональность не нарушена при включении защиты.

## Ограничения и подводные камни

### Ограничения

1. SameSite-куки не защищают от атак, происходящих на том же сайте (например, XSS)
2. Не защищают от атак, если злоумышленник может выполнить код на целевом домене
3. Могут нарушать функциональность приложений, которые полагаются на межсайтовые запросы

### Подводные камни

1. **Несовместимость со старыми браузерами** - старые версии могут игнорировать атрибут
2. **Проблемы с iframe** - SameSite=None необходим для cookie в iframe, но требует Secure
3. **Заголовки CORS** - SameSite не заменяет необходимость правильной настройки CORS
4. **Тестирование** - сложность тестирования всех сценариев использования

### Потенциальные проблемы

1. **OAuth и SSO** - могут потребовать SameSite=None, что требует дополнительной настройки
2. **Встраиваемый контент** - SameSite=None необходим для корректной работы
3. **Междоменные запросы** - требуют careful планирования при использовании SameSite

## Сравнение с другими методами защиты

### SameSite vs CSRF-токены

SameSite-куки и CSRF-токены - это два разных подхода к защите от CSRF-атак:

- **CSRF-токены**:
  - Требуют генерации и проверки токена на сервере
  - Требуют включения токена в каждый запрос
  - Более гибкие, но сложнее в реализации
  - Работают во всех браузерах

- **SameSite-куки**:
  - Проще в реализации
  - Не требуют изменения логики приложения
  - Зависят от поддержки браузером
  - Более надежные при правильной настройке

### SameSite vs CORS

SameSite и CORS решают разные проблемы:
- CORS контролирует, какие домены могут делать запросы к API
- SameSite контролирует, будут ли cookie отправлены с запросами

Оба механизма могут использоваться вместе для обеспечения комплексной безопасности.

### SameSite vs Referrer Policy

Referrer Policy контролирует, какая информация о реферере передается с запросами, в то время как SameSite контролирует отправку cookie. Эти механизмы дополняют друг друга, но решают разные аспекты безопасности.

## Связанные концепции

Для более глубокого понимания темы рекомендуется ознакомиться с следующими материалами:

- [[CSRF-атаки]] - подробное описание природы CSRF-атак
- [[Cookie-безопасность]] - общие принципы безопасной работы с cookie
- [[Сессии и аутентификация]] - как правильно управлять сессиями
- [[HTTP-заголовки безопасности]] - другие важные заголовки для защиты
- [[XSS-защита]] - защита от межсайтового скриптинга
- [[CORS-политики]] - управление межсайтовыми запросами
- [[Современные методы аутентификации]] - OAuth, OpenID Connect и др.
- [[Безопасность веб-приложений]] - общий обзор безопасности веб-приложений
- [[HTTP Strict Transport Security]] - принудительное использование HTTPS
- [[Content Security Policy]] - политика безопасности контента

## Заключение

SameSite-куки являются важным инструментом в арсенале разработчиков для защиты веб-приложений от CSRF-атак. Правильное понимание и применение различных режимов SameSite позволяет значительно повысить безопасность приложений, при этом сохраняя их функциональность.

При внедрении SameSite-куки важно учитывать специфику приложения, тестировать различные сценарии использования и сочетать эту защиту с другими мерами безопасности для обеспечения комплексной защиты от различных типов атак.

Для достижения наилучших результатов рекомендуется использовать SameSite в сочетании с другими методами защиты, такими как CSRF-токены, Content Security Policy и правильная настройка CORS.