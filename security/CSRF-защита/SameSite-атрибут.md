---
aliases: ["SameSite Attribute", "SameSite Cookie Attribute", "Атрибут SameSite"]
tags: ["#security", "#web-security", "#csrf", "#cookies", "#http-headers"]
---

# SameSite-атрибут

SameSite-атрибут - это важное дополнение к HTTP-куки, которое помогает предотвратить атаки межсайтовой подделки запроса (CSRF). Он контролирует, когда куки должны быть отправлены вместе с запросами, инициированными с других сайтов.

## Введение в атрибут SameSite

SameSite - это атрибут, который может быть добавлен к HTTP-куки для повышения безопасности веб-приложений. Он был впервые предложен в 2016 году и теперь поддерживается большинством современных браузеров. Атрибут помогает предотвратить CSRF-атаки, контролируя, когда куки отправляются с запросами, инициированными с других доменов.

> [!info] 
> CSRF (Cross-Site Request Forgery) - это тип атаки, при которой злонамеренный сайт заставляет пользователя выполнить нежелательные действия на другом сайте, где пользователь аутентифицирован.

SameSite-атрибут работает путем ограничения отправки куки в контексте межсайтовых запросов, что делает невозможным использование куки для подделки запросов от имени аутентифицированного пользователя.

## Как работает SameSite

Когда браузер отправляет HTTP-запрос, он автоматически включает соответствующие куки, если они установлены для этого домена. SameSite-атрибут добавляет дополнительный уровень контроля, определяя, должны ли куки быть включены в запрос, инициированный с другого домена.

### Контекст запроса

SameSite различает три типа контекста запроса:

1. **Same-site** - запрос инициирован с того же сайта, что и целевой домен
2. **Cross-site** - запрос инициирован с другого домена
3. **Same-origin** - запрос к тому же домену, порту и схеме

### Процесс проверки

Когда браузер обрабатывает запрос, он:
1. Определяет контекст запроса (same-site или cross-site)
2. Проверяет значение SameSite-атрибута для соответствующей куки
3. Решает, включать ли куки в запрос на основе этого значения

## Значения атрибута (Strict, Lax, None)

SameSite-атрибут может принимать три значения:

### Strict

При значении `Strict` куки отправляются только в рамках same-site запросов. Это означает, что куки не будут отправлены, если пользователь переходит по ссылке с другого сайта, даже если это прямой переход.

```
Set-Cookie: sessionId=abc123; SameSite=Strict
```

### Lax

Значение `Lax` предоставляет более сбалансированный подход. Куки отправляются в рамках same-site запросов и в ограниченном числе cross-site случаев, таких как навигация по ссылкам (GET-запросы).

```
Set-Cookie: sessionId=abc123; SameSite=Lax
```

### None

Значение `None` указывает, что куки должны отправляться во всех случаях, включая cross-site запросы. При использовании этого значения также требуется установка атрибута `Secure`, чтобы куки передавались только по HTTPS.

```
Set-Cookie: sessionId=abc123; SameSite=None; Secure
```

## Различия между значениями

| Значение | Same-site запросы | Cross-site навигация (GET) | Cross-site запросы (POST) | Cross-site подресурсы |
|----------|-------------------|----------------------------|----------------------------|------------------------|
| Strict   | ✅                | ❌                         | ❌                        | ❌                     |
| Lax      | ✅                | ✅                         | ❌                        | ❌                     |
| None     | ✅                | ✅                         | ✅                        | ✅                     |

### Strict

- **Максимальная безопасность**: Предотвращает все cross-site передачи куки
- **Минимальное удобство**: Может нарушать пользовательский опыт (например, при переходе по ссылкам из электронной почты)
- **Использование**: Подходит для чувствительных операций, таких как банковские транзакции

### Lax

- **Сбалансированная безопасность**: Защищает от CSRF-атак, но сохраняет основную функциональность
- **Умеренное удобство**: Позволяет куки при навигации по ссылкам
- **Использование**: Рекомендуемое значение для большинства сценариев

### None

- **Минимальная безопасность**: Не защищает от CSRF-атак
- **Максимальное удобство**: Куки доступны во всех контекстах
- **Использование**: Требуется для кросс-доменных API и встраиваемых виджетов

## Примеры использования

### Пример 1: Защита сессии пользователя

```
Set-Cookie: sessionid=abc123; Path=/; HttpOnly; SameSite=Lax
```

Этот пример устанавливает куки сессии с атрибутом `SameSite=Lax`, что обеспечивает защиту от CSRF-атак, но позволяет пользователю оставаться аутентифицированным при переходе по ссылкам с других сайтов.

### Пример 2: Аутентификационный токен для API

```
Set-Cookie: auth_token=xyz789; Domain=api.example.com; Secure; SameSite=None
```

Для кросс-доменного API может потребоваться `SameSite=None`, чтобы токен был доступен при вызовах с других доменов. Обязательно использовать `Secure` в этом случае.

### Пример 3: Чувствительные операции

```
Set-Cookie: csrf_token=def456; Path=/; HttpOnly; SameSite=Strict
```

Для чувствительных операций, таких как изменение пароля или удаление аккаунта, рекомендуется использовать `SameSite=Strict`.

## Совместимость с браузерами

SameSite-атрибут поддерживается большинством современных браузеров:

### Поддержка по браузерам

- **Chrome**: с версии 51 (2016) для Strict/Lax, с версии 84 (2020) для новых значений по умолчанию
- **Firefox**: с версии 60 (2018) для Strict/Lax, с версии 79 (2020) для новых значений по умолчанию
- **Safari**: с версии 12 (2018) для Strict/Lax
- **Edge**: с версии 79 (2020) для новых значений по умолчанию
- **Opera**: с версии 39 (2016) для Strict/Lax

### Значения по умолчанию

С 2020 года большинство браузеров начали использовать `Lax` как значение по умолчанию, если SameSite-атрибут не указан явно. Это может повлиять на совместимость старых приложений.

> [!warning]
> Приложение, которое не учитывает изменение поведения по умолчанию, может перестать работать корректно в современных браузерах.

## Тонкости реализации

### Совместимость с устаревшими браузерами

Некоторые старые браузеры могут не поддерживать SameSite-атрибут. В таких случаях рекомендуется использовать стратегию постепенного внедрения:

```
Set-Cookie: sessionid=abc123; Path=/; HttpOnly; SameSite=Lax
Set-Cookie: sessionid=abc123; Path=/; HttpOnly  # Резервная куки для старых браузеров
```

### Работа с поддоменами

SameSite-атрибут не влияет на передачу куки между поддоменами одного и того же сайта. Однако важно учитывать, что переход с `subdomain1.example.com` на `subdomain2.example.com` может рассматриваться как cross-site в некоторых контекстах.

### Влияние на iframe

Куки с `SameSite=Lax` или `SameSite=Strict` не будут отправлены в контексте iframe, если iframe загружен с другого домена. Это может повлиять на функциональность встраиваемых виджетов.

## Альтернативы и дополнения

### Токены CSRF (Anti-CSRF Tokens)

SameSite-атрибут не заменяет токены CSRF, а дополняет их. Токены CSRF обеспечивают дополнительный уровень защиты:

```html
<form method="POST" action="/transfer">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    <input type="text" name="amount">
    <button type="submit">Перевести</button>
</form>
```

### Double Submit Cookie Pattern

Еще один подход к защите от CSRF - это Double Submit Cookie, при котором токен отправляется как в куки, так и в теле запроса, а затем сравнивается на сервере.

### Content Security Policy (CSP)

CSP может ограничить возможность выполнения скриптов, что также помогает предотвратить CSRF-атаки, особенно когда они связаны с XSS.

## Практические рекомендации

### 1. Используйте Lax как значение по умолчанию

Для большинства сценариев `SameSite=Lax` обеспечивает хороший баланс между безопасностью и удобством использования.

### 2. Используйте Strict для чувствительных операций

Для операций, таких как изменение пароля или удаление аккаунта, используйте `SameSite=Strict`.

### 3. Используйте None только при необходимости

`SameSite=None` должен использоваться только когда действительно необходима передача куки в cross-site контексте, и всегда в сочетании с `Secure`.

### 4. Тестируйте совместимость

Обязательно тестируйте приложение в разных браузерах, особенно при переходе на новые значения по умолчанию.

### 5. Комбинируйте с другими мерами защиты

SameSite-атрибут должен использоваться в сочетании с другими мерами защиты, такими как токены CSRF и CSP.

## Возможные проблемы и решения

### Проблема 1: Потеря сессии при переходе по внешним ссылкам

**Проблема**: При использовании `SameSite=Strict` пользователь может потерять сессию при переходе по внешней ссылке.

**Решение**: Использовать `SameSite=Lax` для основных сессионных куки.

### Проблема 2: Нарушение работы кросс-доменных API

**Проблема**: `SameSite=Lax` или `SameSite=Strict` могут мешать работе кросс-доменных API.

**Решение**: Использовать `SameSite=None; Secure` для API-токенов.

### Проблема 3: Проблемы с iframe

**Проблема**: Куки не передаются в iframe, что может повлиять на встраиваемые виджеты.

**Решение**: Использовать `SameSite=None; Secure` для куки, необходимых в iframe, или альтернативные методы аутентификации.

### Проблема 4: Совместимость с устаревшими браузерами

**Проблема**: Некоторые старые браузеры могут не поддерживать SameSite-атрибут.

**Решение**: Реализовать резервную стратегию без SameSite-атрибута для старых браузеров.

## Тестирование SameSite

### Тестирование в браузере

Для тестирования SameSite-атрибута можно использовать инструменты разработчика браузера:

1. Открыть DevTools (обычно F12)
2. Перейти на вкладку Network
3. Выполнить действия, которые должны вызвать отправку куки
4. Проверить, отправляются ли куки с запросами в нужных контекстах

### Автоматизированное тестирование

Для автоматизированного тестирования можно использовать инструменты, такие как Selenium или Puppeteer:

```javascript
// Пример теста с Puppeteer
const puppeteer = require('puppeteer');

(async () => {
  const browser = await puppeteer.launch();
  const page = await browser.newPage();
  
  // Установка куки с SameSite-атрибутом
  await page.setCookie({
    name: 'test_cookie',
    value: 'test_value',
    domain: 'example.com',
    sameSite: 'Lax'  // или 'Strict', 'None'
  });
  
  // Проверка поведения при различных типах запросов
  await page.goto('https://example.com');
  // ... дополнительные проверки
  
  await browser.close();
})();
```

### Тестирование в разных браузерах

Важно тестировать поведение SameSite-атрибута в разных браузерах и версиях, так как могут быть различия в реализации.

## Ссылки на другие связанные файлы

- [[CSRF-защита]]
- [[Анти-CSRF-токены]]
- [[Double-Submit-Cookie]]
- [[Типы-CSRF-атак]]
- [[Методы-защиты-от-CSRF]]
- [[Обход-CSRF-защиты]]
- [[HTTP-Security-Headers]]
- [[Cookies]]
- [[Cross-Origin-Resource-Sharing]]
- [[Content-Security-Policy]]

## Заключение

SameSite-атрибут - мощный инструмент для защиты веб-приложений от CSRF-атак. Правильное использование этого атрибута может значительно повысить безопасность приложения, но требует внимательного подхода к выбору значений и тестированию совместимости.
