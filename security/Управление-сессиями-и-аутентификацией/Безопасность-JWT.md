---
aliases: [JWT, JSON Web Token, Безопасность токенов]
tags: [security, authentication, jwt, web-security]
---

# Безопасность JWT (JSON Web Tokens)

## Введение в JWT (JSON Web Tokens)

JSON Web Token (JWT) - это открытый стандарт (RFC 7519), который определяет компактный и самостоятельный способ безопасной передачи информации между сторонами в виде JSON-объекта. JWT используются в системах аутентификации и авторизации, позволяя передавать утверждения (claims) о субъекте в защищенном и надежном способе.

JWT особенно популярны в веб-приложениях и API, где они обеспечивают эффективный способ подтверждения идентичности пользователя без необходимости хранения сессии на сервере. Это делает JWT отличным выбором для масштабируемых приложений и систем с распределенной архитектурой.

## Структура JWT

JWT состоит из трех частей, разделенных точками:

```
header.payload.signature
```

### Заголовок (Header)

Заголовок обычно содержит два поля:
- `alg` - алгоритм подписи (например, HS256, RS256)
- `typ` - тип токена (обычно "JWT")

Пример заголовка:
```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### Полезная нагрузка (Payload)

Payload содержит утверждения (claims) - информацию о субъекте и дополнительные метаданные. Существует три типа claims:
- **Registered claims** - стандартные, рекомендованные IANA (iss, sub, aud, exp, nbf, iat, jti)
- **Public claims** - общедоступные, но должны быть зарегистрированы в IANA
- **Private claims** - пользовательские, для обмена информацией между сторонами

Пример payload:
```json
{
  "sub": "1234567890",
  "name": "John Doe",
  "admin": true,
  "iat": 1516239022
}
```

### Подпись (Signature)

Подпись создается путем кодирования заголовка и payload с использованием Base64Url, объединения их с точкой и последующего применения алгоритма подписи.

## Типы JWT (JWS, JWE)

JWT может быть представлен в двух основных форматах:

### JWS (JSON Web Signature)

JWS - это JWT с цифровой подписью, который обеспечивает целостность данных. Это наиболее распространенная форма JWT, используемая для аутентификации и авторизации.

Пример JWS: `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c`

### JWE (JSON Web Encryption)

JWE - это JWT с шифрованием, который обеспечивает конфиденциальность данных. Используется, когда необходимо защитить содержимое токена от несанкционированного доступа.

## Безопасная генерация JWT

Для безопасной генерации JWT необходимо следовать следующим принципам:

1. **Использование криптографически стойких алгоритмов**
   - Предпочтительно использовать RS256 или ES256 вместо HS256
   - Избегать алгоритма "none" в продакшене

2. **Правильная генерация секретных ключей**
   - Использовать криптографически безопасные генераторы случайных чисел
   - Длина ключа должна быть достаточной для выбранного алгоритма

3. **Ограничение срока действия токена**
   - Устанавливать короткие сроки действия (exp claim)
   - Рассмотреть использование refresh токенов

4. **Валидация данных перед генерацией**
   - Проверять все данные, которые будут включены в токен
   - Ограничивать объем информации в токене до минимума

## Подпись и шифрование JWT

### Подпись JWT

Подпись JWT обеспечивает целостность и аутентичность токена. При использовании симметричных алгоритмов (HS256) обе стороны должны знать общий секретный ключ. При использовании асимметричных алгоритмов (RS256) подпись создается с помощью приватного ключа, а проверка - с помощью публичного.

### Шифрование JWT

Шифрование JWT (JWE) используется, когда необходимо защитить содержимое токена от просмотра. Это особенно важно, когда в токене содержатся чувствительные данные.

## Обработка и проверка JWT

### Проверка подписи

При обработке JWT необходимо:
1. Проверить формат токена
2. Декодировать заголовок и проверить алгоритм
3. Проверить срок действия (exp, nbf)
4. Проверить подпись с использованием правильного ключа
5. Валидировать claims

### Пример проверки JWT

```javascript
const jwt = require('jsonwebtoken');

function verifyToken(token, secret) {
  try {
    const decoded = jwt.verify(token, secret);
    
    // Проверка срока действия
    if (decoded.exp < Date.now() / 1000) {
      throw new Error('Token expired');
    }
    
    return decoded;
  } catch (error) {
    throw new Error('Invalid token: ' + error.message);
  }
}
```

## Уязвимости в реализации JWT

### 1. Алгоритм "none"

Уязвимость, при которой сервер принимает токен с алгоритмом "none", что позволяет создавать поддельные токены без подписи.

### 2. Подмена алгоритма

Атака, при которой злоумышленник меняет алгоритм подписи в заголовке с RS256 на HS256 и использует публичный ключ как секретный.

### 3. Неправильная валидация ключа

Отсутствие проверки соответствия ключа аудитории или отсутствие проверки типа ключа.

### 4. Утечка информации

Хранение чувствительной информации в payload токена без шифрования.

## Лучшие практики безопасности JWT

1. **Использование безопасных алгоритмов**
   - Предпочтительно RS256, ES256 или PS256
   - Избегать HS256 при распределенных системах
   - Ни в коем случае не использовать "none"

2. **Правильное управление ключами**
   - Регулярная ротация ключей
   - Безопасное хранение ключей (не в коде)
   - Использование систем управления ключами (KMS)

3. **Ограничение срока действия**
   - Короткие access токены (15-30 минут)
   - Более длительные refresh токены (несколько дней)
   - Использование claims exp, nbf, iat

4. **Минимизация информации в токене**
   - Хранить только необходимые данные
   - Не хранить чувствительную информацию (пароли, ПДН)

5. **Защита от replay атак**
   - Использование jti (JWT ID) для уникальности
   - Хранение использованных токенов при необходимости

## Хранение JWT на клиенте

### Варианты хранения

1. **LocalStorage**
   - Плюсы: простота использования, не отправляется с запросами
   - Минусы: уязвим к XSS атакам

2. **HttpOnly Cookies**
   - Плюсы: защищает от XSS, автоматически отправляется с запросами
   - Минусы: уязвим к CSRF (требуется дополнительная защита)

3. **SessionStorage**
   - Плюсы: автоматически очищается при закрытии вкладки
   - Минусы: уязвим к XSS, не сохраняется между сессиями

### Рекомендации по хранению

- Для SPA рекомендуется использовать HttpOnly cookies с защитой от CSRF
- При использовании LocalStorage обязательно реализовать защиту от XSS
- Рассмотреть использование refresh токенов для автоматического обновления

## Примеры безопасной реализации

### Безопасная генерация JWT

```javascript
const jwt = require('jsonwebtoken');

function generateSecureToken(payload, privateKey) {
  return jwt.sign(payload, privateKey, {
    algorithm: 'RS256',
    expiresIn: '15m', // 15 минут
    issuer: 'your-app-name',
    audience: 'your-app-audience',
    subject: payload.sub || null,
    jwtid: require('crypto').randomBytes(16).toString('hex') // уникальный ID
  });
}
```

### Безопасная проверка JWT

```javascript
const jwt = require('jsonwebtoken');

function verifySecureToken(token, publicKey) {
  try {
    // Явно указываем ожидаемый алгоритм
    const options = {
      algorithms: ['RS256'],
      issuer: 'your-app-name',
      audience: 'your-app-audience'
    };
    
    const decoded = jwt.verify(token, publicKey, options);
    
    // Дополнительная проверка срока действия
    if (decoded.exp < Math.floor(Date.now() / 1000)) {
      throw new Error('Token expired');
    }
    
    return decoded;
  } catch (error) {
    console.error('JWT verification failed:', error.message);
    return null;
  }
}
```

## Сравнение с другими методами аутентификации

### JWT vs Сессии на сервере

| Критерий | JWT | Сессии |
|----------|-----|--------|
| Масштабируемость | Высокая (без состояния) | Низкая (требует хранения сессий) |
| Производительность | Высокая (без запросов к БД) | Ниже (нужна проверка сессии) |
| Безопасность | Зависит от реализации | Хорошая (контроль на сервере) |
| Совместимость с CORS | Отличная | Требует настройки |

### JWT vs OAuth 2.0

JWT и OAuth 2.0 решают разные задачи:
- OAuth 2.0 - это протокол авторизации
- JWT - это формат токена, который может использоваться в OAuth 2.0

## Практические рекомендации

1. **Использовать HTTPS во всех случаях**
   - JWT передаются по сети и могут быть перехвачены
   - Особенно важно при передаче в заголовках или cookies

2. **Реализовать механизм обновления токенов**
   - Использовать пару access/refresh токенов
   - Refresh токены должны храниться более надежно

3. **Логировать использование токенов**
   - Отслеживать аномальное использование
   - Реализовать аудит для безопасности

4. **Тестировать безопасность JWT**
   - Регулярно проверять реализацию на уязвимости
   - Использовать инструменты для тестирования JWT

5. **Обновлять зависимости**
   - Регулярно обновлять библиотеки для работы с JWT
   - Следить за новыми уязвимостями в реализациях

## Ссылки на другие связанные файлы

- [[Аутентификация-и-авторизация]]
- [[Управление-сессиями]]
- [[OAuth-2.0-и-OpenID-Connect]]
- [[CSRF-защита]]
- [[XSS-защита]]
- [[HTTP-Security-Headers]]
- [[Secure-Storage]]
- [[Безопасность-в-SPA]]
- [[Безопасность-в-микросервисной-архитектуре]]
- [[Ограничение-доступа-к-API]]
- [[Шифрование-на-клиенте]]
- [[Контроль-доступа-к-данным-в-браузере]]

## Заключение

JWT являются мощным инструментом для аутентификации и авторизации, но требуют тщательной реализации с учетом всех аспектов безопасности. При правильном использовании они обеспечивают масштабируемость, производительность и надежную защиту данных.

Понимание уязвимостей и следование лучшим практикам позволяет использовать JWT безопасно и эффективно в современных веб-приложениях.