---
aliases: [Токен-аутентификация, JWT-аутентификация, Безопасная аутентификация]
tags: [security, authentication, tokens, jwt, session-management]
---

# Токен-базированная аутентификация

## Введение в токен-базированную аутентификацию

Токен-базированная аутентификация - это современный подход к управлению сессиями в веб-приложениях, который отличается от традиционной сессионной аутентификации. Вместо хранения информации о сессии на сервере, этот метод использует токены, которые передаются между клиентом и сервером для подтверждения личности пользователя.

Токены содержат зашифрованную информацию о пользователе и могут быть проверены сервером без необходимости в сохранении состояния сессии. Это делает архитектуру более масштабируемой и подходящей для распределенных систем и микросервисов.

## Что такое токены аутентификации

Токены аутентификации - это криптографически подписанные строки, которые содержат информацию о пользователе и его правах доступа. Они позволяют системе идентифицировать пользователя без необходимости в постоянном обращении к базе данных или хранении сессии на сервере.

Токены обычно содержат:
- Идентификатор пользователя
- Время истечения
- Подпись для проверки подлинности
- Дополнительные атрибуты (роли, права доступа и т.д.)

## Виды токенов

### JWT (JSON Web Tokens)

JWT - это открытый стандарт (RFC 7519) для создания токенов, содержащих утверждения между двумя сторонами. JWT состоит из трех частей, разделенных точками:

1. **Заголовок (Header)** - содержит информацию о типе токена и алгоритме шифрования
2. **Полезная нагрузка (Payload)** - содержит утверждения (claims) о пользователе
3. **Подпись (Signature)** - используется для проверки подлинности токена

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

### Opaque tokens

Opaqute tokens - это случайные строки, которые не содержат в себе информации о пользователе. Вместо этого, информация хранится на сервере, а токен используется как ключ для доступа к этой информации. Такие токены обеспечивают большую гибкость в управлении сессиями, так как их можно легко отозвать.

### Refresh tokens

Refresh tokens - это специальные токены, используемые для получения новых access tokens без повторной аутентификации пользователя. Они обычно имеют более длительный срок действия и хранятся более безопасно.

## Преимущества токен-базированной аутентификации

- **Масштабируемость** - не требуется хранить сессии на сервере
- **Мобильная совместимость** - лучше работает с мобильными приложениями
- **Междоменность** - легче реализовать аутентификацию между доменами
- **Безопасность** - можно легко ограничить права доступа через токены
- **Распределенные системы** - идеально подходит для микросервисной архитектуры

## Недостатки и риски

- **Размер токенов** - JWT могут быть больше, чем сессионные куки
- **Невозможность отозвать токен** - однажды выданный токен действует до истечения срока
- **Хранение на клиенте** - токены могут быть уязвимы к XSS-атакам
- **Сложность управления** - требует дополнительных механизмов для refresh-токенов

## Реализация на фронтенде

Для работы с токенами на фронтенде обычно используются следующие подходы:

1. **Хранение в localStorage/sessionStorage** - простая реализация, но уязвима к XSS
2. **Использование HTTP-заголовков** - токены передаются в заголовке Authorization
3. **Интеграция с фреймворками** - использование специализированных библиотек для управления токенами

## Хранение токенов в браузере

### localStorage и sessionStorage

```javascript
// Сохранение токена
localStorage.setItem('authToken', token);

// Получение токена
const token = localStorage.getItem('authToken');

// Удаление токена
localStorage.removeItem('authToken');
```

### HttpOnly cookies

Хотя токены обычно хранятся в localStorage, для дополнительной безопасности можно использовать HttpOnly cookies для хранения refresh-токенов.

## Защита токенов

### Защита от XSS

- Использование Content Security Policy
- Правильная очистка пользовательского ввода
- Ограничение доступа к localStorage из стороннего кода

### Защита от CSRF

- Использование SameSite атрибутов для cookies
- Реализация double-submit cookie паттерна
- Проверка referer заголовка

## Refresh-токены

Refresh-токены позволяют получать новые access-токены без повторной аутентификации. Обычно они имеют более длительный срок действия и хранятся более безопасно.

Процесс обновления токенов:
1. Access token истекает
2. Клиент отправляет refresh token на сервер
3. Сервер проверяет refresh token
4. Сервер возвращает новый access token (и возможно новый refresh token)
5. Клиент обновляет токены локально

## Примеры кода

### JavaScript - отправка токена в заголовке

```javascript
// Функция для отправки запроса с токеном
async function apiRequest(url, options = {}) {
  const token = localStorage.getItem('authToken');
  
  const config = {
    ...options,
    headers: {
      ...options.headers,
      'Authorization': `Bearer ${token}`
    }
  };
  
  return fetch(url, config);
}

// Использование
apiRequest('/api/data')
  .then(response => response.json())
  .then(data => console.log(data));
```

### Проверка токена на сервере (Node.js)

```javascript
const jwt = require('jsonwebtoken');

function authenticateToken(req, res, next) {
  const authHeader = req.headers['authorization'];
  const token = authHeader && authHeader.split(' ')[1]; // Bearer TOKEN

  if (!token) {
    return res.sendStatus(401);
  }

  jwt.verify(token, process.env.ACCESS_TOKEN_SECRET, (err, user) => {
    if (err) {
      return res.sendStatus(403);
    }
    req.user = user;
    next();
  });
}
```

## Лучшие практики

- Использовать короткий срок действия access-токенов (обычно 15-30 минут)
- Хранить refresh-токены более безопасно (например, в HttpOnly cookie)
- Реализовать механизм отзывания токенов
- Использовать HTTPS для всех аутентификационных запросов
- Правильно настраивать CORS для безопасности
- Валидировать токены на сервере при каждом запросе
- Использовать strong secrets для подписи токенов

## Сравнение с сессионной аутентификацией

| Характеристика | Токен-базированная | Сессионная |
|---|---|---|
| Хранение состояния | На клиенте | На сервере |
| Масштабируемость | Высокая | Ограниченная |
| Совместимость с REST | Полная | Ограниченная |
| Защита от CSRF | Требует дополнительных мер | Встроенная |
| Уязвимость к XSS | Высокая | Низкая |
| Возможность отзыва | Ограниченная | Полная |

## Тестирование безопасности токенов

При тестировании безопасности токен-базированной аутентификации необходимо проверять:

- Правильность формирования токенов
- Валидацию токенов на сервере
- Защиту от подделки токенов
- Правильное обновление токенов
- Безопасное хранение токенов
- Обработку истекших токенов

## Связанные темы

- [[Сессионная-аутентификация]]
- [[OAuth-и-OpenID-Connect]]
- [[JWT-структура-и-безопасность]]
- [[CSRF-защита]]
- [[XSS-защита]]
- [[HTTP-Security-Headers]]
- [[Secure-Storage]]
- [[Управление-доступом]]
- [[Ограничение-доступа-к-API]]
- [[Безопасность-в-SPA]]

## Источники и дополнительные материалы

- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [JWT.IO - инструмент для декодирования и валидации JWT](https://jwt.io/)