---
aliases: [Реализация песочницы, Создание безопасной среды, Изоляция кода]
tags: [security, sandbox, isolation, protection]
---

# Реализация песочницы

## Обзор

Реализация песочницы - это метод изоляции выполнения потенциально небезопасного кода в контролируемой среде. Песочница ограничивает возможности кода и предотвращает доступ к чувствительным ресурсам системы. В контексте веб-безопасности, песочницы особенно важны при интеграции с внешними сервисами и выполнении стороннего кода.

## Принципы работы песочницы

### 1. Изоляция выполнения

Песочница изолирует выполнение кода от основной системы:

- Ограничение доступа к файловой системе
- Ограничение сетевых соединений
- Ограничение доступа к системным ресурсам
- Ограничение межпроцессного взаимодействия

### 2. Контроль разрешений

Песочница предоставляет только минимально необходимые разрешения:

- Ограничение на чтение/запись файлов
- Ограничение на сетевые запросы
- Ограничение на доступ к API браузера
- Ограничение на выполнение системных команд

## Виды песочниц

### 1. iframe песочницы

HTML iframe с атрибутом `sandbox` создает базовую песочницу:

```html
<!-- Пример iframe песочницы -->
<iframe 
  src="https://trusted-domain.com/widget" 
  sandbox="allow-scripts allow-same-origin"
  title="Внешний виджет">
</iframe>
```

Доступные значения атрибута `sandbox`:
- `allow-forms` - разрешает отправку форм
- `allow-pointer-lock` - разрешает захват указателя
- `allow-popups` - разрешает всплывающие окна
- `allow-same-origin` - разрешает одинаковый источник
- `allow-scripts` - разрешает выполнение скриптов
- `allow-top-navigation` - разрешает навигацию верхнего уровня

### 2. Web Workers песочницы

Web Workers обеспечивают изоляцию выполнения JavaScript:

```javascript
// Создание песочницы с Web Worker
const workerCode = `
  // Код, выполняемый в изолированной среде
  self.onmessage = function(e) {
    try {
      // Безопасное выполнение кода
      const result = safeEval(e.data.code, e.data.context);
      self.postMessage({ result, error: null });
    } catch (error) {
      self.postMessage({ result: null, error: error.message });
    }
  };

  function safeEval(code, context) {
    // Ограниченная реализация eval с безопасным контекстом
    // В реальном приложении используйте более надежные методы
    const keys = Object.keys(context);
    const values = Object.values(context);
    const func = new Function(...keys, 'return (' + code + ')');
    return func(...values);
  }
`;

// Создание Blob для Web Worker
const blob = new Blob([workerCode], { type: 'application/javascript' });
const worker = new Worker(URL.createObjectURL(blob));

// Отправка кода для выполнения в песочнице
worker.postMessage({
  code: 'a + b',
  context: { a: 5, b: 3 }
});

worker.onmessage = function(e) {
  console.log('Результат:', e.data.result);
};
```

### 3. iframe с Content Security Policy

Комбинация iframe и CSP обеспечивает более строгую изоляцию:

```html
<iframe 
  src="sandboxed-content.html" 
  sandbox="allow-scripts"
  csp="default-src 'self'; script-src 'self'; object-src 'none';">
</iframe>
```

## Реализация JavaScript песочницы

### 1. Простая песочница

Создание базовой JavaScript песочницы:

```javascript
class SimpleSandbox {
  constructor(options = {}) {
    this.timeout = options.timeout || 1000; // 1 секунда
    this.allowedGlobals = options.allowedGlobals || [
      'Array', 'Object', 'String', 'Number', 'Boolean', 
      'Math', 'JSON', 'Date', 'RegExp'
    ];
  }

  execute(code, context = {}) {
    return new Promise((resolve, reject) => {
      // Создание безопасного контекста
      const sandboxContext = this.createSandboxContext(context);
      
      // Добавление таймера для предотвращения бесконечных циклов
      const startTime = Date.now();
      
      // Выполнение кода в безопасном контексте
      try {
        const result = this.runInContext(code, sandboxContext);
        resolve(result);
      } catch (error) {
        reject(error);
      }
    });
  }

  createSandboxContext(userContext) {
    const context = {};
    
    // Добавление разрешенных глобальных объектов
    this.allowedGlobals.forEach(name => {
      if (typeof globalThis[name] !== 'undefined') {
        context[name] = globalThis[name];
      }
    });
    
    // Добавление пользовательского контекста
    Object.assign(context, userContext);
    
    // Запрет на доступ к опасным объектам
    Object.defineProperty(context, 'window', {
      get: () => {
        throw new Error('Доступ к window запрещен');
      }
    });
    
    Object.defineProperty(context, 'document', {
      get: () => {
        throw new Error('Доступ к document запрещен');
      }
    });
    
    return context;
  }

  runInContext(code, context) {
    // Создание функции с ограниченным доступом
    const contextKeys = Object.keys(context);
    const contextValues = Object.values(context);
    
    // Создание функции с ограниченной областью видимости
    const func = new Function(...contextKeys, `return (function() { ${code} })()`);
    return func(...contextValues);
  }
}

// Пример использования
const sandbox = new SimpleSandbox();

sandbox.execute('return a + b;', { a: 5, b: 3 })
  .then(result => console.log('Результат:', result))
  .catch(error => console.error('Ошибка:', error));
```

### 2. Продвинутая песочница

Более сложная реализация с дополнительными возможностями:

```javascript
class AdvancedSandbox {
  constructor(options = {}) {
    this.timeout = options.timeout || 5000;
    this.maxMemory = options.maxMemory || 10 * 1024 * 1024; // 10MB
    this.allowedMethods = options.allowedMethods || [];
    this.disallowedMethods = options.disallowedMethods || [
      'eval', 'Function', 'setTimeout', 'setInterval', 
      'import', 'require', 'XMLHttpRequest', 'fetch'
    ];
  }

  async execute(code, context = {}) {
    return new Promise((resolve, reject) => {
      const workerCode = this.generateWorkerCode(code, context);
      const blob = new Blob([workerCode], { type: 'application/javascript' });
      const worker = new Worker(URL.createObjectURL(blob));

      let completed = false;

      // Таймер для ограничения времени выполнения
      const timer = setTimeout(() => {
        if (!completed) {
          worker.terminate();
          reject(new Error('Время выполнения превышено'));
        }
      }, this.timeout);

      worker.onmessage = function(e) {
        completed = true;
        clearTimeout(timer);
        worker.terminate();
        
        if (e.data.error) {
          reject(new Error(e.data.error));
        } else {
          resolve(e.data.result);
        }
      };

      worker.onerror = function(error) {
        completed = true;
        clearTimeout(timer);
        worker.terminate();
        reject(error);
      };
    });
  }

  generateWorkerCode(code, context) {
    return `
      const originalEval = eval;
      const originalFunction = Function;
      
      // Ограничение доступа к опасным методам
      self.eval = function() {
        throw new Error('eval запрещен в песочнице');
      };
      
      self.Function = function() {
        throw new Error('Function запрещен в песочнице');
      };
      
      self.import = function() {
        throw new Error('import запрещен в песочнице');
      };
      
      self.setTimeout = function() {
        throw new Error('setTimeout запрещен в песочнице');
      };
      
      self.setInterval = function() {
        throw new Error('setInterval запрещен в песочнице');
      };
      
      // Пользовательский контекст
      const userContext = ${JSON.stringify(context)};
      
      try {
        // Создание безопасного выполнения
        const keys = Object.keys(userContext);
        const values = Object.values(userContext);
        const func = new originalFunction(...keys, 'return (' + ${JSON.stringify(code)} + ')');
        const result = func(...values);
        self.postMessage({ result, error: null });
      } catch (error) {
        self.postMessage({ result: null, error: error.message });
      }
    `;
  }
}

// Пример использования продвинутой песочницы
const advancedSandbox = new AdvancedSandbox({ timeout: 2000 });

advancedSandbox.execute('return Math.pow(2, 3);')
  .then(result => console.log('Результат:', result))
  .catch(error => console.error('Ошибка:', error));
```

## Песочницы для шаблонов и выражений

### 1. Песочница для выражений

Для безопасного вычисления выражений:

```javascript
class ExpressionSandbox {
  constructor() {
    this.allowedOperators = ['+', '-', '*', '/', '%', '==', '!=', '<', '>', '<=', '>=', '&&', '||'];
    this.allowedFunctions = ['Math.max', 'Math.min', 'Math.abs', 'Math.round', 'Math.floor', 'Math.ceil'];
  }

  evaluate(expression, context = {}) {
    // Проверка выражения на безопасность
    if (!this.isSafeExpression(expression)) {
      throw new Error('Небезопасное выражение');
    }

    // Создание безопасного контекста
    const safeContext = this.createSafeContext(context);
    
    // Выполнение выражения
    const func = new Function(...Object.keys(safeContext), `return (${expression})`);
    return func(...Object.values(safeContext));
  }

  isSafeExpression(expression) {
    // Проверка на наличие потенциально опасных паттернов
    const dangerousPatterns = [
      /\beval\b/,
      /\bFunction\b/,
      /\bsetTimeout\b/,
      /\bsetInterval\b/,
      /\bimport\b/,
      /\brequire\b/,
      /\bdocument\b/,
      /\bwindow\b/,
      /\blocation\b/,
      /\balert\b/,
      /\bprompt\b/,
      /\bconfirm\b/
    ];

    for (const pattern of dangerousPatterns) {
      if (pattern.test(expression)) {
        return false;
      }
    }

    return true;
  }

  createSafeContext(context) {
    // Создание безопасного контекста с разрешенными функциями
    const safeContext = { ...context };
    
    // Добавление безопасных математических функций
    safeContext.Math = {
      max: Math.max,
      min: Math.min,
      abs: Math.abs,
      round: Math.round,
      floor: Math.floor,
      ceil: Math.ceil,
      PI: Math.PI,
      E: Math.E
    };
    
    return safeContext;
  }
}

// Пример использования песочницы для выражений
const exprSandbox = new ExpressionSandbox();

try {
  const result = exprSandbox.evaluate('a + b * Math.max(c, d)', {
    a: 10,
    b: 5,
    c: 3,
    d: 8
  });
  console.log('Результат выражения:', result); // 50
} catch (error) {
  console.error('Ошибка при вычислении:', error);
}
```

## Безопасность песочниц

### 1. Возможные обходы

Несмотря на все меры предосторожности, существуют потенциальные методы обхода песочниц:

- Использование прототипов для получения доступа к опасным методам
- Манипуляции с контекстом выполнения
- Использование рекурсии для исчерпания ресурсов

### 2. Защита от обходов

Для повышения безопасности песочницы:

```javascript
class SecureSandbox {
  constructor() {
    this.protectedObjects = new WeakSet();
  }

  execute(code, context = {}) {
    // Защита от манипуляций с прототипами
    this.protectPrototypes();
    
    // Создание защищенного контекста
    const protectedContext = this.createProtectedContext(context);
    
    // Выполнение кода
    const keys = Object.keys(protectedContext);
    const values = Object.values(protectedContext);
    
    const func = new Function(...keys, `
      "use strict";
      // Дополнительные проверки безопасности
      if (this !== undefined) {
        throw new Error("this недоступен в песочнице");
      }
      return (${code});
    `);
    
    return func(...values);
  }

  protectPrototypes() {
    // Блокировка доступа к опасным прототипам
    Object.defineProperty(Array.prototype, 'constructor', {
      get: function() {
        if (this.__isSandboxed) {
          throw new Error('Доступ к constructor запрещен');
        }
        return Array;
      }
    });
  }

  createProtectedContext(context) {
    const protectedContext = {};
    
    for (const [key, value] of Object.entries(context)) {
      // Обертывание функций для дополнительной безопасности
      if (typeof value === 'function') {
        protectedContext[key] = this.wrapFunction(value);
      } else {
        protectedContext[key] = value;
      }
    }
    
    return protectedContext;
  }

  wrapFunction(fn) {
    return (...args) => {
      // Дополнительная проверка безопасности перед вызовом функции
      return fn.apply(null, args);
    };
  }
}
```

## Практическое применение

### 1. Песочницы в веб-приложениях

Песочницы особенно полезны в следующих сценариях:

- Выполнение пользовательских скриптов
- Обработка шаблонов от ненадежных источников
- Интеграция с внешними библиотеками
- Выполнение кода из внешних API

### 2. Песочницы для плагинов

Для безопасной работы с плагинами:

```javascript
class PluginSandbox {
  constructor() {
    this.plugins = new Map();
  }

  registerPlugin(name, pluginCode) {
    this.plugins.set(name, pluginCode);
  }

  async executePlugin(name, data) {
    const pluginCode = this.plugins.get(name);
    if (!pluginCode) {
      throw new Error(`Плагин ${name} не найден`);
    }

    const sandbox = new AdvancedSandbox({ timeout: 3000 });
    return sandbox.execute(pluginCode, { data });
  }
}

// Пример использования песочницы для плагинов
const pluginSandbox = new PluginSandbox();

pluginSandbox.registerPlugin('calculator', `
  return {
    result: input.a + input.b,
    operation: 'addition'
  };
`);

pluginSandbox.executePlugin('calculator', { a: 10, b: 20 })
  .then(result => console.log('Результат плагина:', result))
  .catch(error => console.error('Ошибка плагина:', error));
```

## Ограничения и рекомендации

### 1. Ограничения JavaScript песочниц

- Невозможность полной изоляции в браузерной среде
- Ограниченная защита от рекурсивных вызовов
- Сложность в обеспечении полной безопасности

### 2. Рекомендации по использованию

- Используйте iframe песочницы для внешнего контента
- Ограничивайте время выполнения кода
- Проверяйте все входные данные
- Используйте CSP для дополнительной защиты
- Регулярно обновляйте и тестируйте песочницы

## Заключение

Реализация песочницы - важный инструмент для обеспечения безопасности при выполнении ненадежного кода. Правильная реализация песочницы может значительно снизить риски, связанные с выполнением стороннего кода, хотя полная изоляция в браузерной среде невозможна. Всегда сочетайте песочницы с другими мерами безопасности, такими как [[Content-Security-Policy]] и [[HTTP-Security-Headers]].

> [!tip] Совет
> Используйте комбинацию iframe песочниц и CSP для максимальной безопасности внешнего контента.

> [!warning] Важно
> JavaScript песочницы в браузере не обеспечивают полной изоляции, используйте их как дополнительный уровень защиты.

> [!note] Примечание
> Для критически важных операций всегда проводите проверки безопасности на сервере.