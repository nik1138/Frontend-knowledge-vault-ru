---
aliases: []
tags:
  - security
  - service-workers
  - caching
  - web-security
---

# Кэширование в сервис-воркерах

## Введение в кэширование в сервис-воркерах

Кэширование в сервис-воркерах — это мощный механизм, позволяющий веб-приложениям хранить ресурсы (например, HTML, CSS, JavaScript, изображения) локально на устройстве пользователя. Это улучшает производительность, обеспечивает автономную работу и снижает нагрузку на сервер. Однако кэширование также вводит дополнительные векторы атак и требует тщательного подхода к безопасности.

Сервис-воркеры обеспечивают программный доступ к кэшу через API `Cache` и `CacheStorage`, что позволяет разработчикам управлять тем, что и как кэшируется. Важно понимать, что данные, хранящиеся в кэше, находятся в пределах Origin пользователя, и их можно использовать как для улучшения пользовательского опыта, так и для потенциальных атак.

## Безопасность кэшированных данных

Кэшированные данные обладают теми же характеристиками безопасности, что и остальные данные, хранящиеся в браузере. Они изолированы по Origin (домен, протокол, порт), что означает, что только веб-сайт с того же Origin может получить доступ к этим данным. Однако, поскольку кэш хранится на устройстве пользователя, он потенциально доступен для атакующего, если у того есть физический доступ к устройству или если браузер содержит уязвимости.

Разработчики должны учитывать, что кэшированные данные могут оставаться на устройстве пользователя дольше, чем ожидалось, и могут быть доступны даже после выхода пользователя из системы или закрытия браузера. Это особенно важно для чувствительных данных, которые не должны храниться локально.

## Угрозы при кэшировании в сервис-воркерах

### 1. Утечка чувствительных данных
Кэширование конфиденциальной информации (например, токенов аутентификации, персональных данных) может привести к их несанкционированному доступу.

### 2. Атаки типа "Cache Poisoning" (Отравление кэша)
Злоумышленник может попытаться внедрить вредоносные или измененные ресурсы в кэш, чтобы они были возвращены пользователю при последующих запросах.

### 3. Атаки на целостность данных
Если кэшированные данные не проверяются на целостность, атакующий может изменить их, что приведет к выполнению вредоносного кода.

### 4. Переполнение кэша
Злоумышленник может попытаться заполнить кэш, чтобы исчерпать ресурсы устройства пользователя.

## Защита от несанкционированного доступа к кэшу

Для защиты кэшированных данных от несанкционированного доступа рекомендуется:

- **Не кэшировать чувствительные данные**: Токены аутентификации, пароли и другие конфиденциальные данные не должны храниться в кэше.
- **Использовать HTTPS**: Все ресурсы, кэшируемые сервис-воркером, должны передаваться по безопасному соединению (HTTPS), чтобы предотвратить их перехват.
- **Ограничивать доступ к кэшу**: Использовать правильные заголовки доступа (CORS) и убедиться, что кэш используется только в пределах вашего Origin.
- **Регулярно очищать кэш**: Удалять устаревшие или ненужные данные, чтобы минимизировать поверхность атаки.

## Шифрование данных в кэше

Для дополнительной защиты кэшированных данных можно использовать шифрование. Это особенно важно для чувствительных данных, которые по каким-то причинам все же оказываются в кэше. Шифрование может быть реализовано с помощью Web Crypto API перед сохранением данных в кэш.

Пример шифрования данных перед кэшированием:

```javascript
// Шифрование данных перед сохранением в кэш
async function encryptAndCache(request, response) {
  const data = await response.arrayBuffer();
  const encryptedData = await encrypt(data); // ваша функция шифрования
  const encryptedResponse = new Response(encryptedData, response);
  await caches.open('encrypted-cache').put(request, encryptedResponse);
}
```

Шифрование усложняет задачу злоумышленника, но не делает систему полностью защищенной, особенно если ключ шифрования также хранится на клиенте.

## Управление сроком действия кэшированных данных

Срок действия кэшированных данных важен для обеспечения актуальности информации и минимизации рисков. Рекомендуется:

- **Устанавливать разумные сроки кэширования**: Использовать заголовки `Cache-Control` и `Expires` для управления сроком действия ресурсов.
- **Реализовать стратегии обновления кэша**: Использовать стратегии типа "stale-while-revalidate" или "cache-first" с фоновой проверкой обновлений.
- **Удалять устаревшие данные**: Регулярно удалять данные, срок действия которых истек, чтобы избежать использования устаревшей информации.

## Удаление чувствительных данных из кэша

Для удаления чувствительных данных из кэша необходимо:

- **Явно удалять кэшированные ресурсы**: Использовать методы `cache.delete()` или `caches.delete()` для удаления конкретных записей или всего кэша.
- **Очищать кэш при выходе пользователя из системы**: При логауте пользователя удалять все кэши, которые могут содержать персональные данные.
- **Использовать события жизненного цикла сервис-воркера**: Удалять устаревшие кэши при установке нового сервис-воркера (`install` событие).

```javascript
// Удаление старых кэшей при установке нового сервис-воркера
self.addEventListener('install', event => {
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheName.startsWith('my-app-') && cacheName !== CURRENT_CACHE_NAME) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
```

## Проверка целостности кэшированных данных

Для обеспечения целостности кэшированных данных можно использовать:

- **Подписи или хэши**: Хранить хэш или подпись данных при кэшировании и проверять его при извлечении.
- **Subresource Integrity (SRI)**: Использовать атрибуты `integrity` в HTML для проверки целостности внешних ресурсов.
- **Проверки при загрузке**: Проверять целостность данных при каждом их использовании, особенно если они критичны для безопасности.

## Уязвимости, связанные с кэшированием

- **Cache Deception**: Атака, при которой злоумышленник заставляет сервис-воркер кэшировать вредоносный контент, который затем используется для атаки на других пользователей.
- **Timing Attacks**: Атаки, основанные на времени доступа к кэшированным ресурсам, могут раскрыть информацию о действиях пользователя.
- **Cross-Site Scripting (XSS) через кэш**: Если кэшируется вредоносный скрипт, он может быть выполнен при последующем доступе к нему.

## Лучшие практики

1. **Не кэшируйте чувствительные данные**: Никогда не храните токены, пароли или персональные данные в кэше.
2. **Используйте HTTPS**: Обеспечьте безопасную передачу данных для кэширования.
3. **Шифруйте конфиденциальные данные**: Если необходимо кэшировать чувствительные данные, используйте шифрование.
4. **Регулярно очищайте кэш**: Удаляйте устаревшие и ненужные данные.
5. **Проверяйте целостность**: Используйте хэши или подписи для проверки целостности данных.
6. **Обновляйте кэши безопасно**: При обновлении кэшированных ресурсов убедитесь, что новые версии также безопасны.
7. **Ограничивайте размер кэша**: Предотвращайте переполнение кэша злоумышленниками.
8. **Тестируйте на уязвимости**: Регулярно проверяйте вашу систему кэширования на наличие уязвимостей.

## Связанные темы

- [[Сервис-воркеры]]
- [[Безопасность-веб-приложений]]
- [[HTTPS-и-безопасность]]
- [[Шифрование-на-клиенте]]
- [[CORS-и-безопасность]]
- [[Web-Crypto-API]]
- [[Subresource-Integrity]]
- [[XSS-защита]]

## Заключение

Кэширование в сервис-воркерах предоставляет значительные преимущества в производительности и автономной работе, но требует тщательного подхода к безопасности. Разработчики должны осознавать потенциальные угрозы и применять соответствующие меры защиты, чтобы обеспечить безопасность данных пользователей.
