---
aliases: ["CSP", "Политика безопасности контента"]
tags: ["#security", "#web-security", "#csp", "#content-security-policy", "#clickjacking", "#xss", "#protection"]
---

# Content Security Policy (CSP) - Политика безопасности контента

## Обзор

Content Security Policy (CSP) — это важный механизм безопасности веб-приложений, который позволяет разработчикам контролировать, какие ресурсы могут быть загружены и выполнены на веб-странице. CSP помогает предотвратить атаки типа межсайтовый скриптинг (XSS), кликджекинг и другие виды атак, связанные с внедрением вредоносного контента.

## 1. Введение в Content Security Policy

Content Security Policy (CSP) — это дополнительный уровень защиты, который помогает обнаруживать и смягчать определенные типы атак, включая межсайтовый скриптинг (XSS) и кликджекинг. CSP позволяет веб-сайтам объявлять разрешенные источники контента, который может быть загружен и выполнен в браузере.

> [!note] CSP как "ограничитель"
> CSP действует как белый список разрешенных источников контента, блокируя все, что не входит в этот список. Это позволяет значительно снизить риск выполнения вредоносного кода.

### Основные цели CSP:
- Предотвращение XSS-атак
- Защита от кликджекинга
- Ограничение загрузки ресурсов с ненадежных источников
- Повышение общей безопасности веб-приложения

## 2. История и развитие CSP

CSP была впервые предложена Mozilla в 2007 году как способ борьбы с XSS-атаками. С тех пор стандарт развивался и получил широкую поддержку в современных браузерах.

### Хронология развития CSP:

- **2007** — Mozilla представляет концепцию CSP
- **2012** — Публикация CSP Level 1 в виде черновика W3C
- **2014** — Окончательная спецификация CSP Level 1
- **2015** — Появление CSP Level 2 с расширенными возможностями
- **2016-2020** — Развитие CSP Level 3 и экспериментальных директив
- **2021-настоящее время** — Поддержка CSP3 в современных браузерах

### Эволюция подхода к безопасности:
Первоначально CSP была простой политикой, позволяющей указать источники скриптов. Со временем она расширилась, включив в себя контроль над стилями, изображениями, шрифтами и другими ресурсами.

## 3. Основные директивы CSP

CSP состоит из набора директив, каждая из которых контролирует определенный тип контента. Ниже приведены основные директивы:

### Основные директивы:

- `default-src` — основная директива, определяющая источники по умолчанию для всех контентных типов
- `script-src` — источники JavaScript-скриптов
- `style-src` — источники CSS-стилей
- `img-src` — источники изображений
- `font-src` — источники шрифтов
- `connect-src` — источники для соединений (AJAX, WebSocket и т.д.)
- `media-src` — источники аудио и видео
- `object-src` — источники плагинов (Flash, Java и т.д.)
- `frame-src` — источники для фреймов
- `sandbox` — песочница для ограничения функциональности страницы

### Примеры директив:

```http
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';
```

### Модификаторы источников:

- `'self'` — разрешает загрузку с текущего домена
- `'unsafe-inline'` — разрешает встроенные скрипты и стили (не рекомендуется)
- `'unsafe-eval'` — разрешает использование eval() и подобных функций (не рекомендуется)
- `'none'` — запрещает все источники
- `'strict-dynamic'` — позволяет динамически загружать скрипты из доверенных источников

## 4. Уровни CSP (CSP Level 1, 2, 3)

### CSP Level 1
Первоначальный уровень CSP, включающий базовые директивы:

- `default-src`, `script-src`, `style-src`, `img-src`, `connect-src`, `font-src`, `media-src`, `object-src`, `child-src`
- `report-uri` — для отправки отчетов о нарушениях
- Несколько ключевых значений: `'self'`, `'none'`, `'unsafe-inline'`, `'unsafe-eval'`

### CSP Level 2
Добавляет расширенные возможности:

- `frame-ancestors` — контроль над тем, кто может встраивать страницу во фреймы (защита от кликджекинга)
- `upgrade-insecure-requests` — автоматическое обновление HTTP-запросов до HTTPS
- Поддержка nonce и hash для разрешения конкретных скриптов
- Улучшенные возможности отчетности

### CSP Level 3
Текущий уровень, включающий:

- `worker-src` — источники для Web Workers
- `manifest-src` — источники для веб-манфестов
- `prefetch-src` — источники для предзагрузки
- `navigate-to` — ограничение переходов
- Улучшенная отчетность через `report-to`
- Поддержка `strict-dynamic`
- Новые экспериментальные директивы

## 5. Реализация и настройка CSP

### Установка CSP через HTTP-заголовок

Самый распространенный способ — установка заголовка `Content-Security-Policy`:

```http
Content-Security-Policy: default-src 'self'; script-src 'self' https://cdn.example.com; style-src 'self' 'unsafe-inline'
```

### Альтернативные способы:

- **Meta-тег** (ограничения: нельзя использовать `report-uri`, `frame-ancestors`):
```html
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline';">
```

- **Конфигурация веб-сервера** (Apache, Nginx и т.д.)

### Примеры конфигурации:

#### Apache
```apache
Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';"
```

#### Nginx
```nginx
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';" always;
```

## 6. Примеры настройки для различных сценариев

### Базовая политика для статического сайта:

```http
Content-Security-Policy: default-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; script-src 'self'
```

### Политика для приложения с внешними CDN:

```http
Content-Security-Policy: default-src 'self'; script-src 'self' https://cdn.example.com https://api.example.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:;
```

### Политика с отчетностью о нарушениях:

```http
Content-Security-Policy: default-src 'self'; script-src 'self'; report-uri /csp-report;
```

### Жесткая политика (максимальная защита):

```http
Content-Security-Policy: default-src 'none'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self';
```

## 7. Отчеты о нарушениях CSP

CSP позволяет отправлять отчеты о нарушениях политики, что помогает в отладке и улучшении политики безопасности.

### Настройка отчетности:

```http
Content-Security-Policy: default-src 'self'; report-uri /csp-report;
```

### Современный способ (CSP Level 3):

```http
Content-Security-Policy: default-src 'self'; report-to csp-endpoint;
```

### Структура отчета:

```json
{
  "csp-report": {
    "document-uri": "https://example.com/page.html",
    "referrer": "",
    "blocked-uri": "https://evil.com/script.js",
    "violated-directive": "script-src 'self'",
    "original-policy": "default-src 'self'; script-src 'self'",
    "disposition": "enforce"
  }
}
```

### Пример обработчика отчетов на Node.js:

```javascript
app.post('/csp-report', (req, res) => {
  const cspReport = req.body['csp-report'];
  console.log('CSP Violation:', cspReport);
  // Логирование или анализ нарушений
  res.status(204).end();
});
```

## 8. Проблемы совместимости и отладка

### Распространенные проблемы:

1. **Нарушения политики** — страница может не работать из-за строгой политики
2. **Совместимость с браузерами** — старые браузеры могут не поддерживать CSP3
3. **Интеграция с существующими скриптами** — сложности с встроенными скриптами

### Режим отчета (report-only):

Для отладки можно использовать режим отчета без блокировки:

```http
Content-Security-Policy-Report-Only: default-src 'self'; script-src 'self'; report-uri /csp-report;
```

### Инструменты отладки:

- DevTools браузера — показывает нарушения CSP
- CSP Evaluator от Mozilla — анализ политики
- CSP Validator — проверка синтаксиса

## 9. Лучшие практики применения CSP

### Пошаговый подход:

1. **Начните с отчета** — используйте `Content-Security-Policy-Report-Only`
2. **Анализируйте отчеты** — определите, какие ресурсы действительно нужны
3. **Постепенно ужесточайте политику** — добавляйте ограничения по мере необходимости
4. **Тестируйте тщательно** — проверяйте все функции приложения

### Рекомендации:

- **Избегайте `'unsafe-inline'` и `'unsafe-eval'`** — используйте nonce или hash для разрешения конкретных скриптов
- **Используйте HTTPS** — CSP более эффективна в защищенной среде
- **Регулярно обновляйте политику** — адаптируйте к изменениям в приложении
- **Документируйте политику** — обеспечьте понимание командой

### Пример хорошей практики с nonce:

```html
<!-- Генерируем уникальный nonce для каждого запроса -->
<script nonce="EDNnf03nceIOfn39fn3e9h3sdfa">
  // Ваш JavaScript код
</script>
```

```http
Content-Security-Policy: script-src 'nonce-EDNnf03nceIOfn39fn3e9h3sdfa';
```

## 10. Сравнение с другими методами защиты

### CSP vs XSS-фильтры:

- **XSS-фильтры** (например, в старых браузерах) — менее надежны и могут быть обойдены
- **CSP** — более надежная защита, контроль на уровне браузера

### CSP vs Same-Origin Policy:

- **Same-Origin Policy** — базовая политика браузера
- **CSP** — дополнительный уровень контроля над источниками контента

### CSP vs Subresource Integrity (SRI):

- **SRI** — проверяет целостность внешних ресурсов по хэшу
- **CSP** — контролирует, какие источники могут быть использованы

### Комплексный подход:

CSP наиболее эффективна в сочетании с другими методами:
- Правильное экранирование данных
- Использование SRI для внешних библиотек
- Правильная настройка заголовков безопасности
- Регулярные аудиты безопасности

## 11. Связанные файлы

- [[XSS-защита]]
- [[HTTPS-безопасность]]
- [[Subresource-Integrity]]
- [[CORS-политика]]
- [[Authentication-авторизация]]
- [[Input-валидация]]
- [[CSRF-защита]]
- [[Clickjacking-защита]]
- [[OWASP-Top-10]]
- [[Security-Headers]]
- [[Web-Application-Firewall]]
- [[Session-управление]]

## 12. Заключение

Content Security Policy — мощный инструмент повышения безопасности веб-приложений. Правильно настроенный CSP может значительно снизить риск XSS-атак и других угроз безопасности. Однако его внедрение требует тщательного планирования и тестирования.

### Ключевые моменты:

- CSP действует как белый список разрешенных источников контента
- Поддерживает несколько уровней (CSP1, CSP2, CSP3)
- Позволяет отправлять отчеты о нарушениях для отладки
- Должна внедряться постепенно с использованием режима отчета
- Наиболее эффективна в комплексе с другими мерами безопасности

CSP — важная часть стратегии безопасности веб-приложения, особенно в условиях растущего числа атак, направленных на клиентскую часть приложений.