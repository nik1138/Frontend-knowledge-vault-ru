---
aliases: [Формирование политики CSP, Создание CSP политики, Разработка CSP]
tags: [security, csp, content-security-policy, web-security]
---

# Формирование-CSP-политики

## Обзор

Формирование CSP (Content Security Policy) политики - это процесс разработки и настройки политики безопасности контента, которая определяет, какие ресурсы может загружать и выполнять веб-приложение. Правильно сформированная CSP политика является эффективным средством защиты от XSS, кликджекинга и других атак, связанных с внедрением контента.

## Принципы формирования CSP политики

### 1. Принцип наименьших привилегий
- Разрешайте только те ресурсы, которые действительно необходимы
- Минимизируйте использование 'unsafe-inline' и 'unsafe-eval'
- Используйте максимально конкретные источники

### 2. Поэтапное усиление
- Начинайте с более широкой политики
- Постепенно ограничивайте разрешения на основе анализа
- Используйте режим отчетности для выявления проблем

### 3. Поддержка и обновление
- Периодически пересматривайте политику
- Обновляйте при добавлении новых функций
- Адаптируйте под изменения в зависимостях

## Компоненты CSP политики

### 1. Директивы безопасности
- `default-src` - базовая политика для всех ресурсов
- `script-src` - источники скриптов
- `style-src` - источники стилей
- `img-src` - источники изображений
- `connect-src` - источники для AJAX, WebSocket
- `font-src` - источники шрифтов
- `media-src` - источники аудио/видео
- `frame-src` - источники для iframe
- `object-src` - источники для плагинов
- `base-uri` - разрешенные URI для тега base
- `form-action` - разрешенные действия для форм
- `frame-ancestors` - разрешенные домены для встраивания

### 2. Ключевые слова и модификаторы
- `'self'` - тот же источник
- `'none'` - запрет всех источников
- `'unsafe-inline'` - разрешение inline-кода
- `'unsafe-eval'` - разрешение eval-подобных функций
- `'strict-dynamic'` - динамическая политика для скриптов
- `'nonce-<value>'` - разрешение по одноразовому коду
- `'sha256-<hash>'` - разрешение по хэшу

## Процесс формирования политики

### Этап 1: Инвентаризация ресурсов
1. **Анализ всех источников контента**:
   - Скрипты (внутренние и внешние)
   - Стили
   - Изображения
   - Шрифты
   - AJAX-запросы
   - Встраиваемый контент

2. **Идентификация inline-элементов**:
   - Inline-скрипты
   - Inline-стили
   - Обработчики событий
   - Встроенные стили

3. **Анализ внешних зависимостей**:
   - CDN
   - Внешние API
   - Третьи стороны (аналитика, реклама)

### Этап 2: Разработка начальной политики
```javascript
// Пример начальной политики для анализа
const initialPolicy = [
  "default-src 'self'",
  "script-src 'self' 'unsafe-inline'",
  "style-src 'self' 'unsafe-inline'",
  "img-src 'self' data: https:",
  "font-src 'self'",
  "connect-src 'self'",
  "report-uri /csp-report"
].join('; ');
```

### Этап 3: Тестирование в режиме отчетности
```
Content-Security-Policy-Report-Only: default-src 'self'; script-src 'self' 'unsafe-inline'; report-uri /csp-report
```

### Этап 4: Анализ отчетов и уточнение политики
- Сбор и анализ отчетов о нарушениях
- Идентификация легитимных источников
- Постепенное удаление небезопасных разрешений

### Этап 5: Внедрение и мониторинг
- Перевод в режим исполнения (enforce)
- Постоянный мониторинг нарушений
- Периодическое обновление политики

## Практические примеры формирования политик

### Пример 1: Политика для корпоративного веб-приложения
```
default-src 'self';
script-src 'self' 'unsafe-inline' https://cdn.example.com;
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
img-src 'self' data: https:;
font-src 'self' https://fonts.gstatic.com;
connect-src 'self' https://api.example.com;
frame-ancestors 'none';
base-uri 'self';
report-uri /csp-report
```

### Пример 2: Строгая политика для SPA
```
default-src 'none';
script-src 'self' 'nonce-abc123def456';
style-src 'self' 'sha256-abc123...';
img-src 'self' data: blob:;
font-src 'self';
connect-src 'self';
frame-ancestors 'none';
base-uri 'self';
form-action 'self'
```

### Пример 3: Политика для публичного сайта с внешними ресурсами
```
default-src 'self';
script-src 'self' 'unsafe-inline' https://www.google-analytics.com https://apis.google.com;
style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
img-src 'self' data: https:;
font-src 'self' https://fonts.gstatic.com;
connect-src 'self' https://api.example.com;
frame-src https://www.youtube.com;
report-uri /csp-report
```

## Работа с различными типами контента

### Inline-скрипты и стили
Вместо `'unsafe-inline'`, используйте:
- **Nonce** для динамических скриптов:
  ```
  script-src 'nonce-abc123' 'self';
  ```
- **Hash** для статических скриптов:
  ```
  script-src 'sha256-abc123...' 'self';
  ```

### Внешние CDN
- Указывайте конкретные домены
- Используйте HTTPS для внешних источников
- Рассмотрите возможность локального хранения критичных ресурсов

### API-запросы
- Разрешайте только необходимые домены для connect-src
- Используйте конкретные пути, если возможно
- Ограничивайте методы, если применимо

## Современные подходы к формированию CSP

### 1. Strict Dynamic
Для сложных приложений с динамическими скриптами:
```
script-src 'strict-dynamic' 'nonce-abc123';
```

### 2. Hash-based CSP
Для приложений с небольшим количеством inline-контента:
```
script-src 'sha256-abc123def456...' 'self';
```

### 3. Nonce-based CSP
Для динамических приложений:
```
script-src 'nonce-abc123def456' 'self';
```

## Инструменты для формирования CSP

### 1. Автоматические генераторы
- CSP Evaluator (Google)
- Report URI CSP Generator
- Helmet.js для Node.js

### 2. Анализаторы
- CSP Auditor (браузерное расширение)
- Security headers scanner
- OWASP ZAP CSP module

### 3. Встроенные решения
- Helmet.js для Express.js:
  ```javascript
  const helmet = require('helmet');
  app.use(helmet.contentSecurityPolicy({
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'"],
      styleSrc: ["'self'"]
    }
  }));
  ```

## Обработка сложных случаев

### 1. Совместимость с библиотеками
- Некоторые библиотеки требуют `'unsafe-eval'` (например, Angular)
- Используйте специфические политики для таких случаев
- Рассмотрите альтернативы, если возможно

### 2. Web Workers
```javascript
// Для разрешения Web Workers
const policy = "default-src 'self'; worker-src 'self'; script-src 'self'";
```

### 3. JSONP и другие legacy-методы
- Используйте `script-src` с конкретными доменами
- Рассмотрите переход на современные альтернативы

## Тестирование и валидация политики

### 1. Проверка синтаксиса
- Используйте онлайн-валидаторы CSP
- Проверяйте совместимость с браузерами
- Тестируйте в разных окружениях

### 2. Функциональное тестирование
- Проверяйте все функции приложения
- Тестируйте в разных браузерах
- Проверяйте работу с отключенными скриптами

### 3. Пентест CSP
- Проверяйте возможность обхода политики
- Тестируйте на устойчивость к атакам
- Проверяйте обработку отчетов

## Обновление и обслуживание политики

### 1. Периодический аудит
- Проверяйте актуальность политики
- Удаляйте неиспользуемые разрешения
- Укрепляйте политику при возможности

### 2. Мониторинг изменений
- Отслеживайте изменения в зависимостях
- Обновляйте политику при добавлении новых функций
- Анализируйте отчеты о нарушениях

### 3. Документирование
- Фиксируйте причины разрешения определенных источников
- Документируйте изменения политики
- Поддерживайте актуальную документацию

## Лучшие практики формирования CSP

1. **Начинайте с report-only режима** - тестируйте политику без блокировки функций
2. **Используйте максимально строгие политики** - минимизируйте разрешения
3. **Регулярно обновляйте политику** - адаптируйте под изменения в приложении
4. **Используйте nonce или hash вместо 'unsafe-inline'** - обеспечьте безопасность inline-контента
5. **Тестируйте в разных браузерах** - обеспечьте совместимость
6. **Анализируйте отчеты о нарушениях** - используйте данные для улучшения политики
7. **Документируйте политику** - обеспечьте понимание политик всеми членами команды

## Связанные темы

- [[Директивы-CSP]]
- [[Реализация-CSP]]
- [[Оценка-CSP]]
- [[Отчеты-о-нарушениях-CSP]]

> [!tip] Совет
> Используйте автоматизированные инструменты для генерации и анализа CSP политик, но всегда проверяйте результаты вручную перед внедрением.

> [!warning] Важно
> CSP политика должна быть частью комплексного подхода к безопасности, а не единственным средством защиты.