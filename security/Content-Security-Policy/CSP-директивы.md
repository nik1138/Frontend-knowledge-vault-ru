---
aliases: [Content Security Policy directives, CSP directives, CSP rules]
tags: [security, web-security, csp, directives, protection]
---

# CSP-директивы

## Введение в CSP директивы

Content Security Policy (CSP) - это важный механизм безопасности, который позволяет веб-разработчикам контролировать ресурсы, которые могут быть загружены или выполнены на их веб-сайте. CSP директивы являются основными строительными блоками политики безопасности, определяющими, какие источники контента разрешены для загрузки и выполнения в контексте веб-страницы.

## Что такое Content Security Policy

Content Security Policy (CSP) - это дополнительный уровень защиты, который помогает обнаруживать и смягчать определенные типы атак, включая межсайтовый скриптинг (XSS) и clickjacking. CSP позволяет веб-приложениям объявлять политику разрешений для контента, который может быть загружен и выполнен в контексте сайта.

> [!info] Полезно знать
> CSP реализуется через HTTP-заголовки ответа или через тег `<meta>` в HTML-документе. Это позволяет браузеру строго контролировать, какие ресурсы могут быть загружены и выполнены на странице.

## Основные директивы CSP

CSP состоит из различных директив, каждая из которых контролирует определенный тип контента. Ниже приведены основные директивы:

### default-src
Директива `default-src` определяет политику по умолчанию для всех контентных директив, если они не указаны явно. Это основная политика, которая применяется ко всем ресурсам, если для них не установлена более конкретная директива.

**Пример:**
```
Content-Security-Policy: default-src 'self';
```

### script-src
Директива `script-src` определяет, какие источники разрешены для выполнения скриптов. Это одна из самых важных директив для предотвращения XSS-атак.

**Пример:**
```
Content-Security-Policy: script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com;
```

### style-src
Директива `style-src` контролирует источники для CSS-стилей, включая inline-стили и импортированные стили.

**Пример:**
```
Content-Security-Policy: style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
```

### img-src
Директива `img-src` определяет, какие источники разрешены для загрузки изображений.

**Пример:**
```
Content-Security-Policy: img-src 'self' data: https://*.example.com;
```

### font-src
Директива `font-src` контролирует источники для загрузки веб-шрифтов.

**Пример:**
```
Content-Security-Policy: font-src 'self' https://fonts.gstatic.com;
```

### connect-src
Директива `connect-src` определяет, какие источники разрешены для соединений, таких как AJAX, WebSocket и EventSource.

**Пример:**
```
Content-Security-Policy: connect-src 'self' https://api.example.com;
```

### media-src
Директива `media-src` контролирует источники для аудио и видео контента.

**Пример:**
```
Content-Security-Policy: media-src 'self' https://videos.example.com;
```

### object-src
Директива `object-src` определяет источники для плагинов, таких как Flash, Java и другие.

**Пример:**
```
Content-Security-Policy: object-src 'none';
```

### frame-src
Директива `frame-src` контролирует источники, которые могут быть встроены в фреймы.

**Пример:**
```
Content-Security-Policy: frame-src 'self' https://trusted-embed.com;
```

### frame-ancestors
Директива `frame-ancestors` контролирует, какие домены могут встраивать текущую страницу в свои фреймы (защита от clickjacking).

**Пример:**
```
Content-Security-Policy: frame-ancestors 'self' https://trusted-site.com;
```

### base-uri
Директива `base-uri` определяет разрешенные источники для тега `<base>`.

**Пример:**
```
Content-Security-Policy: base-uri 'self';
```

### form-action
Директива `form-action` контролирует, на какие URL-адреса могут отправляться формы.

**Пример:**
```
Content-Security-Policy: form-action 'self' https://payment.example.com;
```

## Значения директив

Каждая CSP директива может принимать различные значения, определяющие разрешенные источники:

### 'self'
Значение `'self'` позволяет загружать ресурсы с текущего домена, протокола и порта.

**Пример:**
```
script-src 'self';
```

### 'none'
Значение `'none'` запрещает загрузку соответствующего типа ресурсов.

**Пример:**
```
object-src 'none';
```

### 'unsafe-inline'
Значение `'unsafe-inline'` позволяет использовать inline-скрипты и inline-стили. Это потенциальная угроза безопасности, так как делает приложение уязвимым к XSS-атакам.

**Пример:**
```
style-src 'self' 'unsafe-inline';
```

### 'unsafe-eval'
Значение `'unsafe-eval'` позволяет использовать функции, которые выполняют строки как код (например, `eval()`, `Function()`, `setTimeout()` с строкой и т.д.). Это также потенциальная угроза безопасности.

**Пример:**
```
script-src 'self' 'unsafe-eval';
```

### 'unsafe-hashes'
Значение `'unsafe-hashes'` позволяет использовать inline-скрипты и стили, если они соответствуют определенным хешам.

**Пример:**
```
script-src 'self' 'unsafe-hashes' 'sha256-abc123...';
```

### 'strict-dynamic'
Значение `'strict-dynamic'` позволяет использовать динамическую загрузку скриптов, если они происходят из доверенного скрипта.

**Пример:**
```
script-src 'self' 'strict-dynamic' 'nonce-abc123';
```

### URL-адреса
Можно указать конкретные URL-адреса или домены как разрешенные источники.

**Пример:**
```
script-src 'self' https://cdnjs.cloudflare.com;
```

### Wildcards
Можно использовать символ `*` для обозначения поддоменов.

**Пример:**
```
img-src 'self' https://*.example.com;
```

## Примеры применения директив

### Простая политика безопасности
```
Content-Security-Policy: default-src 'self';
```
Эта политика разрешает загрузку всех ресурсов только с текущего домена.

### Политика с разрешением внешних скриптов и стилей
```
Content-Security-Policy: default-src 'self'; script-src 'self' https://cdnjs.cloudflare.com; style-src 'self' https://fonts.googleapis.com;
```
Эта политика позволяет загружать скрипты с cdnjs и шрифты с Google Fonts.

### Политика с запретом на встраивание фреймов
```
Content-Security-Policy: default-src 'self'; frame-ancestors 'none';
```
Эта политика полностью запрещает встраивание страницы в фреймы на других сайтах.

### Политика для веб-приложения с API
```
Content-Security-Policy: default-src 'self'; connect-src 'self' https://api.example.com; img-src 'self' data: https://cdn.example.com;
```
Эта политика разрешает соединения с API и загрузку изображений с CDN.

## Совместимость с браузерами

CSP поддерживается всеми современными браузерами:

### Полная поддержка CSP Level 2:
- Chrome 40+
- Firefox 31+
- Safari 10+
- Edge 15+
- Opera 27+

### Полная поддержка CSP Level 3:
- Chrome 59+
- Firefox 58+
- Safari 11+
- Edge 79+
- Opera 46+

> [!warning] Важно
> Не все браузеры поддерживают все директивы CSP. Всегда проверяйте совместимость при реализации. Некоторые директивы могут иметь ограниченную поддержку или требовать флаги для включения.

## Тонкости реализации

### Постепенное внедрение
Рекомендуется начинать с режима отчета, чтобы понять, как политика повлияет на ваше приложение:

```
Content-Security-Policy-Report-Only: default-src 'self'; report-uri /csp-report-endpoint;
```

### Использование Nonce и Hash
Для разрешения конкретных inline-скриптов можно использовать nonce или хеши:

**С использованием nonce:**
```
Content-Security-Policy: script-src 'nonce-abc123';
```
```html
<script nonce="abc123">alert('Hello');</script>
```

**С использованием хеша:**
```
Content-Security-Policy: script-src 'sha256-abc123...';
```
```html
<script>alert('Hello');</script>
```

### Работа с CDN и внешними ресурсами
При использовании CDN необходимо указать точные домены и протоколы:

```
script-src 'self' https://cdn.example.com; style-src 'self' https://fonts.googleapis.com;
```

### Работа с WebSocket
Для соединений WebSocket используйте директиву `connect-src`:

```
connect-src 'self' wss://ws.example.com;
```

## Ошибки при реализации

### Нарушение политики при использовании inline-скриптов
**Проблема:** Использование inline-скриптов без разрешения
**Решение:** Используйте хеши, nonce или перенесите скрипты во внешние файлы

### Нарушение политики при использовании eval()
**Проблема:** Использование функций, которые выполняют строки как код
**Решение:** Избегайте использования eval() и подобных функций

### Нарушение политики при загрузке ресурсов с CDN
**Проблема:** Загрузка ресурсов с неразрешенных источников
**Решение:** Укажите точные домены CDN в соответствующих директивах

### Неправильная настройка frame-ancestors
**Проблема:** Непреднамеренное встраивание страницы на других сайтах
**Решение:** Используйте директиву `frame-ancestors` с подходящими значениями

## Рекомендации по настройке

### 1. Начинайте с простого
Начните с базовой политики и постепенно усложняйте:

```
Content-Security-Policy: default-src 'self';
```

### 2. Используйте отчеты
Настройте систему отчетов о нарушениях для выявления проблем:

```javascript
// Пример обработчика отчетов CSP
app.post('/csp-violation-report', (req, res) => {
  console.log('CSP Violation:', req.body);
  res.status(204).end();
});
```

### 3. Регулярное обновление политики
Периодически пересматривайте и обновляйте политику в соответствии с изменениями в приложении.

### 4. Тестирование на различных устройствах
Проверяйте политику на разных устройствах и браузерах, особенно если ваше приложение должно работать в различных окружениях.

### 5. Использование строгой политики для продакшена
Для продакшена рекомендуется использовать максимально строгую политику, которая не позволяет небезопасные источники.

## Практические примеры

### Пример для SPA приложения
```
Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https://api.example.com; img-src 'self' data: https://cdn.example.com;
```

### Пример для статического сайта
```
Content-Security-Policy: default-src 'self'; script-src 'self'; style-src 'self'; img-src 'self' data:; font-src 'self'; connect-src 'none'; object-src 'none'; frame-ancestors 'none';
```

### Пример для сайта с внешними виджетами
```
Content-Security-Policy: default-src 'self'; script-src 'self' https://widget.example.com; frame-src https://trusted-embed.com; img-src 'self' https://*.example.com data:; style-src 'self' 'unsafe-inline';
```

### Пример для API-ориентированного приложения
```
Content-Security-Policy: default-src 'self'; connect-src 'self' https://api.example.com https://auth.example.com; script-src 'self' 'nonce-abc123'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob:;
```

## Аудит CSP

### Ручной аудит
Проверьте все ресурсы, загружаемые на странице, и убедитесь, что они соответствуют политике CSP.

### Автоматизированный аудит
Используйте инструменты для автоматического анализа CSP политики:

- CSP Evaluator от Google
- CSP Validator
- Browser Developer Tools

### Анализ отчетов о нарушениях
Регулярно анализируйте отчеты о нарушениях CSP, чтобы выявлять проблемы и улучшать политику.

### Проверка на уязвимости
Проверьте, не делает ли ваша политика CSP приложение уязвимым к XSS или другим атакам.

## Инструменты для анализа CSP

### CSP Evaluator
Инструмент от Google, который анализирует политику CSP и выявляет потенциальные проблемы безопасности.

### Browser Developer Tools
Современные браузеры предоставляют информацию о нарушениях CSP в консоли разработчика.

### CSP Validator
Онлайн-инструменты для проверки синтаксиса и семантики CSP политик.

### Custom CSP Reporting
Создание собственной системы отчетов о нарушениях CSP для получения информации о проблемах в продакшене.

### Puppeteer/Selenium тесты
Автоматизированные тесты, которые могут обнаруживать нарушения CSP в различных сценариях использования.

## Улучшение CSP со временем

### Начальная политика
Начните с менее строгой политики, чтобы избежать проблем с функциональностью приложения.

### Постепенное усиление
Постепенно ужесточайте политику, устраняя небезопасные источники и используя более безопасные альтернативы.

### Использование Report-Only режима
Используйте режим `Content-Security-Policy-Report-Only` для тестирования новых политик без влияния на пользователей.

### Регулярный пересмотр
Регулярно пересматривайте политику в соответствии с изменениями в приложении и лучшими практиками безопасности.

### Обновление в соответствии с новыми угрозами
Следите за новыми угрозами безопасности и обновляйте политику соответствующим образом.

## Связанные файлы

- [[Content-Security-Policy]] - основная информация о CSP и защите от clickjacking
- [[XSS-защита]] - защита от межсайтового скриптинга
- [[HTTPS-безопасность]] - безопасность на уровне протокола
- [[CORS-политика]] - политика кросс-доменных запросов
- [[CSP-отчеты]] - система отчетов о нарушениях CSP
- [[Web-безопасность-основы]] - основы веб-безопасности
- [[Защита-от-Clickjacking]] - защита от clickjacking атак
- [[HTTP-заголовки-безопасности]] - другие важные заголовки безопасности
- [[OWASP-Top-10]] - топ-10 уязвимостей веб-приложений
- [[CSRF-защита]] - защита от подделки межсайтовых запросов
- [[Secure-Coding-Practices]] - безопасное программирование
- [[Feature-Policy]] - политика использования браузерных возможностей
- [[Subresource-Integrity]] - целостность подресурсов
- [[Secure-Storage]] - безопасное хранение данных
- [[Dependency-Security]] - безопасность зависимостей