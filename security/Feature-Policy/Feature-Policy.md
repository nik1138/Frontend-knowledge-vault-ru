---
aliases: [Feature Policy, Политика функций]
tags: [security, web-security, browser-security, feature-policy]
---

# Feature Policy (Политика функций)

## Введение в Feature Policy

Feature Policy (ранее известная как Feature Policy HTTP Header) - это механизм безопасности веб-браузеров, который позволяет веб-разработчикам контролировать доступ к различным API и функциям браузера. Эта политика дает разработчикам возможность явно разрешать или запрещать использование определенных функций как для собственного, так и для стороннего контента.

## Что такое Feature Policy и зачем она нужна

Feature Policy - это механизм, который позволяет веб-разработчикам ограничивать доступ к определенным API и функциям браузера, таким как камера, микрофон, геолокация, ускорометр и другие. Она была разработана для повышения безопасности и конфиденциальности пользователей, позволяя разработчикам явно контролировать, какие функции могут использоваться на веб-странице.

### Зачем нужна Feature Policy?

- **Контроль над функциями**: Разработчики могут контролировать, какие API и функции могут использоваться на их сайте
- **Улучшение безопасности**: Ограничение доступа к чувствительным API снижает риски безопасности
- **Конфиденциальность пользователей**: Предотвращение несанкционированного доступа к персональным данным
- **Управление ресурсами**: Контроль над ресурсоемкими функциями для улучшения производительности
- **Совместимость с фреймами**: Контроль доступа к функциям в iframe и вложенных контентах

## Отличие от других политик безопасности

Feature Policy отличается от других политик безопасности следующими аспектами:

| Политика | Назначение | Особенности |
|----------|------------|-------------|
| [[Content-Security-Policy]] | Контроль источников загрузки ресурсов и выполнения скриптов | Ограничивает источники загрузки скриптов, стилей, изображений и т.д. |
| Feature Policy | Контроль доступа к API и функциям браузера | Управляет использованием таких функций, как камера, микрофон, геолокация |
| [[HTTP-Security-Headers]] | Защита через HTTP-заголовки | Включает такие заголовки, как X-Frame-Options, X-Content-Type-Options и др. |

В отличие от [[Content-Security-Policy]], которая контролирует, откуда можно загружать ресурсы и какие скрипты выполнять, Feature Policy фокусируется на том, какие функции браузера могут быть использованы и каким контентом. Она предоставляет более тонкий контроль над конкретными API и возможностями устройства.

## Синтаксис и формат

Feature Policy использует HTTP-заголовок `Permissions-Policy` (новое название для Feature-Policy) с определенным синтаксисом:

```
Permissions-Policy: <directive>=<allowlist>
```

### Формат директивы

- **directive** - имя функции (например, geolocation, camera, microphone)
- **allowlist** - список разрешений, определяющий, где может использоваться функция

### Типы разрешений

- `*` - функция разрешена для всех источников (по умолчанию для многих функций)
- `'self'` - функция разрешена только для текущего источника
- `'none'` - функция полностью запрещена
- `"src1" "src2"` - список конкретных источников, которым разрешено использовать функцию
- `* "src1"` - разрешено для всех, кроме указанных источников

### Примеры форматов

```
Permissions-Policy: geolocation=(self "https://trusted-site.com")
Permissions-Policy: camera=(self), microphone=*
Permissions-Policy: fullscreen=*, payment=()
```

## Поддерживаемые функции

Feature Policy поддерживает множество различных функций браузера. Вот основные из них:

### Основные функции

- **geolocation** - доступ к геолокации пользователя
- **camera** - доступ к камере устройства
- **microphone** - доступ к микрофону устройства
- **autoplay** - автоматическое воспроизведение медиа
- **fullscreen** - переход в полноэкранный режим
- **payment** - API для платежей
- **sync-xhr** - синхронные XMLHttpRequest
- **web-share** - API для веб-шаринга

### Функции датчиков

- **accelerometer** - доступ к акселерометру
- **gyroscope** - доступ к гироскопу
- **magnetometer** - доступ к магнитометру
- **ambient-light-sensor** - доступ к датчику освещенности

### Функции экрана и отображения

- **display-capture** - захват экрана
- **screen-wake-lock** - предотвращение перехода в спящий режим
- **picture-in-picture** - режим "картинка в картинке"

### Функции взаимодействия

- **clipboard-read** - чтение из буфера обмена
- **clipboard-write** - запись в буфер обмена
- **gamepad** - доступ к контроллерам игр
- **notifications** - уведомления

### Функции хранения и синхронизации

- **storage-access** - доступ к хранилищу данных
- **sync-script** - синхронные скрипты
- **document-domain** - изменение домена документа

## Заголовки и метатеги Feature Policy

### HTTP-заголовок Permissions-Policy

```
Permissions-Policy: geolocation=(self), camera=(), microphone=(self "https://trusted-audio.com")
```

### Метатег (устаревший способ)

Хотя метатеги для Feature Policy устарели, важно понимать, как они выглядели:

```html
<meta http-equiv="Permissions-Policy" content="geolocation=(self), camera=(), microphone=*">
```

> [!warning] Важно
> Метатеги для Feature Policy больше не поддерживаются современными браузерами. Используйте только HTTP-заголовки.

### Заголовки для iframe

Для управления политикой в iframe используется специальный атрибут:

```html
<iframe src="https://example.com" allow="geolocation 'self'; camera 'none'; microphone *"></iframe>
```

## Примеры использования

### Простой пример: ограничение доступа к камере

```
Permissions-Policy: camera=(self)
```

Этот заголовок разрешает доступ к камере только для текущего домена, запрещая сторонним iframe использовать камеру.

### Пример с несколькими политиками

```
Permissions-Policy: geolocation=(self "https://api.map.com"), 
                   camera=(), 
                   microphone=(self), 
                   autoplay=(self "https://trusted-video.com")
```

### Пример для iframe с разрешенными функциями

```html
<iframe src="https://example.com" 
        allow="geolocation 'self'; 
               camera 'none'; 
               microphone https://trusted-audio.com; 
               autoplay *">
</iframe>
```

### Пример блокировки чувствительных функций

```
Permissions-Policy: accelerometer=(), 
                   gyroscope=(), 
                   magnetometer=(), 
                   ambient-light-sensor=()
```

Этот заголовок блокирует доступ ко всем датчикам устройства, что особенно важно для защиты конфиденциальности.

## Совместимость с браузерами

Feature Policy (теперь Permissions Policy) поддерживается большинством современных браузеров:

| Браузер | Поддержка | Комментарий |
|---------|-----------|-------------|
| Chrome | С 60 версии | Полная поддержка |
| Firefox | С 74 версии | Частичная поддержка некоторых функций |
| Safari | С 15.4 | Ограниченная поддержка |
| Edge | С 79 версии | Полная поддержка (на основе Chromium) |
| Opera | С 47 версии | Полная поддержка |

> [!tip] Совет
> Всегда проверяйте совместимость конкретных функций на [Can I Use](https://caniuse.com/) и [MDN](https://developer.mozilla.org/), так как поддержка отдельных функций может отличаться.

## Практические сценарии

### Сценарий 1: Веб-приложение с видеоконференциями

Для приложения видеоконференций может потребоваться следующая политика:

```
Permissions-Policy: camera=(self "https://trusted-cdn.com"), 
                   microphone=(self "https://trusted-cdn.com"), 
                   display-capture=(self), 
                   fullscreen=*
```

Это разрешает использование камеры и микрофона только для основного домена и доверенного CDN, а также позволяет захватывать экран и переходить в полноэкранный режим.

### Сценарий 2: Публичный веб-сайт с формами

Для публичного сайта без необходимости в чувствительных API:

```
Permissions-Policy: geolocation=(), 
                   camera=(), 
                   microphone=(), 
                   payment=(), 
                   sync-xhr=()
```

### Сценарий 3: Игровое приложение

Для игрового приложения может потребоваться доступ к датчикам:

```
Permissions-Policy: accelerometer=(self), 
                   gyroscope=(self), 
                   magnetometer=(self), 
                   fullscreen=*, 
                   gamepad=(self)
```

## Ограничения и подводные камни

### Ограничения

1. **Ограниченная поддержка в старых браузерах** - не все браузеры поддерживают все функции
2. **Сложность отладки** - ошибки могут быть неочевидными
3. **Влияние на сторонние виджеты** - некоторые сторонние компоненты могут перестать работать

### Распространенные ошибки

1. **Неправильный синтаксис** - даже небольшая ошибка в синтаксисе может привести к тому, что политика будет проигнорирована
2. **Слишком строгие ограничения** - может сломать функциональность сайта
3. **Несовместимость с CDN** - сторонние ресурсы могут быть заблокированы

### Подводные камни

> [!warning] Важно
> Feature Policy может конфликтовать с [[Content-Security-Policy]] и другими заголовками безопасности. Всегда тестируйте комплексно.

- Заголовки могут конфликтовать с [[CSP]] и другими политиками безопасности
- Некоторые функции могут быть недоступны в определенных контекстах (например, в iframe)
- Политика применяется только к будущим запросам, а не к уже загруженным ресурсам

## Тестирование Feature Policy

### Тестирование в браузере

1. Проверьте заголовки ответа сервера с помощью инструментов разработчика
2. Попробуйте вызвать API, которые должны быть ограничены
3. Используйте инструменты DevTools для проверки ошибок

### Пример тестирования

```javascript
// Попытка доступа к геолокации
navigator.geolocation.getCurrentPosition(
  (position) => {
    console.log('Геолокация доступна:', position);
  },
  (error) => {
    console.log('Ошибка геолокации:', error.message);
    // Если политика запрещает, будет ошибка
  }
);
```

### Автоматизированное тестирование

Для автоматизированного тестирования можно использовать:

- Selenium WebDriver для проверки поведения в браузере
- Puppeteer/Playwright для автоматизации сценариев
- Проверку HTTP-заголовков на соответствие ожидаемой политике

## Лучшие практики

### 1. Начинайте с минимальных разрешений

Начинайте с максимально ограниченной политики и постепенно добавляйте разрешения по мере необходимости:

```
Permissions-Policy: camera=(), microphone=(), geolocation=()
```

### 2. Используйте конкретные источники

Вместо разрешения для всех источников, указывайте конкретные доверенные источники:

```
Permissions-Policy: camera=(self "https://cdn.example.com")
```

### 3. Регулярный аудит политик

Регулярно пересматривайте и обновляйте политики безопасности:

- Удаляйте неиспользуемые разрешения
- Обновляйте список доверенных источников
- Проверяйте совместимость с новыми версиями браузеров

### 4. Тестирование в разных окружениях

Тестируйте политики в различных условиях:

- Разные браузеры и версии
- Разные устройства и ОС
- В разных контекстах (iframe, PWA и т.д.)

### 5. Документирование политик

Документируйте, почему были приняты те или иные решения по политике:

```markdown
# Permissions Policy для example.com

## Обоснование

- camera=(self) - необходима для функции профиля пользователя
- geolocation=(self) - используется для определения языка интерфейса
- microphone=() - явно запрещен для защиты конфиденциальности
```

## Связанные темы

- [[Content-Security-Policy]] - политика безопасности контента
- [[HTTP-Security-Headers]] - основные заголовки безопасности
- [[CSP]] - подробное руководство по Content Security Policy
- [[Безопасность-в-браузере]] - общие аспекты безопасности в браузере
- [[Безопасность-в-веб-приложениях-с-офлайн-режимом]] - особенности безопасности в оффлайн-приложениях
- [[Безопасность-в-веб-приложениях-с-поддержкой-камеры-и-микрофона]] - специфические аспекты работы с медиаустройствами
- [[Безопасность-при-работе-с-геолокацией]] - особенности работы с геолокационными данными
- [[Secure-Coding-Practices]] - лучшие практики безопасного программирования
- [[XSS-защита]] - защита от межсайтового скриптинга
- [[CSRF-защита]] - защита от подделки межсайтовых запросов