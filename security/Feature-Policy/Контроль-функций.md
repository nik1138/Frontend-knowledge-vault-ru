---
aliases: ["Контроль функций", "Feature Control"]
tags: [security, feature-policy, web-security, browser-security]
---

# Контроль функций

Контроль функций - это механизм, позволяющий веб-разработчикам ограничивать и управлять доступом к различным браузерным API и функциям. Этот подход является важной частью комплексной стратегии безопасности веб-приложений, позволяя уменьшить атакующую поверхность и защитить пользователей от потенциальных угроз.

## Введение в контроль функций

Контроль функций позволяет разработчикам явно указывать, какие браузерные функции могут быть использованы на веб-странице. Это особенно важно в современных веб-приложениях, где доступ к мощным API может быть использован злоумышленниками для атак или нарушения конфиденциальности пользователей.

Механизмы контроля функций включают:
- Feature Policy (Permission Policy)
- Content Security Policy (CSP)
- Referrer Policy
- Document Policy (в разработке)

## Основные принципы контроля функций

### Принцип наименьших привилегий

Принцип наименьших привилегий требует предоставления только минимально необходимых прав доступа к функциям. Это снижает риск эксплуатации уязвимостей и уменьшает потенциальный ущерб в случае компрометации.

### Дифференцированный доступ

Разные части приложения могут иметь разные уровни доступа к функциям в зависимости от их доверия и требований безопасности.

### Контроль по происхождению

Контроль функций может различаться в зависимости от источника (origin) контента, что позволяет безопасно встраивать контент из доверенных источников.

## Реализации контроля функций

### Feature Policy (Permission Policy)

Feature Policy позволяет контролировать доступ к различным браузерным функциям:

```http
Feature-Policy: camera 'none'; microphone 'self'; geolocation 'self' https://trusted.com
```

### Content Security Policy

CSP может ограничивать использование некоторых функций через директивы:

```http
Content-Security-Policy: 
  default-src 'self';
  media-src 'self' https://trusted-media.com;
  connect-src 'self' https://api.trusted.com
```

### Document Policy

Document Policy - это новая спецификация, позволяющая контролировать низкоуровневые функции браузера:

```http
Document-Policy: oversized-images: deny; strict-origin-beacons: allow
```

## Контролируемые функции

### Аудио и видео функции

- `microphone` - доступ к микрофону
- `camera` - доступ к камере
- `speaker` - доступ к динамикам
- `display-capture` - захват экрана
- `autoplay` - автовоспроизведение медиа

### Сенсоры и геолокация

- `geolocation` - доступ к геолокации
- `accelerometer` - акселерометр
- `gyroscope` - гироскоп
- `magnetometer` - магнитометр
- `ambient-light-sensor` - датчик освещенности

### Устройства и периферия

- `usb` - доступ к USB-устройствам
- `serial` - доступ к последовательным портам
- `bluetooth` - Bluetooth-устройства
- `hid` - HID-устройства

### Платежи и безопасность

- `payment` - платежные функции
- `encrypted-media` - зашифрованные медиа
- `clipboard-read` - чтение из буфера обмена
- `clipboard-write` - запись в буфер обмена

### Другие функции

- `fullscreen` - полноэкранный режим
- `sync-xhr` - синхронные XMLHttpRequest
- `notifications` - уведомления
- `push` - push-уведомления

## Практические примеры контроля функций

### Запрет всех чувствительных функций

```http
Feature-Policy: 
  camera 'none';
  microphone 'none';
  geolocation 'none';
  accelerometer 'none';
  gyroscope 'none';
  magnetometer 'none';
  usb 'none';
  payment 'none'
```

### Разрешение функций только для доверенных источников

```http
Feature-Policy: 
  geolocation 'self' https://trusted-location.com;
  camera 'self';
  microphone 'self';
  payment 'self' https://trusted-payment.com
```

### Контроль функций в iframe

```html
<iframe 
  src="https://third-party.com" 
  allow="geolocation 'self'; camera 'none'; microphone 'none'">
</iframe>
```

## Контроль функций для разных контекстов

### Основной документ

Для основного документа политики могут быть заданы через HTTP-заголовки или теги `<meta>`:

```html
<meta http-equiv="Feature-Policy" content="camera 'none'; microphone 'self'">
```

### Встроенные фреймы

Для iframe контроль функций особенно важен, так как содержимое может происходить из ненадежных источников:

```html
<iframe 
  src="https://external-content.com"
  allow="geolocation 'self'; camera 'none'; microphone 'none'">
</iframe>
```

### Веб-компоненты

При использовании веб-компонентов важно контролировать функции, доступные внутри них:

```javascript
// Пример ограничения функций в Shadow DOM
const shadow = element.attachShadow({mode: 'closed'});
// В Shadow DOM применяются те же политики, что и для основного документа
```

## Лучшие практики контроля функций

### 1. Оценка необходимых функций

Перед настройкой политик определите, какие функции действительно необходимы для работы приложения:

```http
# Только необходимые функции
Feature-Policy: 
  geolocation 'self';
  camera 'self';
  microphone 'self'
```

### 2. Использование принципа наименьших привилегий

Предоставляйте минимально необходимые права:

```http
# Конкретные разрешенные источники вместо универсального доступа
Feature-Policy: 
  payment 'self' https://trusted-payment.com;
  camera 'self'
```

### 3. Регулярный аудит политик

Периодически пересматривайте и обновляйте политики контроля функций:

- Удаляйте ненужные разрешения
- Обновляйте списки доверенных источников
- Проверяйте совместимость с новыми функциями

### 4. Тестирование в разных окружениях

Проверяйте работу приложения с различными политиками в разных браузерах и окружениях.

## Интеграция с другими механизмами безопасности

Контроль функций должен работать в сочетании с другими мерами безопасности:

- [[Content Security Policy]] - для контроля загрузки ресурсов
- [[Subresource Integrity]] - для проверки целостности ресурсов
- [[CORS]] - для контроля междоменных запросов
- [[Referrer Policy]] - для контроля заголовков Referer

## Отладка и мониторинг

### Инструменты разработчика

Браузеры предоставляют инструменты для проверки политик:

- Проверка HTTP-заголовков в Network вкладке
- Консоль разработчика для отображения ошибок политик
- Проверка доступа к функциям в Security вкладке

### Логирование нарушений

Можно настроить логирование нарушений политик:

```javascript
// Пример обработки ошибок доступа к функциям
navigator.geolocation.getCurrentPosition(
  (position) => console.log(position),
  (error) => {
    if (error.code === error.PERMISSION_DENIED) {
      console.log('Geolocation access denied by Feature Policy');
    }
  }
);
```

## Совместимость и поддержка

Разные браузеры могут по-разному поддерживать различные функции контроля. Важно:

- Проверять совместимость с целевыми браузерами
- Предоставлять резервные механизмы для старых браузеров
- Использовать прогрессивное улучшение

## Будущие тенденции

### Новые функции

Разрабатываются новые функции для контроля, включая:
- Document Policy для низкоуровневых функций
- Расширенные возможности контроля для веб-компонентов
- Улучшенные механизмы для контроля машинного обучения и WebAssembly

### Автоматизация

Разрабатываются инструменты для автоматического анализа и генерации политик контроля функций на основе анализа кода приложения.

## Заключение

Контроль функций - важный элемент современной безопасности веб-приложений. Правильная реализация позволяет значительно уменьшить атакующую поверхность и защитить пользователей от потенциальных угроз. Контроль должен быть частью комплексного подхода к безопасности, включающего другие механизмы защиты.

Для дальнейшего изучения рекомендуется ознакомиться с [[Обзор-Feature-Policy]], [[Безопасность-браузерных-функций]] и [[Реализация-Feature-Policy]].

## См. также

- [[Обзор-Feature-Policy]]
- [[Безопасность-браузерных-функций]]
- [[Реализация-Feature-Policy]]
- [[Content Security Policy]]
- [[Permissions API]]

#security #feature-control #web-security #browser-security