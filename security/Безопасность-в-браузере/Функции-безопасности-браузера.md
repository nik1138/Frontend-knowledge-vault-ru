---
aliases: ["Browser Security Features", "Функции безопасности браузера", "Безопасность веб-браузеров"]
tags: [security, browser, web-security, client-side-security]
---

# Функции безопасности браузера

## Обзор

Современные веб-браузеры включают в себя множество встроенных функций безопасности, предназначенных для защиты пользователей от различных видов атак, таких как межсайтовый скриптинг (XSS), межсайтовая подделка запроса (CSRF), кликджекинг и другие. Эти функции работают как на уровне браузера, так и через специальные HTTP-заголовки, которые управляют поведением веб-страниц и защищают конфиденциальные данные пользователей.

## Основные функции безопасности браузера

### 1. Same-Origin Policy (Политика одинакового источника)

Same-Origin Policy - это фундаментальный механизм безопасности, который ограничивает взаимодействие между документами или скриптами из разных источников.

#### Что такое "origin" (источник)

Источник определяется как комбинация:
- **Протокола** (http, https)
- **Домена** (example.com)
- **Порта** (80, 443, 3000 и т.д.)

Примеры:
- `https://example.com:443` и `https://example.com:80` - разные источники
- `https://example.com` и `https://sub.example.com` - разные источники
- `https://example.com` и `http://example.com` - разные источники

```javascript
// Пример нарушения Same-Origin Policy
// Скрипт на https://site-a.com не может получить доступ к данным на https://site-b.com
fetch('https://site-b.com/api/data')
  .then(response => response.json())
  .then(data => console.log(data)) // Это вызовет ошибку CORS
  .catch(error => console.error('Ошибка CORS:', error));
```

### 2. Cross-Origin Resource Sharing (CORS)

CORS - это механизм, который позволяет серверам указывать, какие источники могут получить доступ к их ресурсам.

```javascript
// Пример серверной настройки CORS в Express.js
app.use((req, res, next) => {
  // Разрешаем только определенные источники
  const allowedOrigins = [
    'https://trusted-site.com',
    'https://app.trusted-site.com'
  ];
  
  const origin = req.headers.origin;
  if (allowedOrigins.includes(origin)) {
    res.setHeader('Access-Control-Allow-Origin', origin);
  }
  
  res.setHeader('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  res.setHeader('Access-Control-Allow-Credentials', 'true');
  
  // Предварительные запросы (preflight)
  if (req.method === 'OPTIONS') {
    res.sendStatus(200);
    return;
  }
  
  next();
});
```

### 3. Content Security Policy (CSP)

CSP - это мощный механизм, который помогает предотвратить XSS и другие атаки, контролируя, какие ресурсы могут быть загружены и выполнены.

```javascript
// Пример заголовка CSP
app.use((req, res, next) => {
  res.setHeader('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline' https://trusted-cdn.com; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self'; " +
    "connect-src 'self' https://api.trusted-site.com; " +
    "frame-ancestors 'none'; " + // Защита от кликджекинга
    "base-uri 'self'; " +
    "form-action 'self';"
  );
  next();
});
```

#### CSP директивы:

- `default-src`: Значение по умолчанию для всех директив
- `script-src`: Определяет разрешенные источники для JavaScript
- `style-src`: Определяет разрешенные источники для CSS
- `img-src`: Определяет разрешенные источники для изображений
- `connect-src`: Ограничивает XHR, WebSocket и EventSource подключения
- `frame-ancestors`: Контролирует, где можно встраивать страницу через iframe
- `form-action`: Ограничивает URL, на которые можно отправлять формы

### 4. X-Frame-Options

Заголовок, предотвращающий кликджекинг путем запрета встраивания страницы в iframe.

```javascript
// Примеры X-Frame-Options
app.use((req, res, next) => {
  // Запретить встраивание в iframe с любых сайтов
  res.setHeader('X-Frame-Options', 'DENY');
  
  // Разрешить только с того же домена
  // res.setHeader('X-Frame-Options', 'SAMEORIGIN');
  
  // Разрешить с определенного домена (только в CSP)
  // res.setHeader('X-Frame-Options', 'ALLOW-FROM https://trusted-site.com');
  
  next();
});
```

### 5. X-Content-Type-Options

Предотвращает MIME-типы атак, заставляя браузер придерживаться объявленного типа содержимого.

```javascript
app.use((req, res, next) => {
  // Запретить MIME-type sniffing
  res.setHeader('X-Content-Type-Options', 'nosniff');
  next();
});
```

### 6. X-XSS-Protection

Включает встроенный фильтр XSS в браузере (устаревший, заменен CSP).

```javascript
app.use((req, res, next) => {
  // Включить XSS фильтр
  res.setHeader('X-XSS-Protection', '1; mode=block');
  next();
});
```

### 7. Strict-Transport-Security (HSTS)

Обязывает браузер использовать HTTPS для всех будущих соединений с сайтом.

```javascript
app.use((req, res, next) => {
  res.setHeader('Strict-Transport-Security', 
    'max-age=31536000; includeSubDomains; preload'
  );
  next();
});
```

### 8. Referrer-Policy

Контролирует, какие реферер-заголовки отправляются с запросами.

```javascript
app.use((req, res, next) => {
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  next();
});
```

## Современные функции безопасности

### 1. Subresource Integrity (SRI)

Позволяет браузеру проверять, что внешние ресурсы не были изменены.

```html
<!-- Пример использования SRI -->
<script src="https://cdn.example.com/library.js" 
        integrity="sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/uxy9rx7HNQlGYl1kPzQho1wx4JwY8wC"
        crossorigin="anonymous"></script>

<link rel="stylesheet" href="https://cdn.example.com/style.css" 
      integrity="sha384-cg3AZjGZaUTwN6K6X4DBq/7YJZi5ytHJpXY+0hLk0WZkcZ5hG0a6m0G6V+2L" 
      crossorigin="anonymous">
```

### 2. Feature Policy (теперь Permissions Policy)

Контролирует, какие браузерные функции могут использовать веб-страницы.

```javascript
app.use((req, res, next) => {
  res.setHeader('Permissions-Policy', 
    'geolocation=(), ' +
    'camera=(), ' +
    'microphone=(), ' +
    'autoplay=(self "https://trusted-video.com")'
  );
  next();
});
```

### 3. Cross-Origin Opener Policy (COOP)

Предотвращает попадание информации между окнами разных источников.

```javascript
app.use((req, res, next) => {
  res.setHeader('Cross-Origin-Opener-Policy', 'same-origin');
  next();
});
```

### 4. Cross-Origin Embedder Policy (COEP)

Предотвращает утечку данных через встроенные ресурсы.

```javascript
app.use((req, res, next) => {
  res.setHeader('Cross-Origin-Embedder-Policy', 'require-corp');
  next();
});
```

### 5. Cross-Origin Resource Policy (CORP)

Контролирует, кто может встраивать ресурсы с вашего сайта.

```javascript
app.use((req, res, next) => {
  res.setHeader('Cross-Origin-Resource-Policy', 'same-site');
  next();
});
```

## Практические примеры настройки безопасности

### Полный пример настройки заголовков безопасности в Express.js

```javascript
const helmet = require('helmet');

// Использование Helmet для настройки большинства заголовков безопасности
app.use(helmet({
  contentSecurityPolicy: {
    directives: {
      defaultSrc: ["'self'"],
      scriptSrc: ["'self'", "'unsafe-inline'", 'https://trusted-cdn.com'],
      styleSrc: ["'self'", "'unsafe-inline'"],
      imgSrc: ["'self'", 'data:', 'https:'],
      fontSrc: ["'self'"],
      connectSrc: ["'self'", 'https://api.example.com'],
      frameAncestors: ["'none'"], // Защита от кликджекинга
      baseUri: ["'self'"],
      formAction: ["'self'"]
    }
  },
  hsts: {
    maxAge: 31536000, // 1 год
    includeSubDomains: true,
    preload: true
  },
  referrerPolicy: {
    policy: 'strict-origin-when-cross-origin'
  },
  noSniff: true, // X-Content-Type-Options
  frameguard: {    // X-Frame-Options
    action: 'deny'
  }
}));

// Дополнительные заголовки
app.use((req, res, next) => {
  // Защита от кликджекинга (дополнительно к CSP)
  res.setHeader('X-Frame-Options', 'DENY');
  
  // Запрет MIME-type sniffing
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // XSS Protection (устаревший, но полезный для старых браузеров)
  res.setHeader('X-XSS-Protection', '1; mode=block');
  
  next();
});
```

### Клиентская защита с использованием Content Security Policy

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Безопасное приложение</title>
  
  <!-- Важно: CSP должен быть в meta теге до загрузки других ресурсов -->
  <meta http-equiv="Content-Security-Policy" 
        content="default-src 'self'; 
                 script-src 'self' 'unsafe-inline' https://trusted-cdn.com; 
                 style-src 'self' 'unsafe-inline';
                 img-src 'self' data: https:;
                 font-src 'self';
                 connect-src 'self' https://api.example.com;">
  
  <link rel="stylesheet" href="/css/app.css">
</head>
<body>
  <div id="app">
    <!-- Содержимое приложения -->
  </div>
  
  <script src="/js/app.js"></script>
</body>
</html>
```

### Защита форм от CSRF

```javascript
// Middleware для CSRF защиты
const csrf = require('csurf');
const csrfProtection = csrf({ 
  cookie: {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: true
  }
});

app.use(csrfProtection);

// Отправка токена на клиент
app.get('/form', (req, res) => {
  res.json({ csrfToken: req.csrfToken() });
});

// Проверка токена в POST запросах
app.post('/submit', (req, res) => {
  // CSRF токен автоматически проверяется middleware
  // Если токен недействителен, будет ошибка 403
  processFormData(req.body);
  res.json({ success: true });
});
```

## Совместимость с браузерами

| Функция безопасности | Chrome | Firefox | Safari | Edge |
|---------------------|--------|---------|--------|------|
| CSP | 25+ | 23+ | 7+ | 12+ |
| HSTS | 4+ | 4+ | 7+ | 12+ |
| X-Frame-Options | 4+ | 3.5+ | 4+ | 8+ |
| X-Content-Type-Options | 14+ | 50+ | 10+ | 12+ |
| COOP/COEP | 90+ | 79+ | 15+ | 90+ |

## Лучшие практики

### 1. Используйте комплексный подход

```javascript
// Пример комплексной настройки безопасности
const securityHeaders = (req, res, next) => {
  // Content Security Policy
  res.setHeader('Content-Security-Policy', 
    "default-src 'self'; " +
    "script-src 'self' 'unsafe-inline' https://trusted-cdn.com; " +
    "style-src 'self' 'unsafe-inline'; " +
    "img-src 'self' data: https:; " +
    "font-src 'self'; " +
    "connect-src 'self' https://api.example.com; " +
    "frame-ancestors 'none';"
  );
  
  // Strict Transport Security
  res.setHeader('Strict-Transport-Security', 
    'max-age=31536000; includeSubDomains; preload'
  );
  
  // X-Frame-Options
  res.setHeader('X-Frame-Options', 'DENY');
  
  // X-Content-Type-Options
  res.setHeader('X-Content-Type-Options', 'nosniff');
  
  // Referrer Policy
  res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
  
  // Permissions Policy
  res.setHeader('Permissions-Policy', 
    'geolocation=(), microphone=(), camera=()'
  );
  
  next();
};

app.use(securityHeaders);
```

### 2. Регулярное обновление политик

```javascript
// Система мониторинга и обновления политик безопасности
class SecurityPolicyManager {
  constructor() {
    this.policies = this.loadPolicies();
    this.checkForUpdates();
  }
  
  loadPolicies() {
    return {
      csp: {
        default: "default-src 'self'",
        updated: new Date('2023-01-01')
      },
      hsts: {
        maxAge: 31536000,
        updated: new Date('2023-01-01')
      }
    };
  }
  
  async checkForUpdates() {
    // Проверка обновлений политик безопасности
    // из централизованного источника
    const response = await fetch('https://security-center.example.com/policies');
    const newPolicies = await response.json();
    
    if (this.hasPolicyUpdates(newPolicies)) {
      this.updatePolicies(newPolicies);
      this.notifyAdmins('Политики безопасности обновлены');
    }
  }
  
  hasPolicyUpdates(newPolicies) {
    // Логика проверки обновлений
    return false;
  }
  
  updatePolicies(newPolicies) {
    // Обновление политик
    this.policies = newPolicies;
  }
  
  notifyAdmins(message) {
    // Уведомление администраторов
    console.log(message);
  }
}
```

### 3. Тестирование политик безопасности

```javascript
// Инструмент для тестирования CSP
class CSPTester {
  static async testPolicy(policy, testUrl) {
    const violations = [];
    
    // Тестируем различные атаки
    const tests = [
      this.testXSS(policy, testUrl),
      this.testUntrustedScripts(policy, testUrl),
      this.testUntrustedStyles(policy, testUrl)
    ];
    
    const results = await Promise.all(tests);
    results.forEach(result => violations.push(...result));
    
    return {
      policy,
      violations,
      compliant: violations.length === 0
    };
  }
  
  static async testXSS(policy, testUrl) {
    const violations = [];
    
    // Тест на XSS
    const xssPayloads = [
      '<script>alert("XSS")</script>',
      'javascript:alert("XSS")',
      '<img src=x onerror=alert("XSS")>'
    ];
    
    for (const payload of xssPayloads) {
      try {
        // Отправляем полезную нагрузку и проверяем, была ли она заблокирована
        const response = await fetch(testUrl, {
          method: 'POST',
          body: JSON.stringify({ test: payload }),
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.status === 400 || response.status === 403) {
          // Политика работает
        } else {
          violations.push({
            type: 'XSS',
            payload,
            blocked: false
          });
        }
      } catch (error) {
        violations.push({
          type: 'XSS',
          payload,
          error: error.message
        });
      }
    }
    
    return violations;
  }
}
```

## Заключение

Функции безопасности браузера играют критическую роль в защите веб-приложений и их пользователей. Понимание и правильное использование этих механизмов позволяет значительно повысить безопасность приложений. Регулярное обновление политик, тестирование и мониторинг обеспечивают актуальность мер безопасности в условиях постоянно меняющихся угроз.

## Связанные темы

- [[Безопасность-CORS]]
- [[Кодирование-вывода]]
- [[Проверка-ввода]]
- [[Лучшие-практики-безопасности-API]]
- [[Безопасность-хранилища-браузера]]
- [[Тестирование-безопасности]]