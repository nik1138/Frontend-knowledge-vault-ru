---
aliases: []
tags: 
  - security
  - browser-security
  - web-security
  - same-origin-policy
  - cors
  - security-policy
---

# Same-Origin Policy

## Введение в Same-Origin Policy

Same-Origin Policy (SOP) — это фундаментальный механизм безопасности веб-браузеров, который контролирует, как документ или скрипт, происходящий из одного источника (origin), может взаимодействовать с ресурсами из другого источника. Это одна из ключевых мер безопасности, предотвращающих неправомерный доступ к чувствительным данным между различными веб-сайтами.

Политика была введена для предотвращения атак, таких как межсайтовый скриптинг (XSS) и межсайтовая подделка запроса (CSRF), ограничивая возможность вредоносных сайтов получать доступ к данным с других доменов без явного разрешения.

## Что такое Origin и как он определяется

**Origin** (источник) — это уникальный идентификатор, состоящий из трех компонентов:
- **Протокол** (scheme) — например, `http`, `https`
- **Хост** (host) — имя домена или IP-адрес
- **Порт** (port) — номер порта (если отличается от стандартного)

Два URL считаются одинаковыми источниками, если все три компонента совпадают:

```javascript
// Примеры одинаковых источников:
https://example.com:443
https://example.com  // порт 443 по умолчанию для https

// Примеры разных источников:
https://example.com  // протокол отличается
http://example.com   // протокол отличается
https://sub.example.com  // хост отличается
https://example.com:8080  // порт отличается
```

## Как работает Same-Origin Policy

Same-Origin Policy ограничивает:
- **Доступ к DOM** — скрипты с одного сайта не могут читать или изменять DOM другого сайта
- **AJAX-запросы** — XMLHttpRequest и fetch API ограничены запросами к тому же источнику
- **Доступ к куки, сессиям и хранилищу** — изолированы между разными источниками
- **Доступ к файловой системе** — скрипты не могут читать локальные файлы без явного разрешения пользователя

Политика работает на уровне браузера и не влияет на серверные соединения, но ограничивает возможности клиентского JavaScript взаимодействовать с ресурсами из других источников.

## Исключения из политики

Несмотря на строгость SOP, существуют законные исключения:

### 1. HTML-теги с атрибутами
- `<img src="...">` — можно загружать изображения с других доменов
- `<script src="...">` — можно подключать скрипты (например, библиотеки)
- `<link rel="stylesheet" href="...">` — можно подключать стили
- `<iframe src="...">` — можно встраивать контент (но с ограничениями)

### 2. CORS (Cross-Origin Resource Sharing)
Механизм, позволяющий серверу явно указать, какие источники могут получить доступ к его ресурсам.

### 3. postMessage API
Безопасный способ общения между окнами/фреймами из разных источников.

### 4. document.domain
Для поддоменов одного домена можно установить общий домен (ограничено).

## Расширения политики (CORS, postMessage и др.)

### CORS (Cross-Origin Resource Sharing)
CORS — это механизм, который позволяет серверу указать, какие источники могут получить доступ к его ресурсам. Он работает через HTTP-заголовки:

```http
Access-Control-Allow-Origin: https://example.com
Access-Control-Allow-Methods: GET, POST, PUT
Access-Control-Allow-Headers: Content-Type, Authorization
```

### postMessage API
Безопасный способ общения между окнами/фреймами из разных источников:

```javascript
// Отправка сообщения
targetWindow.postMessage(message, targetOrigin);

// Прием сообщения
window.addEventListener('message', function(event) {
    if (event.origin !== 'https://trusted-site.com') {
        return; // Проверка источника
    }
    // Обработка сообщения
});
```

### JSONP (JSON with Padding)
Обходное решение для GET-запросов к другим источникам (устаревшее и небезопасное).

## Угрозы обхода политики

### 1. JSONP-атаки
Использование уязвимостей в JSONP-эндпоинтах для извлечения данных.

### 2. CORS-обход
Неправильная настройка CORS-заголовков может позволить вредоносным сайтам получить доступ к ресурсам.

### 3. postMessage-угрозы
Неправильная проверка источника в postMessage может привести к утечке данных.

### 4. Подделка запросов (CSRF)
Обход SOP через поддельные запросы от имени пользователя.

## Лучшие практики

### 1. Ограниченный CORS
```http
Access-Control-Allow-Origin: https://trusted-site.com
```
Вместо:
```http
Access-Control-Allow-Origin: *
```

### 2. Проверка источника в postMessage
```javascript
window.addEventListener('message', function(event) {
    if (event.origin !== expectedOrigin) {
        return;
    }
    // Обработка сообщения
});
```

### 3. Использование HTTPS
Предотвращает атаки посредника и обеспечивает безопасность протокола.

### 4. Ограничение доступа к ресурсам
Использование заголовков безопасности, таких как CSP, X-Frame-Options и т.д.

## Примеры нарушения политики

### Пример 1: AJAX-запрос к другому источнику без CORS
```javascript
// Это вызовет ошибку CORS
fetch('https://api.other-site.com/data')
  .then(response => response.json())
  .then(data => console.log(data));
```

### Пример 2: Неправильная проверка источника в postMessage
```javascript
// НЕБЕЗОПАСНО - не проверяется источник
window.addEventListener('message', function(event) {
    // Любой сайт может отправить сообщение
    processMessage(event.data);
});
```

### Пример 3: Использование wildcard в CORS
```http
Access-Control-Allow-Origin: *
```
Это позволяет любому сайту получить доступ к ресурсам.

## Тестирование соблюдения политики

### 1. Проверка CORS-заголовков
Использование инструментов разработчика браузера для проверки заголовков ответа.

### 2. Проверка postMessage
Анализ кода на наличие проверки `event.origin`.

### 3. Тестирование через iframe
Попытка доступа к содержимому iframe из другого источника.

### 4. Автоматизированные инструменты
- OWASP ZAP
- Burp Suite
- CORS Scanner

## Совместимость с браузерами

Same-Origin Policy реализована во всех современных браузерах:
- Chrome/Chromium
- Firefox
- Safari
- Edge
- Opera

Реализация может немного отличаться между браузерами, особенно в отношении исключений и граничных случаев.

## Отладка проблем с политикой

### 1. Использование DevTools
- Консоль браузера показывает ошибки CORS
- Сеть: проверка заголовков запросов и ответов
- Безопасность: информация о политике

### 2. Проверка заголовков
Анализ HTTP-заголовков запроса и ответа для понимания причин ошибок.

### 3. Тестирование в разных браузерах
Для выявления различий в реализации политики.

## Связь с другими механизмами безопасности

### 1. Content Security Policy (CSP)
Дополняет SOP, контролируя, какие ресурсы можно загружать и выполнять.

### 2. Cross-Site Request Forgery (CSRF) Protection
Совместно с SOP защищает от поддельных запросов.

### 3. Subresource Integrity (SRI)
Обеспечивает целостность внешних ресурсов, загружаемых с разрешенных доменов.

### 4. X-Frame-Options
Ограничивает возможность встраивания страниц в iframe из других источников.

## Практические рекомендации

### 1. Для разработчиков API
- Настройте CORS-заголовки строго по необходимости
- Проверяйте источники запросов
- Используйте HTTPS

### 2. Для фронтенд-разработчиков
- Правильно обрабатывайте CORS-ошибки
- Проверяйте источники в postMessage
- Используйте безопасные методы взаимодействия

### 3. Для тестировщиков
- Проверяйте настройки CORS
- Тестируйте postMessage на уязвимости
- Анализируйте заголовки безопасности

## Связанные файлы

- [[Cross-Origin-Resource-Sharing]]
- [[Content-Security-Policy]]
- [[Cross-Site-Request-Forgery]]
- [[Browser-Security-Basics]]
- [[Web-Security-Fundamentals]]
- [[PostMessage-Security]]
- [[HTTP-Security-Headers]]
- [[Subresource-Integrity]]
- [[XSS-Protection]]
- [[Secure-Cookies]]

## Заключение

Same-Origin Policy остается одной из ключевых мер безопасности в веб-браузерах, защищая пользователей от множества атак. Понимание принципов её работы и правильная реализация расширенных механизмов (CORS, postMessage) критически важны для создания безопасных веб-приложений.

Хотя политика может создавать сложности при разработке распределенных приложений, правильно реализованные исключения обеспечивают безопасное взаимодействие между доверенными источниками.