---
aliases: ["CORS Security", "Cross-Origin Resource Sharing Security", "CORS Vulnerabilities"]
tags: 
  - security
  - web-security
  - browser-security
  - cors
  - vulnerabilities
  - web-development
---

# CORS-безопасность

## Введение в CORS и безопасность

Cross-Origin Resource Sharing (CORS) — это механизм безопасности, реализованный в веб-браузерах, который контролирует, как веб-страницы и другие домены могут запрашивать ресурсы с другого домена. CORS необходим для предотвращения нежелательного доступа к чувствительным данным между различными источниками (доменами, протоколами или портами).

Этот механизм позволяет серверу указать, какие источники могут получить доступ к его ресурсам, тем самым защищая пользователей от потенциальных атак, таких как межсайтовая подделка запроса (CSRF) и межсайтовый скриптинг (XSS).

## Зачем нужен CORS и как он работает

CORS необходим для обеспечения безопасности веб-приложений, работающих в браузере. Без CORS любой веб-сайт мог бы отправлять запросы к любому другому сайту, что создавало бы огромные риски безопасности.

### Как работает CORS

Когда браузер обнаруживает, что JavaScript пытается выполнить запрос к другому источнику (cross-origin), он:

1. Проверяет, соответствует ли запрос политике CORS
2. Если запрос требует предварительной проверки (preflight), отправляет специальный `OPTIONS` запрос
3. Ожидает ответ от сервера с заголовками CORS
4. Если заголовки разрешают запрос, браузер выполняет его, иначе — блокирует

```javascript
// Пример cross-origin запроса
fetch('https://api.example.com/data')
  .then(response => response.json())
  .then(data => console.log(data))
  .catch(error => console.error('CORS error:', error));
```

## Заголовки CORS

### Access-Control-Allow-Origin

Этот заголовок указывает, какие домены могут получить доступ к ресурсам сервера. Это один из самых важных заголовков CORS.

```
Access-Control-Allow-Origin: https://example.com
```

- `*` - разрешает доступ со всех доменов (опасно!)
- Конкретный домен - безопасный вариант
- Несколько доменов - требует проверки на сервере

### Другие важные заголовки CORS

- `Access-Control-Allow-Methods` - указывает разрешенные HTTP-методы
- `Access-Control-Allow-Headers` - указывает разрешенные заголовки запроса
- `Access-Control-Allow-Credentials` - разрешает передачу учетных данных
- `Access-Control-Max-Age` - кэширует результаты preflight запросов
- `Access-Control-Expose-Headers` - указывает, какие заголовки могут быть доступны клиенту

## Опасности неправильной настройки CORS

Неправильная настройка CORS может привести к серьезным уязвимостям:

- Разрешение доступа со всех доменов (`*`) может позволить вредоносным сайтам получить доступ к чувствительным API
- Неправильная проверка источника может привести к обходу безопасности
- Утечка конфиденциальных данных через незащищенные CORS-политики

## Уязвимости, связанные с CORS

### Уязвимость "Reflected XSS через CORS"

Если сервер отражает заголовок `Origin` в ответе `Access-Control-Allow-Origin`, это может привести к XSS-атакам.

### Уязвимость "Утечка данных через неправильные заголовки"

Неправильная настройка заголовков может привести к утечке чувствительных данных другим доменам.

### Уязвимость "Подделка запросов через CORS"

Если заголовки CORS слишком разрешительны, злоумышленник может подделать запросы от имени пользователя.

## Проверка и валидация CORS

### Проверка на стороне сервера

Сервер должен проверять значение заголовка `Origin` и сравнивать его с белым списком разрешенных доменов:

```javascript
const allowedOrigins = ['https://trusted-site.com', 'https://another-trusted.com'];
const origin = req.headers.origin;

if (allowedOrigins.includes(origin)) {
  res.setHeader('Access-Control-Allow-Origin', origin);
}
```

### Проверка на стороне клиента

Хотя клиентская проверка не может заменить серверную, важно понимать, как браузер обрабатывает CORS-запросы и как интерпретировать ошибки.

## Лучшие практики настройки CORS

### 1. Используйте конкретные домены

Вместо `Access-Control-Allow-Origin: *`, указывайте конкретные домены:

```
Access-Control-Allow-Origin: https://trusted-site.com
```

### 2. Проверяйте Origin заголовок

Проверяйте и валидируйте значение заголовка `Origin` на сервере:

```javascript
const isValidOrigin = (origin) => {
  const allowedOrigins = ['https://trusted-site.com'];
  return allowedOrigins.includes(origin);
};
```

### 3. Избегайте wildcard для критичных данных

Не используйте `*` для API, обрабатывающих чувствительные данные или требующих аутентификации.

### 4. Используйте Credentials осторожно

Если вы используете `Access-Control-Allow-Credentials: true`, убедитесь, что `Access-Control-Allow-Origin` не равен `*`.

### 5. Ограничивайте методы и заголовки

Разрешайте только те HTTP-методы и заголовки, которые действительно необходимы:

```
Access-Control-Allow-Methods: GET, POST
Access-Control-Allow-Headers: Content-Type, Authorization
```

## Примеры неправильной настройки

### Пример 1: Разрешение всех доменов

```javascript
// НЕПРАВИЛЬНО
app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', '*');
  next();
});
```

### Пример 2: Отражение Origin без проверки

```javascript
// НЕПРАВИЛЬНО
app.use((req, res, next) => {
  res.setHeader('Access-Control-Allow-Origin', req.headers.origin);
  next();
});
```

### Пример 3: Разрешение Credentials с wildcard

```javascript
// НЕПРАВИЛЬНО
res.setHeader('Access-Control-Allow-Origin', '*');
res.setHeader('Access-Control-Allow-Credentials', 'true');
```

## Атаки через CORS

### Подделка запросов

Злоумышленник может создать веб-страницу, которая отправляет запросы к защищенному API от имени пользователя.

### Утечка данных

Через неправильно настроенный CORS злоумышленник может получить доступ к чувствительным данным, таким как токены аутентификации.

### Обход защиты CSRF

Некоторые CORS-настройки могут обойти защиту CSRF, если заголовки разрешены неправильно.

## Защита от атак CORS

### 1. Правильная проверка Origin

Всегда проверяйте значение заголовка `Origin` на сервере:

```javascript
const whitelist = ['https://trusted-site.com', 'https://sub.trusted-site.com'];
const origin = req.headers.origin;

if (whitelist.includes(origin)) {
  res.setHeader('Access-Control-Allow-Origin', origin);
}
```

### 2. Использование безопасных заголовков

Разрешайте только те заголовки, которые действительно необходимы для работы приложения.

### 3. Ограничение методов

Разрешайте только те HTTP-методы, которые требуются для функциональности.

### 4. Проверка учетных данных

Если вы используете учетные данные, убедитесь, что `Access-Control-Allow-Origin` не равен `*`.

## Тестирование CORS-безопасности

### Использование инструментов разработчика

Откройте вкладку Network в DevTools и проверьте заголовки CORS в ответах.

### Тестирование с разных доменов

Создайте HTML-страницу на другом домене и попробуйте выполнить запрос к вашему API.

### Автоматизированное тестирование

Используйте инструменты для автоматического тестирования CORS-политик:

```bash
# Использование curl для проверки заголовков
curl -H "Origin: https://malicious-site.com" -v https://your-api.com/data
```

## Инструменты анализа CORS

### 1. Burp Suite

Инструмент для тестирования веб-безопасности, позволяющий анализировать CORS-политики.

### 2. OWASP ZAP

Бесплатный инструмент для автоматического тестирования безопасности, включая проверку CORS.

### 3. CORS Scanner

Специализированные инструменты для сканирования CORS-уязвимостей:

- cors-scanner
- CORStest

### 4. Browser DevTools

Встроенные инструменты браузера для отладки CORS-ошибок.

## Отладка CORS-проблем

### Понимание ошибок браузера

Браузер показывает разные сообщения об ошибках CORS в зависимости от типа проблемы:

- "CORS header 'Access-Control-Allow-Origin' missing" - сервер не отправляет заголовок
- "The value of the 'Access-Control-Allow-Origin' header is invalid" - заголовок содержит недопустимое значение

### Использование Preflight-запросов

Проверьте, как браузер отправляет preflight-запросы и как на них отвечает сервер:

```
OPTIONS /api/data HTTP/1.1
Origin: https://example.com
Access-Control-Request-Method: POST
Access-Control-Request-Headers: X-Custom-Header
```

### Проверка всех заголовков

Убедитесь, что все необходимые заголовки CORS установлены правильно:

- `Access-Control-Allow-Origin`
- `Access-Control-Allow-Methods` (если применимо)
- `Access-Control-Allow-Headers` (если применимо)
- `Access-Control-Allow-Credentials` (если используются учетные данные)

## Ссылки на другие связанные файлы

- [[XSS-атаки]]
- [[CSRF-защита]]
- [[HTTP-заголовки-безопасности]]
- [[Сессии-и-аутентификация]]
- [[JSONP-уязвимости]]
- [[Content-Security-Policy]]
- [[Советы-по-безопасности-API]]
- [[Защита-от-атак-на-уровне-приложения]]
- [[OWASP-Top-10]]
- [[Безопасность-веб-приложений]]

## Ключевые выводы

CORS — это важный механизм безопасности, который требует тщательной настройки для предотвращения уязвимостей. Правильная реализация CORS включает:

- Проверку заголовка Origin на сервере
- Использование конкретных доменов вместо wildcard
- Ограничение разрешенных методов и заголовков
- Правильное использование учетных данных
- Регулярное тестирование и аудит CORS-политик

Соблюдение этих практик поможет защитить ваше веб-приложение от CORS-атак и обеспечить безопасность пользовательских данных.