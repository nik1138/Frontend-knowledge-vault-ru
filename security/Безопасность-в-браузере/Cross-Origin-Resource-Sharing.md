# Cross-Origin Resource Sharing (CORS)

## Свойства
```yaml
tags: 
  - security
  - browser-security
  - web-security
  - cors
  - http
aliases: 
  - CORS
  - Совместное использование ресурсов с разных источников
```

## Введение в CORS

Cross-Origin Resource Sharing (CORS) — это механизм, реализованный в веб-браузерах, который позволяет веб-странице делать HTTP-запросы к ресурсам, находящимся на другом домене, протоколе или порту. CORS важен для обеспечения безопасности веб-приложений, позволяя контролировать, какие внешние источники могут получать доступ к ресурсам вашего сайта.

## История и необходимость CORS

### История возникновения

CORS был разработан для решения ограничений, накладываемых политикой одинакового источника (Same-Origin Policy), которая запрещает веб-страницам делать запросы к ресурсам на другом домене. Политика одинакового источника — это важная мера безопасности, предотвращающая нежелательный доступ к конфиденциальным данным.

### Необходимость CORS

- **Микросервисы и API**: Современные веб-приложения часто используют API, размещенные на разных доменах.
- **Кроссплатформенность**: Необходимость интеграции с различными внешними сервисами.
- **Разделение фронтенда и бэкенда**: Часто фронтенд и бэкенд размещаются на разных доменах.

## Как работает CORS

### Принцип работы

CORS работает по принципу согласия между источниками. Когда веб-страница пытается сделать запрос к ресурсу на другом домене, браузер проверяет, разрешает ли сервер-получатель такие запросы от текущего домена.

### Процесс проверки

1. Браузер отправляет запрос с дополнительными заголовками CORS
2. Сервер отвечает с заголовками, указывающими, разрешен ли запрос
3. Если запрос разрешен, браузер позволяет веб-странице получить ответ

## Заголовки CORS

### Access-Control-Allow-Origin

Этот заголовок указывает, какие домены могут получить доступ к ресурсу. Значение может быть:
- `*` — доступ разрешен для всех доменов (не рекомендуется для ресурсов с учетными данными)
- Конкретный домен, например `https://example.com`
- `null` — доступ запрещен для всех доменов

### Другие важные заголовки

- `Access-Control-Allow-Methods` — разрешенные HTTP-методы (GET, POST, PUT, DELETE и т.д.)
- `Access-Control-Allow-Headers` — разрешенные заголовки запроса
- `Access-Control-Allow-Credentials` — разрешение передачи учетных данных
- `Access-Control-Max-Age` — время кэширования предварительного запроса
- `Access-Control-Expose-Headers` — заголовки, доступные клиентскому коду

## Простые и сложные запросы CORS

### Простые запросы

Простые запросы не вызывают предварительного запроса CORS. Они соответствуют следующим критериям:
- HTTP-метод: GET, POST или HEAD
- Простые заголовки: Accept, Accept-Language, Content-Language, Content-Type (с определенными значениями)
- Content-Type: application/x-www-form-urlencoded, multipart/form-data или text/plain

### Сложные запросы

Сложные запросы вызывают предварительный запрос CORS. К ним относятся:
- Любой HTTP-метод кроме GET, POST или HEAD
- Заголовки, отличные от простых
- Content-Type: application/json, text/xml и другие

## Предварительные запросы (preflight)

### Что такое предварительный запрос

Предварительный запрос (preflight) — это дополнительный запрос, который отправляется браузером перед основным запросом, чтобы проверить, разрешает ли сервер запрашиваемый метод и заголовки.

### Процесс предварительного запроса

1. Браузер отправляет OPTIONS-запрос к серверу
2. Сервер отвечает с заголовками CORS
3. Если ответ разрешает запрос, браузер отправляет основной запрос

## Учетные данные в CORS

### Передача учетных данных

Для передачи учетных данных (cookies, HTTP-авторизации и т.д.) в кросс-доменных запросах:
- Установите заголовок `Access-Control-Allow-Credentials: true` на сервере
- В клиентском коде установите `credentials: 'include'` в fetch или `withCredentials: true` в XMLHttpRequest

### Важные ограничения

- Заголовок `Access-Control-Allow-Origin` не может быть `*` при использовании учетных данных
- Необходимо указать конкретный домен в `Access-Control-Allow-Origin`

## Безопасность CORS

### Потенциальные угрозы

- Неправильная настройка заголовков может привести к утечке данных
- Разрешение слишком широкого доступа может привести к атакам типа "человек посередине"
- Учетные данные могут быть скомпрометированы при неправильной настройке

### Меры безопасности

- Минимизировать список разрешенных доменов
- Использовать HTTPS для передачи учетных данных
- Правильно настраивать заголовки CORS

## Частые ошибки в реализации

### Наиболее распространенные ошибки

- Использование `Access-Control-Allow-Origin: *` с учетными данными
- Неправильное указание разрешенных методов и заголовков
- Отсутствие проверки источника запроса
- Неправильное кэширование предварительных запросов

### Последствия ошибок

- Уязвимость к атакам CSRF
- Утечка конфиденциальных данных
- Компрометация учетных данных пользователей

## Атаки через неправильную настройку CORS

### Возможные атаки

- **Утечка данных**: Атакующий может получить доступ к конфиденциальным данным через неправильно настроенный CORS
- **CSRF через CORS**: Неправильная настройка может позволить выполнить CSRF-атаку через кросс-доменные запросы
- **Подделка запросов**: Атакующий может подделать запросы от имени пользователя

### Примеры атак

```javascript
// Злонамеренный сайт может попытаться получить доступ к API
fetch('https://victim.com/api/data', {
  method: 'GET',
  credentials: 'include'
})
.then(response => response.json())
.then(data => {
  // Атакующий получает доступ к конфиденциальным данным
  console.log(data);
});
```

## Лучшие практики безопасности

### Рекомендации по настройке CORS

1. **Ограничьте список разрешенных доменов**
   - Вместо `*` указывайте конкретные домены
   - Регулярно проверяйте и обновляйте список разрешенных доменов

2. **Используйте HTTPS**
   - Всегда используйте HTTPS при передаче учетных данных
   - Проверяйте протокол в заголовках CORS

3. **Минимизируйте разрешенные методы и заголовки**
   - Разрешайте только необходимые HTTP-методы
   - Ограничьте список разрешенных заголовков

4. **Проверяйте источник запроса**
   - Проверяйте заголовок Origin перед установкой заголовков CORS
   - Не полагайтесь только на заголовки CORS для безопасности

5. **Регулярно тестируйте настройки**
   - Проводите регулярные проверки безопасности
   - Используйте инструменты для тестирования CORS

## Отладка CORS

### Распространенные ошибки CORS

- `No 'Access-Control-Allow-Origin' header is present on the requested resource`
- `The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'`
- `Request header field X is not allowed by Access-Control-Allow-Headers`

### Инструменты отладки

- DevTools браузера — вкладка Network для просмотра заголовков запросов и ответов
- CORS-инструменты для тестирования, такие как Postman
- Логирование на сервере для анализа предварительных запросов

## Тестирование CORS

### Методы тестирования

1. **Ручное тестирование**
   - Использование DevTools для проверки заголовков
   - Тестирование различных комбинаций методов и заголовков

2. **Автоматизированное тестирование**
   - Unit-тесты для проверки заголовков CORS
   - Интеграционные тесты для проверки работы CORS в приложении

3. **Инструменты тестирования**
   - OWASP ZAP
   - Burp Suite
   - Специализированные CORS-тестеры

## Альтернативы CORS

### JSONP (JSON with Padding)

- Используется для обхода ограничений CORS в старых браузерах
- Ограничен только GET-запросами
- Менее безопасен по сравнению с CORS

### Серверный прокси

- Все запросы направляются через сервер-посредник
- Прокси добавляет заголовки CORS к ответам
- Повышает безопасность за счет централизации запросов

### Использование PostMessage

- Для общения между окнами/фреймами с разных доменов
- Подходит для сложных сценариев взаимодействия
- Требует дополнительной реализации безопасности

## Ссылки на связанные файлы

- [[Same-Origin-Policy]] — Политика одинакового источника, основа CORS
- [[HTTP-Security-Headers]] — Другие важные заголовки безопасности
- [[CSRF-защита]] — Защита от подделки межсайтовых запросов
- [[XSS-защита]] — Защита от межсайтового скриптинга
- [[Content-Security-Policy]] — Политика безопасности контента
- [[Secure-Storage]] — Безопасное хранение данных в браузере
- [[Управление-сессиями-и-аутентификацией]] — Управление сессиями и аутентификацией
- [[Безопасная-работа-с-API]] — Безопасная работа с API
- [[Безопасность-в-SPA]] — Безопасность в одностраничных приложениях
- [[Безопасность-в-микросервисной-архитектуре]] — Безопасность в микросервисной архитектуре
- [[Функции-безопасности-браузера]] — Обзор функций безопасности браузера
- [[Тестирование-безопасности]] — Методы тестирования безопасности
- [[Отладка-безопасности]] — Отладка безопасности веб-приложений
- [[Ограничение-доступа-к-API]] — Ограничение доступа к API
- [[Шифрование-на-клиенте]] — Шифрование данных на клиенте
- [[Безопасность-в-системах-с-несколькими-доменами]] — Безопасность в системах с несколькими доменами
- [[Безопасность-веб-сокетов]] — Безопасность веб-сокетов
- [[Безопасность-веб-компонентов]] — Безопасность веб-компонентов
- [[Безопасность-в-системах-с-поддержкой-плагинов]] — Безопасность в системах с поддержкой плагинов
- [[Безопасность-в-браузерных-расширениях]] — Безопасность в браузерных расширениях
- [[Безопасность-в-мобильных-браузерах]] — Безопасность в мобильных браузерах
- [[Безопасность-в-системах-с-поддержкой-камеры-и-микрофона]] — Безопасность в системах с поддержкой камеры и микрофона
- [[Безопасность-в-VR-AR-приложениях]] — Безопасность в VR/AR-приложениях
- [[Безопасность-в-играх]] — Безопасность в играх
- [[Безопасность-в-чатах]] — Безопасность в чатах
- [[Безопасность-в-CMS]] — Безопасность в CMS
- [[Безопасность-в-SPA]] — Безопасность в SPA
- [[Безопасность-в-third-party-integrations]] — Безопасность в third-party интеграциях
- [[Безопасность-в-системах-с-высокой-доступностью]] — Безопасность в системах с высокой доступностью
- [[Безопасность-в-системах-с-высокой-интерактивностью]] — Безопасность в системах с высокой интерактивностью
- [[Безопасность-в-системах-с-офлайн-режимом]] — Безопасность в системах с оффлайн-режимом
- [[Безопасность-в-приложениях-с-веб-платежами]] — Безопасность в приложениях с веб-платежами
- [[Безопасность-в-приложениях-с-веб-печатью]] — Безопасность в приложениях с веб-печатью
- [[Безопасность-в-приложениях-с-P2P-коммуникациями]] — Безопасность в приложениях с P2P-коммуникациями
- [[Безопасность-в-веб-приложениях-с-AI-ML]] — Безопасность в веб-приложениях с AI/ML
- [[Безопасность-в-веб-приложениях-для-детей]] — Безопасность в веб-приложениях для детей
- [[Безопасность-в-облачных-средах]] — Безопасность в облачных средах
- [[Безопасность-в-сервис-воркерах]] — Безопасность в сервис-воркерах
- [[Безопасность-PWA]] — Безопасность PWA
- [[Безопасность-в-браузере]] — Общие вопросы безопасности в браузере
- [[Основы-веб-безопасности]] — Основы веб-безопасности
- [[Защита-от-атак-на-уровне-браузера]] — Защита от атак на уровне браузера
- [[Защита-от-инъекций]] — Защита от инъекций
- [[XSS-защита]] — Защита от XSS
- [[CSRF-защита]] — Защита от CSRF
- [[Clickjacking-защита]] — Защита от clickjacking
- [[HTTP-Security-Headers]] — HTTP-заголовки безопасности
- [[Content-Security-Policy]] — CSP
- [[Subresource-Integrity]] — SRI
- [[Feature-Policy]] — Feature Policy
- [[Secure-Coding-Practices]] — Безопасные методы кодирования
- [[Dependency-Security]] — Безопасность зависимостей
- [[Аудит-безопасности]] — Аудит безопасности
- [[Мониторинг-безопасности]] — Мониторинг безопасности
- [[Инцидент-менеджмент-на-фронтенде]] — Инцидент-менеджмент на фронтенде
- [[Управление-доступом]] — Управление доступом
- [[Ограничение-ресурсов-и-защита-от-злоупотреблений]] — Ограничение ресурсов и защита от злоупотреблений
- [[Снижение-рисков-при-работе-с-cookies]] — Снижение рисков при работе с cookies
- [[Снижение-рисков-в-DevTools]] — Снижение рисков в DevTools
- [[Снижение-влияния-на-производительность]] — Снижение влияния на производительность
- [[Использование-WebAssembly-безопасно]] — Использование WebAssembly безопасно
- [[Обработка-персональных-данных]] — Обработка персональных данных
- [[Шифрование-на-клиенте]] — Шифрование на клиенте
- [[Secure-Storage]] — Безопасное хранение
- [[Политики-безопасности-для-файлов]] — Политики безопасности для файлов
- [[Безопасность-файлов-конфигурации]] — Безопасность файлов конфигурации
- [[Безопасность-форм]] — Безопасность форм
- [[Безопасность-платежных-форм]] — Безопасность платежных форм
- [[Безопасность-при-работе-с-геолокацией]] — Безопасность при работе с геолокацией
- [[Безопасность-данных-в-реальном-времени]] — Безопасность данных в реальном времени
- [[Контроль-доступа-к-данным-в-браузере]] — Контроль доступа к данным в браузере
- [[Работа-с-уязвимыми-пользователями]] — Работа с уязвимыми пользователями
- [[Этические-аспекты-безопасности]] — Этические аспекты безопасности
- [[Меры-против-ботов]] — Меры против ботов
- [[Обнаружение-и-предотвращение-брутфорса]] — Обнаружение и предотвращение брутфорса
- [[Защита-от-фишинга]] — Защита от фишинга
- [[Защита-от-социальной-инженерии]] — Защита от социальной инженерии
- [[Идентификация-и-отслеживание-угроз]] — Идентификация и отслеживание угроз
- [[Интеграция-с-OAuth]] — Интеграция с OAuth
- [[Безопасность-в-OIDC]] — Безопасность в OIDC
- [[Обфускация-и-защита-исходного-кода]] — Обфускация и защита исходного кода
- [[Сниффинг-и-защита-от-него]] — Сниффинг и защита от него
- [[Мониторинг-безопасности-в-продакшене]] — Мониторинг безопасности в продакшене
- [[Архитектурные-паттерны-безопасности]] — Архитектурные паттерны безопасности
- [[Безопасное-кэширование]] — Безопасное кэширование
- [[Безопасность-в-системах-с-drag-and-drop-файлов]] — Безопасность в системах с drag-and-drop файлов
- [[Безопасность-в-системах-с-push-уведомлениями]] — Безопасность в системах с push-уведомлениями
- [[Безопасность-в-системах-i18n]] — Безопасность в системах i18n
- [[Безопасность-в-системах-сборки]] — Безопасность в системах сборки