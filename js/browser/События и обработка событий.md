# События и обработка событий

## Введение

События - это основной механизм взаимодействия пользователя с веб-страницей. Обработка событий позволяет реагировать на действия пользователя, такие как клики, нажатия клавиш, перемещение мыши и другие. В этой главе мы рассмотрим все аспекты работы с событиями в JavaScript.

## Содержание

- [[Типы событий]]
- [[Механизмы обработки событий]]
- [[Всплытие и захват событий]]
- [[Делегирование событий]]
- [[Кастомные события]]
- [[События мыши]]
- [[События клавиатуры]]
- [[События формы]]
- [[События документа и окна]]

## Основные концепции

### Что такое событие

Событие - это сигнал, который отправляется объекту для указания на то, что произошло какое-то действие. В браузере события могут быть вызваны действиями пользователя (нажатие клавиши, клик мышью) или системными событиями (загрузка страницы, ошибка).

### Модель событий

В современном JavaScript используется модель событий W3C, которая включает три фазы обработки события:

1. **Фаза захвата (Capture Phase)** - событие движется от корня документа к целевому элементу
2. **Фаза цели (Target Phase)** - событие достигает целевого элемента
3. **Фаза всплытия (Bubbling Phase)** - событие всплывает обратно к корню документа

## Механизмы обработки событий

### Inline-обработчики

```html
<button onclick="alert('Привет!')">Нажми меня</button>
```

### DOM Level 0 (старый способ)

```javascript
const button = document.getElementById('myButton');
button.onclick = function() {
    alert('Привет!');
};

// Удаление обработчика
button.onclick = null;
```

### DOM Level 2 (современный способ)

```javascript
const button = document.getElementById('myButton');

// Добавление обработчика
button.addEventListener('click', function(event) {
    console.log('Кнопка нажата!');
    console.log('Тип события:', event.type);
    console.log('Целевой элемент:', event.target);
});

// Удаление обработчика
function handleClick(event) {
    console.log('Кнопка нажата!');
}

button.addEventListener('click', handleClick);
button.removeEventListener('click', handleClick);
```

## Примеры из промышленной разработки

### Обработка форм

```javascript
// Класс для валидации формы
class FormValidator {
    constructor(formId) {
        this.form = document.getElementById(formId);
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        // Валидация при потере фокуса
        this.form.addEventListener('blur', (event) => {
            if (event.target.matches('input, select, textarea')) {
                this.validateField(event.target);
            }
        }, true); // Используем фазу захвата
        
        // Предотвращение отправки формы при ошибках
        this.form.addEventListener('submit', (event) => {
            if (!this.validateForm()) {
                event.preventDefault();
            }
        });
    }
    
    validateField(field) {
        const errors = [];
        
        // Общие проверки
        if (field.hasAttribute('required') && !field.value.trim()) {
            errors.push('Поле обязательно для заполнения');
        }
        
        if (field.type === 'email' && field.value && !this.isValidEmail(field.value)) {
            errors.push('Неверный формат email');
        }
        
        // Показать ошибки
        this.showFieldErrors(field, errors);
        return errors.length === 0;
    }
    
    validateForm() {
        const fields = this.form.querySelectorAll('input, select, textarea');
        let isValid = true;
        
        fields.forEach(field => {
            if (!this.validateField(field)) {
                isValid = false;
            }
        });
        
        return isValid;
    }
    
    showFieldErrors(field, errors) {
        // Удалить предыдущие ошибки
        const existingError = field.parentNode.querySelector('.error-message');
        if (existingError) {
            existingError.remove();
        }
        
        if (errors.length > 0) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = errors.join(', ');
            field.parentNode.appendChild(errorDiv);
            
            field.classList.add('error');
        } else {
            field.classList.remove('error');
        }
    }
    
    isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }
}

// Использование
const validator = new FormValidator('registrationForm');
```

### Клавиатурные сокращения

```javascript
// Класс для управления клавиатурными сокращениями
class KeyboardShortcuts {
    constructor() {
        this.shortcuts = new Map();
        this.setupEventListeners();
    }
    
    register(key, callback, options = {}) {
        const keyInfo = {
            key: key.toLowerCase(),
            ctrl: options.ctrl || false,
            shift: options.shift || false,
            alt: options.alt || false,
            callback: callback
        };
        
        this.shortcuts.set(key, keyInfo);
    }
    
    setupEventListeners() {
        document.addEventListener('keydown', (event) => {
            // Создаем строку для поиска
            const key = event.key.toLowerCase();
            const keyString = this.buildKeyString(event);
            
            if (this.shortcuts.has(keyString)) {
                const shortcut = this.shortcuts.get(keyString);
                event.preventDefault();
                shortcut.callback(event);
            }
        });
    }
    
    buildKeyString(event) {
        let keyString = event.key.toLowerCase();
        
        if (event.ctrlKey) keyString = 'ctrl+' + keyString;
        if (event.shiftKey) keyString = 'shift+' + keyString;
        if (event.altKey) keyString = 'alt+' + keyString;
        if (event.metaKey) keyString = 'meta+' + keyString; // Cmd на Mac
        
        return keyString;
    }
}

// Использование
const kbShortcuts = new KeyboardShortcuts();

kbShortcuts.register('s', () => {
    console.log('Сохранение...');
}, { ctrl: true });

kbShortcuts.register('f', () => {
    console.log('Поиск...');
}, { ctrl: true });
```

### Система модальных окон

```javascript
// Класс для управления модальными окнами
class ModalManager {
    constructor() {
        this.modals = new Map();
        this.setupGlobalEventListeners();
    }
    
    createModal(id, content) {
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.id = id;
        modal.innerHTML = `
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <button class="modal-close">&times;</button>
                <div class="modal-body">${content}</div>
            </div>
        `;
        
        document.body.appendChild(modal);
        this.modals.set(id, modal);
        
        this.setupModalEventListeners(modal);
        return modal;
    }
    
    openModal(id) {
        const modal = this.modals.get(id);
        if (modal) {
            modal.style.display = 'block';
            document.body.classList.add('modal-open');
        }
    }
    
    closeModal(id) {
        const modal = this.modals.get(id);
        if (modal) {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        }
    }
    
    setupModalEventListeners(modal) {
        // Закрытие по кнопке закрытия
        const closeBtn = modal.querySelector('.modal-close');
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            document.body.classList.remove('modal-open');
        });
        
        // Закрытие по клику на оверлей
        const overlay = modal.querySelector('.modal-overlay');
        overlay.addEventListener('click', (event) => {
            if (event.target === overlay) {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });
        
        // Закрытие по клавише Escape
        modal.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            }
        });
    }
    
    setupGlobalEventListeners() {
        // Закрытие всех модальных окон по клавише Escape
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                // Закрыть все открытые модальные окна
                this.modals.forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                document.body.classList.remove('modal-open');
            }
        });
    }
}
```

## Всплытие и захват событий

### Пример всплытия

```html
<div id="outer">
    <div id="middle">
        <button id="inner">Кликни меня</button>
    </div>
</div>
```

```javascript
// Обработчики на разных уровнях
document.getElementById('outer').addEventListener('click', () => {
    console.log('Клик на внешнем div');
}, false); // false означает фазу всплытия

document.getElementById('middle').addEventListener('click', () => {
    console.log('Клик на среднем div');
}, false);

document.getElementById('inner').addEventListener('click', () => {
    console.log('Клик на кнопке');
}, false);

// При клике на кнопке будет выведено:
// Клик на кнопке
// Клик на среднем div
// Клик на внешнем div
```

### Пример захвата

```javascript
// Обработчики с захватом
document.getElementById('outer').addEventListener('click', () => {
    console.log('Захват: внешний div');
}, true); // true означает фазу захвата

document.getElementById('middle').addEventListener('click', () => {
    console.log('Захват: средний div');
}, true);

document.getElementById('inner').addEventListener('click', () => {
    console.log('Захват: кнопка');
}, false); // на цели обычно не используют захват

// При клике на кнопке будет выведено:
// Захват: внешний div
// Захват: средний div
// Захват: кнопка
```

## Делегирование событий

```javascript
// Пример делегирования событий
document.addEventListener('click', function(event) {
    // Обработка кликов по кнопкам с определенным классом
    if (event.target.classList.contains('delete-btn')) {
        const item = event.target.closest('.list-item');
        if (item) {
            item.remove();
        }
    }
    
    // Обработка кликов по ссылкам с определенным атрибутом
    if (event.target.matches('a[data-modal]')) {
        event.preventDefault();
        const modalId = event.target.getAttribute('data-modal');
        openModal(modalId);
    }
});

// Более сложный пример с деревом элементов
class TreeView {
    constructor(containerId) {
        this.container = document.getElementById(containerId);
        this.setupEventDelegation();
    }
    
    setupEventDelegation() {
        this.container.addEventListener('click', (event) => {
            if (event.target.classList.contains('expand-btn')) {
                this.toggleExpand(event.target.closest('.tree-item'));
            } else if (event.target.classList.contains('selectable')) {
                this.selectItem(event.target);
            }
        });
    }
    
    toggleExpand(item) {
        const children = item.querySelector('.tree-children');
        if (children) {
            children.classList.toggle('hidden');
            const icon = item.querySelector('.expand-btn');
            icon.textContent = children.classList.contains('hidden') ? '+' : '-';
        }
    }
    
    selectItem(item) {
        // Снять выделение с других элементов
        this.container.querySelectorAll('.selected').forEach(el => {
            el.classList.remove('selected');
        });
        
        // Выделить текущий элемент
        item.classList.add('selected');
    }
}
```

## Кастомные события

```javascript
// Создание и использование кастомных событий
class EventEmitter {
    constructor() {
        this.eventTarget = new EventTarget();
    }
    
    on(eventName, callback) {
        this.eventTarget.addEventListener(eventName, callback);
    }
    
    off(eventName, callback) {
        this.eventTarget.removeEventListener(eventName, callback);
    }
    
    emit(eventName, detail = {}) {
        const event = new CustomEvent(eventName, { detail });
        this.eventTarget.dispatchEvent(event);
    }
}

// Использование
const emitter = new EventEmitter();

emitter.on('userLogin', (event) => {
    console.log('Пользователь вошел:', event.detail.username);
});

emitter.on('userLogout', (event) => {
    console.log('Пользователь вышел:', event.detail.username);
});

// Генерация событий
emitter.emit('userLogin', { username: 'john_doe' });
emitter.emit('userLogout', { username: 'john_doe' });

// Пример с DOM элементами
function createCustomEvent() {
    const customEvent = new CustomEvent('myCustomEvent', {
        detail: { message: 'Привет из кастомного события!' },
        bubbles: true, // Разрешить всплытие
        cancelable: true // Разрешить отмену
    });
    
    // Генерация события
    document.dispatchEvent(customEvent);
    
    // Обработка события
    document.addEventListener('myCustomEvent', (event) => {
        console.log(event.detail.message);
    });
}
```

## Лучшие практики

### 1. Правильное управление памятью

```javascript
// Всегда удаляйте обработчики событий при необходимости
class Component {
    constructor(element) {
        this.element = element;
        this.boundHandleClick = this.handleClick.bind(this);
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        this.element.addEventListener('click', this.boundHandleClick);
    }
    
    handleClick(event) {
        console.log('Клик обработан');
    }
    
    destroy() {
        // Удаление обработчиков при уничтожении компонента
        this.element.removeEventListener('click', this.boundHandleClick);
    }
}
```

### 2. Использование passive: true для оптимизации

```javascript
// Для событий, которые не вызывают preventDefault
element.addEventListener('touchstart', handleTouchStart, { passive: true });
element.addEventListener('wheel', handleWheel, { passive: true });
```

### 3. Предотвращение чрезмерного использования событий

```javascript
// Использование debounce для событий, вызываемых часто
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

const debouncedResize = debounce(() => {
    console.log('Размер окна изменен');
}, 250);

window.addEventListener('resize', debouncedResize);
```

## Безопасность

При обработке событий важно учитывать безопасность:

```javascript
// При обработке пользовательского ввода всегда очищайте данные
function handleUserInput(event) {
    const userInput = event.target.value;
    
    // Очистка ввода от потенциально опасного содержимого
    const sanitizedInput = DOMPurify.sanitize(userInput);
    
    // Или ручная очистка
    const safeInput = userInput.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '');
    
    displayContent(safeInput);
}
```

## Теги

#javascript #events #frontend #programming #web-development