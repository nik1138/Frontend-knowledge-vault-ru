# Оффлайн-функционал в PWA на Vue.js

**Alias**: [[Оффлайн-режим]]

**Tags**: #vue #pwa #offline #service-workers #caching #ux

Оффлайн-функционал позволяет пользователям продолжать использовать приложение даже при отсутствии подключения к интернету, что особенно важно в условиях нестабильного соединения.

## Стратегии кэширования

1. **Cache First** - сначала пытается получить данные из кэша
2. **Network First** - сначала пытается получить данные из сети
3. **Stale While Revalidate** - возвращает кэшированную версию, но обновляет в фоне

## Реализация в Vue.js

Используя Workbox, можно настроить сложные стратегии кэширования:

```javascript
// В файле sw.js
workbox.routing.registerRoute(
  /\.(?:png|gif|jpg|jpeg|webp|svg)$/,
  new workbox.strategies.CacheFirst({
    cacheName: 'images',
    plugins: [
      new workbox.expiration.Plugin({
        maxEntries: 60,
        maxAgeSeconds: 30 * 24 * 60 * 60,
      })
    ]
  })
);
```

## Обработка оффлайн-сценариев в UI

Важно информировать пользователя о статусе подключения и ограничениях функциональности в оффлайн-режиме.

## Российские особенности (2025)

- Учет региональных различий в качестве интернета
- Поддержка оффлайн-режима в мобильных сетях
- Работа в удаленных и слабосвязанных регионах

## Связанные темы

- [[Service-Workers]]
- [[Web-App-Manifest]]

## Подробная реализация оффлайн-функционала

### Определение статуса подключения

Для определения статуса подключения можно использовать свойства `navigator.onLine` и события `online`/`offline`:

```javascript
// Проверка статуса подключения
if (navigator.onLine) {
  console.log('Пользователь онлайн');
} else {
  console.log('Пользователь оффлайн');
}

// Обработка событий изменения статуса
window.addEventListener('online', () => {
  console.log('Пользователь снова онлайн');
});

window.addEventListener('offline', () => {
  console.log('Пользователь снова оффлайн');
});
```

### Кэширование API-ответов

Для кэширования данных, полученных от API, можно использовать стратегии Workbox:

```javascript
// Кэширование API-запросов
workbox.routing.registerRoute(
  new RegExp('/api/.*'),
  new workbox.strategies.NetworkFirst({
    cacheName: 'api-cache',
    plugins: [
      new workbox.expiration.Plugin({
        maxEntries: 50,
        maxAgeSeconds: 5 * 60, // 5 минут
      }),
    ],
  })
);
```

### Хранение данных в IndexedDB

Для более сложных сценариев оффлайн-работы можно использовать IndexedDB:

```javascript
// Пример использования IndexedDB
const DB_NAME = 'MyPwaDB';
const DB_VERSION = 1;

let db;

function initDB() {
  const request = indexedDB.open(DB_NAME, DB_VERSION);
  
  request.onerror = (event) => {
    console.error('Ошибка при открытии IndexedDB:', event.target.error);
  };
  
  request.onsuccess = (event) => {
    db = event.target.result;
  };
  
  request.onupgradeneeded = (event) => {
    db = event.target.result;
    
    if (!db.objectStoreNames.contains('data')) {
      const store = db.createObjectStore('data', { keyPath: 'id' });
      store.createIndex('timestamp', 'timestamp', { unique: false });
    }
  };
}

// Сохранение данных
function saveData(data) {
  const transaction = db.transaction(['data'], 'readwrite');
  const store = transaction.objectStore('data');
  
  store.add({
    id: Date.now(),
    data: data,
    timestamp: new Date().toISOString()
  });
}
```

### Обработка оффлайн-режима в компонентах Vue

В компонентах Vue можно создать мixin или composables для обработки оффлайн-режима:

```javascript
// offline-mixin.js
export default {
  data() {
    return {
      isOnline: navigator.onLine
    };
  },
  created() {
    window.addEventListener('online', this.handleOnline);
    window.addEventListener('offline', this.handleOffline);
  },
  destroyed() {
    window.removeEventListener('online', this.handleOnline);
    window.removeEventListener('offline', this.handleOffline);
  },
  methods: {
    handleOnline() {
      this.isOnline = true;
      this.$emit('connection-restored');
    },
    handleOffline() {
      this.isOnline = false;
      this.$emit('connection-lost');
    }
  }
}
```

### Пользовательский интерфейс для оффлайн-режима

Важно информировать пользователя о статусе подключения:

```vue
<template>
  <div>
    <!-- Основной контент -->
    <div v-if="!isOnline" class="offline-banner">
      <p>Вы оффлайн. Некоторые функции могут быть ограничены.</p>
    </div>
    
    <!-- Основной контент приложения -->
    <main>
      <slot></slot>
    </main>
  </div>
</template>

<script>
export default {
  name: 'OfflineHandler',
  data() {
    return {
      isOnline: navigator.onLine
    };
  },
  created() {
    window.addEventListener('online', this.handleOnline);
    window.addEventListener('offline', this.handleOffline);
  },
  destroyed() {
    window.removeEventListener('online', this.handleOnline);
    window.removeEventListener('offline', this.handleOffline);
  },
  methods: {
    handleOnline() {
      this.isOnline = true;
      this.$toast.success('Подключение восстановлено');
    },
    handleOffline() {
      this.isOnline = false;
      this.$toast.warning('Отсутствует подключение к интернету');
    }
  }
}
</script>

<style scoped>
.offline-banner {
  background-color: #ffeb3b;
  color: #333;
  padding: 8px 16px;
  text-align: center;
  position: sticky;
  top: 0;
  z-index: 1000;
}
</style>
```

## Тестирование оффлайн-функционала

Для тестирования оффлайн-функционала рекомендуется:

1. Использовать режим "Offline" в Chrome DevTools
2. Тестировать различные сценарии подключения/отключения
3. Проверять корректность кэширования данных
4. Убедиться в правильной работе при восстановлении подключения

## Лучшие практики

- Кэшировать критически важные для работы приложения ресурсы
- Использовать подходящие стратегии кэширования для разных типов данных
- Обеспечивать понятный пользовательский интерфейс в оффлайн-режиме
- Реализовывать механизм синхронизации данных при восстановлении подключения
- Тестировать приложение в различных сетевых условиях