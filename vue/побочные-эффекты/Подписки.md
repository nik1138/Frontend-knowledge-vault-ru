---
aliases: ["Управление подписками", "Event Subscriptions", "Подписки на события"]
tags: ["#vue", "#subscriptions", "#events", "#effects", "#frontend"]
---

# Подписки

## Обзор

Подписки в Vue.js относятся к механизмам подписки на события, веб-сокеты, RxJS-объекты или другие источники данных, которые требуют управления жизненным циклом подписки. Неправильное управление подписками может привести к утечкам памяти и нежелательному поведению приложения.

## Подписки в Options API

В Options API подписки часто управляются в хуках жизненного цикла:

```javascript
export default {
  data() {
    return {
      eventSource: null,
      messages: []
    }
  },
  
  mounted() {
    // Подписка на глобальное событие
    this.eventSource = new EventSource('/events')
    this.eventSource.onmessage = (event) => {
      this.messages.push(JSON.parse(event.data))
    }
    
    // Подписка на кастомное событие
    this.unsubscribe = this.$bus.$on('custom-event', this.handleCustomEvent)
  },
  
  beforeUnmount() {
    // Отписка при размонтировании
    if (this.eventSource) {
      this.eventSource.close()
    }
    
    if (this.unsubscribe) {
      this.unsubscribe()
    }
  },
  
  methods: {
    handleCustomEvent(data) {
      this.messages.push(data)
    }
  }
}
```

## Подписки в Composition API

В Composition API управление подписками осуществляется с помощью хуков жизненного цикла:

```javascript
import { ref, onMounted, onUnmounted } from 'vue'

export default {
  setup() {
    const messages = ref([])
    let eventSource = null
    let unsubscribe = null

    onMounted(() => {
      // Подписка на события с сервера
      eventSource = new EventSource('/events')
      eventSource.onmessage = (event) => {
        messages.value.push(JSON.parse(event.data))
      }
      
      // Подписка на кастомное событие
      unsubscribe = window.addEventListener('custom-event', handleCustomEvent)
    })

    onUnmounted(() => {
      // Отписка при размонтировании
      if (eventSource) {
        eventSource.close()
        eventSource = null
      }
      
      if (unsubscribe) {
        window.removeEventListener('custom-event', handleCustomEvent)
        unsubscribe = null
      }
    })

    const handleCustomEvent = (event) => {
      messages.value.push(event.detail)
    }

    return { messages }
  }
}
```

## Подписки на веб-сокеты

Управление веб-сокетами требует особого внимания к жизненному циклу:

```javascript
import { ref, onMounted, onUnmounted } from 'vue'

export default {
  setup() {
    const socket = ref(null)
    const messages = ref([])

    onMounted(() => {
      socket.value = new WebSocket('ws://localhost:8080')

      socket.value.onopen = () => {
        console.log('WebSocket соединение установлено')
      }

      socket.value.onmessage = (event) => {
        const message = JSON.parse(event.data)
        messages.value.push(message)
      }

      socket.value.onclose = () => {
        console.log('WebSocket соединение закрыто')
      }
    })

    onUnmounted(() => {
      if (socket.value) {
        socket.value.close()
      }
    })

    const sendMessage = (message) => {
      if (socket.value && socket.value.readyState === WebSocket.OPEN) {
        socket.value.send(JSON.stringify(message))
      }
    }

    return {
      messages,
      sendMessage
    }
  }
}
```

## Подписки с использованием RxJS

При использовании RxJS важно корректно управлять подписками:

```javascript
import { ref, onMounted, onUnmounted } from 'vue'
import { interval, Subscription } from 'rxjs'

export default {
  setup() {
    const count = ref(0)
    let subscription = null

    onMounted(() => {
      subscription = interval(1000).subscribe(value => {
        count.value = value
      })
    })

    onUnmounted(() => {
      if (subscription) {
        subscription.unsubscribe()
      }
    })

    return { count }
  }
}
```

## Управление несколькими подписками

Для управления несколькими подписками можно использовать массив:

```javascript
import { onMounted, onUnmounted } from 'vue'

export default {
  setup() {
    const subscriptions = []

    onMounted(() => {
      // Создание нескольких подписок
      const sub1 = window.addEventListener('resize', handleResize)
      const sub2 = window.addEventListener('scroll', handleScroll)
      
      // Сохранение функций отписки
      subscriptions.push(() => window.removeEventListener('resize', handleResize))
      subscriptions.push(() => window.removeEventListener('scroll', handleScroll))
    })

    onUnmounted(() => {
      // Отписка от всех подписок
      subscriptions.forEach(unsubscribe => unsubscribe())
      subscriptions.length = 0
    })

    const handleResize = () => {
      console.log('Resize event')
    }

    const handleScroll = () => {
      console.log('Scroll event')
    }
  }
}
```

## Подписки в Composables

Часто логику управления подписками выносят в composables:

```javascript
// composables/useEventSubscription.js
import { onMounted, onUnmounted } from 'vue'

export function useEventSubscription(eventType, handler, element = window) {
  onMounted(() => {
    element.addEventListener(eventType, handler)
  })

  onUnmounted(() => {
    element.removeEventListener(eventType, handler)
  })
}

// Использование
import { ref } from 'vue'
import { useEventSubscription } from '@/composables/useEventSubscription'

export default {
  setup() {
    const windowWidth = ref(window.innerWidth)
    
    const handleResize = () => {
      windowWidth.value = window.innerWidth
    }
    
    useEventSubscription('resize', handleResize)
    
    return { windowWidth }
  }
}
```

## Подписки на внешние библиотеки

При использовании внешних библиотек важно управлять их подписками:

```javascript
import { ref, onMounted, onUnmounted } from 'vue'
import Chart from 'chart.js/auto'

export default {
  setup() {
    const chart = ref(null)

    onMounted(() => {
      const ctx = document.getElementById('myChart')
      chart.value = new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['January', 'February', 'March'],
          datasets: [{
            label: 'My First Dataset',
            data: [10, 20, 30]
          }]
        }
      })
      
      // Подписка на события диаграммы
      chart.value.canvas.addEventListener('click', handleClick)
    })

    onUnmounted(() => {
      if (chart.value) {
        chart.value.destroy()
        chart.value.canvas.removeEventListener('click', handleClick)
      }
    })

    const handleClick = (event) => {
      console.log('Chart clicked', event)
    }

    return { chart }
  }
}
```

## Лучшие практики

- **Обязательно отписывайтесь**: Всегда отписывайтесь от событий при размонтировании компонента
- **Используйте onUnmounted**: В Composition API используйте хук `onUnmounted` для отписки
- **Сохраняйте ссылки**: Сохраняйте ссылки на объекты подписок для корректной отписки
- **Проверяйте существование**: Перед отпиской проверяйте, что подписка существует
- **Используйте Composables**: Для повторного использования логики управления подписками

## Связь с другими концепциями

- [[Async-операции]] - для управления асинхронными подписками
- [[Таймеры]] - для управления таймерами как разновидностью подписок
- [[Очистка-эффектов]] - для понимания общих принципов очистки эффектов
- [[Управление-ресурсами]] - для понимания общего подхода к управлению ресурсами

> [!warning] Важно
> Неправильное управление подписками может привести к утечкам памяти и нежелательному поведению приложения.

> [!tip] Совет
> Используйте библиотеки вроде `@vueuse/core` для удобного управления различными типами подписок в Vue 3 приложениях.