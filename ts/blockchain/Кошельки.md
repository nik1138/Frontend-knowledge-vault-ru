---
aliases: [Кошельки, Wallets]
tags: [blockchain, wallets, ethereum, solana, typescript, security, web3]
---

# Кошельки

## Обзор

Кошельки в блокчейне - это инструменты для хранения, отправки и получения криптовалют и токенов. Они содержат пару криптографических ключей (публичный и приватный), которые позволяют пользователям взаимодействовать с блокчейн-сетями.

## Типы кошельков

### 1. Горячие кошельки (Hot Wallets)
- Подключены к интернету
- Быстрый доступ к средствам
- Высокий риск взлома
- Примеры: MetaMask, Phantom, Coinbase Wallet

### 2. Холодные кошельки (Cold Wallets)
- Не подключены к интернету
- Более безопасны
- Примеры: Ledger, Trezor, бумажные кошельки

### 3. Многопользовательские кошельки (Multi-sig)
- Требуют несколько подписей для выполнения транзакций
- Повышенная безопасность
- Используются для хранения средств организациями

## Популярные кошельки

### 1. MetaMask (для Ethereum)
- Расширение для браузера
- Поддержка Ethereum и совместимых сетей
- Интеграция с dApps

#### Подключение к MetaMask
```typescript
import { ethers } from 'ethers';

async function connectToMetaMask() {
  if (typeof window.ethereum !== 'undefined') {
    try {
      // Запрос доступа к аккаунтам
      const accounts = await window.ethereum.request({
        method: 'eth_requestAccounts'
      });
      
      // Создание провайдера и signer
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      
      console.log('Подключен к MetaMask:', accounts[0]);
      return { provider, signer, account: accounts[0] };
    } catch (error) {
      console.error('Ошибка подключения к MetaMask:', error);
      throw error;
    }
  } else {
    throw new Error('MetaMask не установлен');
  }
}
```

### 2. Phantom (для Solana)
- Расширение для браузера
- Основной кошелек для Solana экосистемы
- Поддержка SPL токенов

#### Подключение к Phantom
```typescript
import { Connection, PublicKey } from '@solana/web3.js';

async function connectToPhantom() {
  if ('solana' in window) {
    const provider = (window as any).solana;
    
    if (provider.isPhantom) {
      try {
        const response = await provider.connect();
        const publicKey = response.publicKey;
        
        console.log('Подключен к Phantom:', publicKey.toString());
        return { provider, publicKey };
      } catch (error) {
        console.error('Ошибка подключения к Phantom:', error);
        throw error;
      }
    }
  } else {
    throw new Error('Phantom не установлен');
  }
}
```

### 3. Coinbase Wallet
- Поддержка нескольких блокчейнов
- Мобильное приложение и браузерное расширение
- Интеграция с DEX

## Программное создание кошельков

### 1. Создание кошелька с помощью Ethers.js
```typescript
import { ethers } from 'ethers';

// Создание нового кошелька
const wallet = ethers.Wallet.createRandom();
console.log('Адрес:', wallet.address);
console.log('Приватный ключ:', wallet.privateKey);
console.log('Фраза восстановления:', wallet.mnemonic.phrase);

// Восстановление из приватного ключа
const walletFromPrivateKey = new ethers.Wallet('0x...');
console.log('Восстановленный адрес:', walletFromPrivateKey.address);

// Восстановление из фразы восстановления
const walletFromMnemonic = ethers.Wallet.fromPhrase('...');
```

### 2. Создание кошелька для Solana
```typescript
import { Keypair } from '@solana/web3.js';
import bs58 from 'bs58';

// Создание нового ключевого пары
const keypair = Keypair.generate();
console.log('Публичный ключ:', keypair.publicKey.toString());
console.log('Секретный ключ:', bs58.encode(keypair.secretKey));

// Восстановление из секретного ключа
const secretKey = bs58.decode('...');
const restoredKeypair = Keypair.fromSecretKey(secretKey);
```

## Интеграция кошельков в приложения

### 1. Универсальный класс кошелька
```typescript
interface Wallet {
  connect(): Promise<void>;
  disconnect(): void;
  signMessage(message: string): Promise<string>;
  sendTransaction(transaction: any): Promise<string>;
  getBalance(): Promise<number>;
}

class EthereumWallet implements Wallet {
  private provider: ethers.BrowserProvider | null = null;
  private signer: ethers.Signer | null = null;
  
  async connect() {
    if (typeof window.ethereum !== 'undefined') {
      this.provider = new ethers.BrowserProvider(window.ethereum);
      await this.provider.send('eth_requestAccounts', []);
      this.signer = await this.provider.getSigner();
      console.log('Подключен к Ethereum кошельку');
    } else {
      throw new Error('Ethereum провайдер не найден');
    }
  }
  
  async disconnect() {
    this.provider = null;
    this.signer = null;
  }
  
  async signMessage(message: string): Promise<string> {
    if (!this.signer) throw new Error('Кошелек не подключен');
    return await this.signer.signMessage(message);
  }
  
  async sendTransaction(transaction: any): Promise<string> {
    if (!this.signer) throw new Error('Кошелек не подключен');
    const txResponse = await this.signer.sendTransaction(transaction);
    const receipt = await txResponse.wait();
    return receipt?.hash || txResponse.hash;
  }
  
  async getBalance(): Promise<number> {
    if (!this.signer) throw new Error('Кошелек не подключен');
    const balance = await this.provider?.getBalance(this.signer.getAddress());
    return balance ? Number(ethers.formatEther(balance)) : 0;
  }
}
```

### 2. React хук для управления кошельком
```typescript
import { useState, useEffect } from 'react';

function useWallet() {
  const [wallet, setWallet] = useState<EthereumWallet | null>(null);
  const [isConnected, setIsConnected] = useState(false);
  const [address, setAddress] = useState<string | null>(null);
  const [balance, setBalance] = useState<number | null>(null);
  
  useEffect(() => {
    const savedWallet = localStorage.getItem('connectedWallet');
    if (savedWallet) {
      connectWallet(savedWallet as WalletType);
    }
  }, []);
  
  const connectWallet = async (walletType: WalletType = 'metamask') => {
    try {
      const newWallet = new EthereumWallet();
      await newWallet.connect();
      
      setWallet(newWallet);
      setIsConnected(true);
      
      const addr = await newWallet.signer?.getAddress();
      setAddress(addr || null);
      
      const bal = await newWallet.getBalance();
      setBalance(bal);
      
      localStorage.setItem('connectedWallet', walletType);
    } catch (error) {
      console.error('Ошибка подключения кошелька:', error);
      throw error;
    }
  };
  
  const disconnectWallet = async () => {
    if (wallet) {
      await wallet.disconnect();
    }
    setWallet(null);
    setIsConnected(false);
    setAddress(null);
    setBalance(null);
    localStorage.removeItem('connectedWallet');
  };
  
  return {
    isConnected,
    address,
    balance,
    connectWallet,
    disconnectWallet
  };
}
```

## Безопасность кошельков

### 1. Хранение приватных ключей
```typescript
// Никогда не храните приватные ключи в открытом виде в коде
// Используйте безопасное хранение, например, через браузерное расширение

// Плохо:
const privateKey = '0x...'; // Не делайте этого!

// Хорошо:
// Получение ключа через безопасный метод, например, через провайдер
```

### 2. Защита от фишинга
```typescript
// Проверяйте домен перед подключением кошелька
function verifyDomain() {
  const allowedDomains = ['yourapp.com', 'localhost'];
  const currentDomain = window.location.hostname;
  
  if (!allowedDomains.includes(currentDomain)) {
    throw new Error('Недопустимый домен');
  }
}
```

### 3. Подписание сообщений
```typescript
// Безопасное подписание сообщений
async function signMessageWithWallet(message: string) {
  // Добавьте уникальные данные к сообщению для предотвращения replay атак
  const timestamp = Date.now();
  const domain = window.location.hostname;
  const messageWithMetadata = `Домен: ${domain}\nВремя: ${timestamp}\n\n${message}`;
  
  return await wallet.signMessage(messageWithMetadata);
}
```

## Управление несколькими кошельками

### 1. Менеджер кошельков
```typescript
class WalletManager {
  private wallets: Map<string, Wallet> = new Map();
  private activeWallet: string | null = null;
  
  addWallet(id: string, wallet: Wallet) {
    this.wallets.set(id, wallet);
  }
  
  setActiveWallet(id: string) {
    if (this.wallets.has(id)) {
      this.activeWallet = id;
    } else {
      throw new Error(`Кошелек с ID ${id} не найден`);
    }
  }
  
  getActiveWallet(): Wallet | null {
    if (this.activeWallet) {
      return this.wallets.get(this.activeWallet) || null;
    }
    return null;
  }
  
  async getAllBalances() {
    const balances: Record<string, number> = {};
    
    for (const [id, wallet] of this.wallets) {
      try {
        balances[id] = await wallet.getBalance();
      } catch (error) {
        console.error(`Ошибка получения баланса для кошелька ${id}:`, error);
        balances[id] = 0;
      }
    }
    
    return balances;
  }
}
```

## Интеграция с различными сетями

### 1. Поддержка тестовых сетей
```typescript
import { ethers } from 'ethers';

enum Network {
  MAINNET = 'mainnet',
  SEPOLIA = 'sepolia',
  ROPSTEN = 'ropsten' // Устаревшая
}

async function connectToNetwork(network: Network) {
  let rpcUrl: string;
  
  switch (network) {
    case Network.MAINNET:
      rpcUrl = 'https://mainnet.infura.io/v3/YOUR_PROJECT_ID';
      break;
    case Network.SEPOLIA:
      rpcUrl = 'https://sepolia.infura.io/v3/YOUR_PROJECT_ID';
      break;
    default:
      throw new Error(`Сеть ${network} не поддерживается`);
  }
  
  const provider = new ethers.JsonRpcProvider(rpcUrl);
  return provider;
}
```

### 2. Переключение между сетями
```typescript
async function switchNetwork(chainId: number) {
  try {
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: `0x${chainId.toString(16)}` }]
    });
  } catch (switchError: any) {
    // Если сеть не добавлена, добавляем её
    if (switchError.code === 4902) {
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [
            {
              chainId: `0x${chainId.toString(16)}`,
              chainName: 'Custom Network',
              rpcUrls: ['https://custom-rpc.com']
            }
          ]
        });
      } catch (addError) {
        console.error('Ошибка добавления сети:', addError);
        throw addError;
      }
    }
  }
}
```

## Лучшие практики

1. **Никогда не храните приватные ключи в открытом виде**
2. **Проверяйте домен перед подключением кошелька**
3. **Используйте безопасные методы подписания сообщений**
4. **Обрабатывайте ошибки корректно**
5. **Тестируйте на тестовых сетях**
6. **Используйте минимальные разрешения**

## Связанные темы

- [[Ethereum-и-TypeScript]]
- [[Solana-и-TypeScript]]
- [[Смарт-контракты]]
- [[Web3-библиотеки]]

## Внешние ресурсы

- [MetaMask Documentation](https://docs.metamask.io/)
- [Phantom Documentation](https://docs.phantom.app/)
- [Coinbase Wallet Documentation](https://docs.cloud.coinbase.com/wallet-sdk/docs)
- [EIP-1193 Specification](https://eips.ethereum.org/EIPS/eip-1193)
- [Solana Wallet Standard](https://github.com/solana-labs/wallet-standard)