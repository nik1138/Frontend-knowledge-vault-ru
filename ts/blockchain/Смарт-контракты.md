---
aliases: [Смарт-контракты, Smart Contracts]
tags: [blockchain, smart-contracts, solidity, rust, typescript, ethereum, solana]
---

# Смарт-контракты

## Обзор

Смарт-контракты - это самовыполняющиеся контракты с условиями соглашения, записанными в коде. Они автоматически исполняются при выполнении заранее заданных условий, без необходимости в посредниках.

## Типы смарт-контрактов

### 1. Ethereum смарт-контракты (Solidity)

Solidity - это объектно-ориентированный язык программирования для написания смарт-контрактов на Ethereum.

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

contract SimpleStorage {
    uint256 private value;
    
    event ValueChanged(uint256 newValue);
    
    function set(uint256 _value) public {
        value = _value;
        emit ValueChanged(value);
    }
    
    function get() public view returns (uint256) {
        return value;
    }
}
```

### 2. Solana смарт-контракты (Rust)

На Solana смарт-контракты (программы) пишутся на Rust с использованием фреймворка Anchor.

```rust
use anchor_lang::prelude::*;

#[program]
pub mod simple_storage {
    use super::*;
    
    pub fn initialize(ctx: Context<Initialize>) -> Result<()> {
        ctx.accounts.new_data.value = 0;
        Ok(())
    }
    
    pub fn set_value(ctx: Context<SetValue>, value: u64) -> Result<()> {
        ctx.accounts.data.value = value;
        Ok(())
    }
    
    pub fn get_value(ctx: Context<GetValue>) -> Result<u64> {
        Ok(ctx.accounts.data.value)
    }
}

#[account]
pub struct MyData {
    pub value: u64,
}

#[derive(Accounts)]
pub struct Initialize<'info> {
    #[account(init, payer = user, space = 8 + 8)]
    pub new_data: Account<'info, MyData>,
    #[account(mut)]
    pub user: Signer<'info>,
    pub system_program: Program<'info, System>,
}

#[derive(Accounts)]
pub struct SetValue<'info> {
    #[account(mut)]
    pub data: Account<'info, MyData>,
}

#[derive(Accounts)]
pub struct GetValue<'info> {
    pub data: Account<'info, MyData>,
}
```

## Разработка смарт-контрактов

### Подготовка среды разработки

#### Для Ethereum:
```bash
# Установка Hardhat
npm install --save-dev hardhat

# Инициализация проекта
npx hardhat
```

#### Для Solana:
```bash
# Установка Solana CLI
sh -c "$(curl -sSfL https://release.solana.com/stable/install)"

# Установка Anchor
cargo install --git https://github.com/coral-xyz/anchor avm --locked
avm install latest
avm use latest
```

### Структура проекта

#### Ethereum (Hardhat):
```
contracts/
├── SimpleStorage.sol
scripts/
├── deploy.js
test/
├── SimpleStorage.test.js
hardhat.config.js
```

#### Solana (Anchor):
```
programs/
├── simple-storage/
│   ├── src/
│   │   └── lib.rs
├── migrations/
├── tests/
├── Anchor.toml
├── Cargo.toml
```

## Взаимодействие с контрактами из TypeScript

### Взаимодействие с Ethereum контрактами

```typescript
import { ethers } from 'ethers';

// ABI контракта
const contractABI = [
  "function set(uint256 _value)",
  "function get() view returns (uint256)"
];

// Адрес контракта
const contractAddress = '0x...';

// Подключение к контракту
const contract = new ethers.Contract(contractAddress, contractABI, signer);

// Вызов методов
await contract.set(42);
const value = await contract.get();
console.log('Значение:', value);
```

### Взаимодействие с Solana контрактами

```typescript
import { Program, AnchorProvider, web3 } from '@project-serum/anchor';
import { SimpleStorage } from './types/simple_storage';

// Подключение к программе
const provider = AnchorProvider.local();
const program = new Program(idl, provider);

// Вызов методов
const dataAccount = web3.Keypair.generate();

await program.methods
  .initialize()
  .accounts({
    newData: dataAccount.publicKey,
    user: provider.wallet.publicKey,
    systemProgram: web3.SystemProgram.programId,
  })
  .signers([dataAccount])
  .rpc();

await program.methods
  .setValue(new web3.BN(42))
  .accounts({
    data: dataAccount.publicKey,
  })
  .rpc();

const value = await program.methods
  .getValue()
  .accounts({
    data: dataAccount.publicKey,
  })
  .view();
```

## Безопасность смарт-контрактов

### Распространенные уязвимости

1. **Переполнение/переполнение целого числа**
2. **Рекурсивные вызовы (reentrancy)**
3. **Неправильная проверка авторизации**
4. **Уязвимости в логике контракта**

### Лучшие практики безопасности

```solidity
// Использование SafeMath библиотеки
import "@openzeppelin/contracts/utils/math/SafeMath.sol";

contract SafeContract {
    using SafeMath for uint256;
    
    mapping(address => uint256) private balances;
    
    function deposit() public payable {
        balances[msg.sender] = balances[msg.sender].add(msg.value);
    }
    
    function withdraw(uint256 _amount) public {
        require(balances[msg.sender] >= _amount, "Недостаточно средств");
        balances[msg.sender] = balances[msg.sender].sub(_amount);
        msg.sender.transfer(_amount);
    }
}
```

### Тестирование

```javascript
// Пример теста с Hardhat
describe("SimpleStorage", function() {
  it("Should return the new value once it's changed", async function() {
    const SimpleStorage = await ethers.getContractFactory("SimpleStorage");
    const simpleStorage = await SimpleStorage.deploy();
    await simpleStorage.deployed();

    expect(await simpleStorage.get()).to.equal(0);

    const setValueTx = await simpleStorage.set(42);
    await setValueTx.wait();

    expect(await simpleStorage.get()).to.equal(42);
  });
});
```

## Деплой смарт-контрактов

### Деплой на Ethereum

```javascript
// deploy.js
const hre = require("hardhat");

async function main() {
  const SimpleStorage = await hre.ethers.getContractFactory("SimpleStorage");
  const simpleStorage = await SimpleStorage.deploy();

  await simpleStorage.deployed();

  console.log("SimpleStorage deployed to:", simpleStorage.address);
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
```

### Деплой на Solana

```bash
# Компиляция и деплой
anchor build
anchor deploy
```

## Мониторинг и аудит

### Инструменты аудита

- **Slither** - для Solidity
- **Mythril** - для анализа безопасности
- **Solana Playground** - для тестирования Solana программ

### Мониторинг

```typescript
// Подписка на события контракта
contract.on('ValueChanged', (newValue) => {
  console.log('Новое значение:', newValue);
});
```

## Связанные темы

- [[Ethereum-и-TypeScript]]
- [[Solana-и-TypeScript]]
- [[Web3-библиотеки]]
- [[Кошельки]]

## Внешние ресурсы

- [OpenZeppelin Contracts](https://openzeppelin.com/contracts/)
- [Solidity Documentation](https://docs.soliditylang.org/)
- [Anchor Documentation](https://book.anchor-lang.com/)
- [Hardhat Documentation](https://hardhat.org/)