---
aliases: [Миграции базы данных, База данных миграции, Database Migrations]
tags: [typescript, database, migrations, typeorm, sequelize, prisma]
---

# Миграции баз данных в TypeScript

## Введение

Миграции баз данных - это способ контролировать изменения схемы базы данных с течением времени. Они позволяют безопасно вносить изменения в структуру базы данных, обеспечивая согласованность между различными средами (разработка, тестирование, продакшн) и позволяя легко откатывать изменения при необходимости.

## Основы миграций

Миграции представляют собой файлы, содержащие инструкции для изменения структуры базы данных. Обычно каждая миграция включает в себя:

- `up()` - функцию для применения изменений
- `down()` - функцию для отката изменений

### Принципы работы миграций

1. **Последовательность**: Миграции применяются в строгом порядке
2. **Идемпотентность**: Каждая миграция может быть применена или отменена
3. **Отслеживание**: Система миграций отслеживает, какие миграции уже были применены
4. **Безопасность**: Миграции могут быть отменены в случае ошибок

## Миграции в TypeORM

### Создание миграции

```bash
# Создание новой миграции
npx typeorm migration:create -n CreateUserTable

# Создание миграции из сущности
npx typeorm migration:generate -n CreateUserTable
```

### Структура миграции

```typescript
import { MigrationInterface, QueryRunner, Table } from 'typeorm';

export class CreateUserTable1620000000000 implements MigrationInterface {
  name = 'CreateUserTable1620000000000';

  public async up(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.createTable(new Table({
      name: 'users',
      columns: [
        {
          name: 'id',
          type: 'int',
          isPrimary: true,
          isGenerated: true,
          generationStrategy: 'increment',
        },
        {
          name: 'email',
          type: 'varchar',
          isUnique: true,
          isNullable: false,
        },
        {
          name: 'name',
          type: 'varchar',
          isNullable: false,
        },
        {
          name: 'age',
          type: 'int',
          isNullable: true,
        },
        {
          name: 'created_at',
          type: 'timestamp',
          default: 'now()',
        },
        {
          name: 'updated_at',
          type: 'timestamp',
          default: 'now()',
        },
      ],
    }));
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.dropTable('users');
  }
}
```

### Применение миграций

```bash
# Применить все непримененные миграции
npx typeorm migration:run

# Откатить последнюю миграцию
npx typeorm migration:revert
```

### Создание миграции с отношениями

```typescript
import { MigrationInterface, QueryRunner, Table, TableForeignKey } from 'typeorm';

export class CreatePostTable1620000000001 implements MigrationInterface {
  public async up(queryRunner: QueryRunner): Promise<void> {
    // Создание таблицы постов
    await queryRunner.createTable(new Table({
      name: 'posts',
      columns: [
        {
          name: 'id',
          type: 'int',
          isPrimary: true,
          isGenerated: true,
          generationStrategy: 'increment',
        },
        {
          name: 'title',
          type: 'varchar',
          isNullable: false,
        },
        {
          name: 'content',
          type: 'text',
          isNullable: false,
        },
        {
          name: 'user_id',
          type: 'int',
          isNullable: false,
        },
        {
          name: 'created_at',
          type: 'timestamp',
          default: 'now()',
        },
      ],
    }));

    // Добавление внешнего ключа
    await queryRunner.createForeignKey('posts', new TableForeignKey({
      columnNames: ['user_id'],
      referencedColumnNames: ['id'],
      referencedTableName: 'users',
      onDelete: 'CASCADE',
    }));
  }

  public async down(queryRunner: QueryRunner): Promise<void> {
    await queryRunner.dropTable('posts');
  }
}
```

## Миграции в Sequelize

### Установка CLI

```bash
npm install --save-dev sequelize-cli
npx sequelize-cli init
```

### Создание миграции

```bash
# Создание миграции
npx sequelize-cli migration:generate --name create-users-table
```

### Структура миграции

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

export = {
  up: async (queryInterface: QueryInterface, Sequelize: typeof DataTypes) => {
    await queryInterface.createTable('Users', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      email: {
        type: DataTypes.STRING,
        allowNull: false,
        unique: true,
      },
      name: {
        type: DataTypes.STRING,
        allowNull: false,
      },
      age: {
        type: DataTypes.INTEGER,
        allowNull: true,
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW,
      },
    });
  },
  down: async (queryInterface: QueryInterface, Sequelize: typeof DataTypes) => {
    await queryInterface.dropTable('Users');
  },
};
```

### Миграция с отношениями

```typescript
import { QueryInterface, DataTypes } from 'sequelize';

export = {
  up: async (queryInterface: QueryInterface, Sequelize: typeof DataTypes) => {
    // Создание таблицы постов
    await queryInterface.createTable('Posts', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: DataTypes.INTEGER,
      },
      title: {
        type: DataTypes.STRING,
        allowNull: false,
      },
      content: {
        type: DataTypes.TEXT,
        allowNull: false,
      },
      userId: {
        type: DataTypes.INTEGER,
        allowNull: false,
        references: {
          model: 'Users',
          key: 'id',
        },
        onDelete: 'CASCADE',
      },
      createdAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW,
      },
      updatedAt: {
        allowNull: false,
        type: DataTypes.DATE,
        defaultValue: DataTypes.NOW,
      },
    });
  },
  down: async (queryInterface: QueryInterface, Sequelize: typeof DataTypes) => {
    await queryInterface.dropTable('Posts');
  },
};
```

## Миграции в Prisma

### Создание миграции

```bash
# Создание и применение миграции
npx prisma migrate dev --name create-user-table

# Применение миграций в продакшн
npx prisma migrate deploy
```

### Структура миграции

Prisma генерирует миграции автоматически на основе изменений в файле `schema.prisma`:

```prisma
// schema.prisma
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  name      String
  age       Int?
  posts     Post[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Post {
  id        Int      @id @default(autoincrement())
  title     String
  content   String
  user      User     @relation(fields: [userId], references: [id])
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

### Пример сгенерированной миграции

```sql
-- migrations/20220101000000_create_user_table/migration.sql
-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "age" INTEGER,

    PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User.email_unique" ON "User"("email");
```

## Лучшие практики миграций

### 1. Используйте описательные имена миграций

```typescript
// Хорошо
export class AddAgeToUsers1620000000000 implements MigrationInterface

// Плохо
export class Migration1620000000000 implements MigrationInterface
```

### 2. Проверяйте существование таблиц перед созданием

```typescript
public async up(queryRunner: QueryRunner): Promise<void> {
  const tableExists = await queryRunner.hasTable('users');
  if (!tableExists) {
    await queryRunner.createTable(new Table({
      name: 'users',
      // ... определение таблицы
    }));
  }
}
```

### 3. Используйте транзакции для безопасных изменений

```typescript
public async up(queryRunner: QueryRunner): Promise<void> {
  await queryRunner.query('BEGIN');
  
  try {
    // Выполнение изменений
    await queryRunner.createTable(new Table({
      name: 'users',
      // ... определение таблицы
    }));
    
    await queryRunner.query('COMMIT');
  } catch (error) {
    await queryRunner.query('ROLLBACK');
    throw error;
  }
}
```

### 4. Обрабатывайте зависимости между таблицами

```typescript
// При удалении таблицы с внешними ключами
public async down(queryRunner: QueryRunner): Promise<void> {
  // Сначала удалите таблицы, ссылающиеся на основную
  await queryRunner.dropTable('posts', true);
  await queryRunner.dropTable('users', true);
}
```

### 5. Тестируйте миграции

```typescript
// Тестирование миграции
describe('CreateUserTable Migration', () => {
  let queryRunner: QueryRunner;
  
  beforeAll(async () => {
    const connection = await createConnection(testConfig);
    queryRunner = connection.createQueryRunner();
  });
  
  it('should create users table', async () => {
    await queryRunner.query('BEGIN');
    
    try {
      // Применить миграцию
      const migration = new CreateUserTable1620000000000();
      await migration.up(queryRunner);
      
      // Проверить, что таблица создана
      const tableExists = await queryRunner.hasTable('users');
      expect(tableExists).toBe(true);
      
      // Откатить изменения
      await migration.down(queryRunner);
    } finally {
      await queryRunner.query('ROLLBACK');
    }
  });
});
```

## Управление миграциями в CI/CD

### Пример конфигурации GitHub Actions

```yaml
name: Deploy Database Migrations
on:
  push:
    branches: [main]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    
    - name: Setup Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
        
    - name: Install dependencies
      run: npm install
      
    - name: Run database migrations
      run: npx typeorm migration:run
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
```

## Заключение

Миграции баз данных являются важным инструментом для безопасного управления изменениями схемы базы данных. Они обеспечивают согласованность между различными средами и позволяют легко откатывать изменения при необходимости.

Следующие темы, связанные с миграциями:
- [[ORM-с-TypeScript]]
- [[Типизация-моделей]]
- [[Запросы]]
- [[Транзакции]]

#typescript #database #migrations #typeorm #sequelize #prisma #backend #development