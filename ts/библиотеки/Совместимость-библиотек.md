---
aliases: ["Совместимость библиотек", "Совместимость TypeScript", "Версии TypeScript"]
tags: [typescript, compatibility, libraries, versions]
---

# Совместимость-библиотек

## Обзор

Совместимость библиотек на TypeScript - это важный аспект, который влияет на широкое использование библиотек в различных проектах. Она включает в себя совместимость между различными версиями TypeScript, совместимость с различными средами выполнения и совместимость с другими библиотеками.

## Совместимость версий TypeScript

### Поддержка различных версий

При разработке библиотеки важно учитывать, какие версии TypeScript будут поддерживаться:

```json
{
  "peerDependencies": {
    "typescript": ">=4.0.0"
  },
  "engines": {
    "node": ">=14.0.0"
  }
}
```

### Проверка совместимости

Для проверки совместимости с различными версиями TypeScript:

```bash
# Установка различных версий TypeScript для тестирования
npm install --save-dev typescript@4.0.0
npm install --save-dev typescript@4.5.0
npm install --save-dev typescript@latest

# Запуск компиляции с разными версиями
npx -p typescript@4.0.0 tsc --noEmit
npx -p typescript@4.5.0 tsc --noEmit
npx -p typescript@latest tsc --noEmit
```

### Использование новых возможностей безопасно

```typescript
// Проверка доступности новых возможностей TypeScript
// Вместо использования новых возможностей без проверки:

// Плохо: использование возможностей, недоступных в старых версиях
export type NewType<T> = T satisfies Record<string, unknown>; // Требует TS 4.9+

// Хорошо: использование совместимых возможностей
export type CompatibleType<T> = T extends Record<string, unknown> ? T : never;
```

## Совместимость с различными средами

### Node.js vs Browser

Для обеспечения совместимости с различными средами:

```typescript
// Условная логика для разных сред
export function getPlatformSpecificValue(): string {
  if (typeof window !== 'undefined') {
    // Код для браузера
    return window.location.origin;
  } else if (typeof process !== 'undefined') {
    // Код для Node.js
    return process.env.HOST || 'localhost';
  }
  
  // Резервное значение
  return 'unknown';
}

// Типы для разных сред
export interface PlatformSpecificConfig {
  browser?: Record<string, any>;
  node?: Record<string, any>;
  default?: Record<string, any>;
}
```

### Поддержка ES модулей и CommonJS

```typescript
// package.json для поддержки обоих модулей
{
  "main": "dist/cjs/index.js",
  "module": "dist/esm/index.js",
  "types": "dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist/esm/index.js",
      "require": "./dist/cjs/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

## Совместимость с другими библиотеками

### Peer dependencies

Использование peer dependencies для совместимости с другими библиотеками:

```json
{
  "peerDependencies": {
    "react": ">=16.8.0",
    "vue": ">=3.0.0",
    "lodash": ">=4.17.0"
  },
  "peerDependenciesMeta": {
    "react": {
      "optional": true
    },
    "vue": {
      "optional": true
    }
  }
}
```

### Адаптеры для различных библиотек

```typescript
// Адаптер для работы с различными HTTP-библиотеками
export interface HttpClient {
  get<T>(url: string): Promise<T>;
  post<T>(url: string, data: any): Promise<T>;
  put<T>(url: string, data: any): Promise<T>;
  delete<T>(url: string): Promise<T>;
}

// Адаптер для axios
export class AxiosAdapter implements HttpClient {
  constructor(private axiosInstance: any) {}
  
  async get<T>(url: string): Promise<T> {
    const response = await this.axiosInstance.get(url);
    return response.data;
  }
  
  async post<T>(url: string, data: any): Promise<T> {
    const response = await this.axiosInstance.post(url, data);
    return response.data;
  }
  
  // и т.д.
}

// Адаптер для fetch
export class FetchAdapter implements HttpClient {
  async get<T>(url: string): Promise<T> {
    const response = await fetch(url);
    return response.json();
  }
  
  async post<T>(url: string, data: any): Promise<T> {
    const response = await fetch(url, {
      method: 'POST',
      body: JSON.stringify(data),
      headers: { 'Content-Type': 'application/json' }
    });
    return response.json();
  }
  
  // и т.д.
}
```

## Совместимость API

### Несовместимые изменения (breaking changes)

Правила для несовместимых изменений:

1. **Добавление обязательных параметров** - breaking change
2. **Изменение типа возвращаемого значения** - breaking change
3. **Удаление методов/свойств** - breaking change
4. **Изменение поведения существующих методов** - breaking change

```typescript
// Плохо: добавление обязательного параметра
// v1.0.0
export function processData(data: string): string {
  return data.toUpperCase();
}

// v2.0.0 - breaking change
export function processData(data: string, options: ProcessOptions): string {
  // Это breaking change!
  return data.toUpperCase();
}

// Хорошо: необязательный параметр или новая функция
export function processData(data: string, options?: ProcessOptions): string {
  return data.toUpperCase();
}

// Или новая функция
export function processDataAdvanced(data: string, options: ProcessOptions): string {
  return data.toUpperCase();
}
```

### Миграционные пути

```typescript
// Обеспечение миграционных путей
export interface LegacyOptions {
  timeout: number;
  retries: number;
}

export interface NewOptions {
  timeoutMs: number;
  maxRetries: number;
}

// Функция для преобразования старых опций в новые
export function migrateOptions(legacy: LegacyOptions): NewOptions {
  return {
    timeoutMs: legacy.timeout,
    maxRetries: legacy.retries
  };
}

// Совместимая функция
export function processWithCompatibility(
  data: string, 
  options: NewOptions | LegacyOptions = {}
): string {
  // Проверка типа опций и миграция при необходимости
  const newOptions = isLegacyOptions(options) 
    ? migrateOptions(options) 
    : options;
    
  return processData(data, newOptions);
}

function isLegacyOptions(obj: any): obj is LegacyOptions {
  return 'timeout' in obj && 'retries' in obj;
}
```

## Совместимость типов

### Совместимость структурных типов

```typescript
// TypeScript использует структурную совместимость
export interface Point2D {
  x: number;
  y: number;
}

export interface Point3D {
  x: number;
  y: number;
  z: number;
}

// Point3D совместим с Point2D
export function drawPoint(point: Point2D): void {
  console.log(`Point: (${point.x}, ${point.y})`);
}

const point3D: Point3D = { x: 1, y: 2, z: 3 };
drawPoint(point3D); // Совместимо

// Но Point2D не совместим с Point3D
export function draw3DPoint(point: Point3D): void {
  console.log(`3D Point: (${point.x}, ${point.y}, ${point.z})`);
}

const point2D: Point2D = { x: 1, y: 2 };
// draw3DPoint(point2D); // Ошибка: несовместимо
```

### Совместимость функций

```typescript
// Совместимость функций
export type EventHandler = (data: string) => void;
export type DetailedEventHandler = (data: string, timestamp: number) => void;

// Функция с меньшим количеством параметров совместима
export const simpleHandler: EventHandler = (data) => {
  console.log(data);
};

// Но не наоборот
export const detailedHandler: DetailedEventHandler = (data, timestamp) => {
  console.log(`${data} at ${timestamp}`);
};

// simpleHandler = detailedHandler; // Ошибка
// detailedHandler = simpleHandler; // Работает, но не рекомендуется
```

## Совместимость с полифилами

### Совместимость с полифилами и шимами

```typescript
// Проверка наличия API перед использованием
export function useModernApi(): boolean {
  return typeof fetch !== 'undefined' && 
         typeof Promise !== 'undefined' &&
         typeof Array.prototype.includes !== 'undefined';
}

// Предоставление полифилов
export function ensureCompatibility(): void {
  if (typeof Array.prototype.includes === 'undefined') {
    Array.prototype.includes = function(searchElement: any, fromIndex?: number) {
      return this.indexOf(searchElement, fromIndex) !== -1;
    };
  }
}
```

## Тестирование совместимости

### Многоверсионное тестирование

```typescript
// Конфигурация для тестирования с разными версиями TypeScript
// .github/workflows/compatibility.yml
/*
name: Compatibility Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14.x, 16.x, 18.x]
        typescript-version: [4.0, 4.5, 4.9, latest]
    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install TypeScript ${{ matrix.typescript-version }}
        run: npm install --save-dev typescript@${{ matrix.typescript-version }}
      - name: Run tests
        run: npm test
*/
```

### Тестирование в разных средах

```typescript
// Тесты для разных сред выполнения
describe('Platform compatibility', () => {
  it('should work in browser environment', () => {
    // Мокаем браузерное окружение
    const mockWindow = {
      location: { origin: 'https://example.com' }
    } as any;
    
    Object.defineProperty(global, 'window', {
      value: mockWindow,
      writable: true
    });
    
    const result = getPlatformSpecificValue();
    expect(result).toBe('https://example.com');
  });
  
  it('should work in Node.js environment', () => {
    // Удаляем мок браузера
    Object.defineProperty(global, 'window', {
      value: undefined,
      writable: true
    });
    
    Object.defineProperty(process, 'env', {
      value: { HOST: 'localhost' },
      writable: true
    });
    
    const result = getPlatformSpecificValue();
    expect(result).toBe('localhost');
  });
});
```

## Лучшие практики совместимости

### 1. Постепенное внедрение новых возможностей

```typescript
// Вместо использования новых возможностей сразу
// Плохо: использование возможностей, недоступных в старых версиях
export type NewFeature<T> = T & (T extends string ? { length: number } : {});

// Хорошо: постепенное внедрение с проверками
export type SafeFeature<T> = T extends string 
  ? T & { length: number } 
  : T;
```

### 2. Поддержка различных целевых версий

```json
// Разные конфигурации для разных целевых версий
{
  "compilerOptions": {
    "target": "ES2018",
    "lib": ["ES2018", "DOM"],
    "module": "ES2020",
    "moduleResolution": "node"
  }
}
```

### 3. Документирование требований совместимости

```markdown
## Требования совместимости

- TypeScript: >=4.0.0
- Node.js: >=14.0.0
- Поддерживаемые браузеры: Chrome 70+, Firefox 65+, Safari 13+
- Поддерживаемые модули: ES modules, CommonJS
```

## Связанные темы

- [[Создание-библиотек]]
- [[Публикация-на-npm]]
- [[Типизация-библиотек]]
- [[Документация-библиотек]]
- [[TypeScript]]
- [[Версии TypeScript]]