---
aliases: [Build and Deploy, Сборка и Деплой]
tags: [typescript, ci-cd, build, deployment, automation]
---

# Сборка и деплой в CI/CD процессах TypeScript-проектов

## Обзор

Сборка и деплой являются ключевыми этапами в CI/CD процессе TypeScript-проектов. Эти этапы преобразуют исходный код в готовый к использованию продукт и развертывают его в различных средах.

## Процесс сборки TypeScript

### Компиляция TypeScript

TypeScript требует компиляции в JavaScript перед выполнением. Процесс компиляции контролируется файлом `tsconfig.json`.

#### Пример tsconfig.json для продакшена

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "removeComments": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "strictFunctionTypes": true,
    "noImplicitThis": true,
    "noImplicitReturns": true,
    "noFallthroughCasesInSwitch": true
  },
  "include": [
    "src/**/*"
  ],
  "exclude": [
    "node_modules",
    "test",
    "dist",
    "**/*spec.ts"
  ]
}
```

#### Команда компиляции

```bash
# Компиляция TypeScript
tsc

# Компиляция с указанием конфигурационного файла
tsc -p tsconfig.json

# Компиляция в режиме watch
tsc -w
```

### Использование TypeScript с Webpack

```javascript
// webpack.config.js
const path = require('path');

module.exports = {
  entry: './src/index.ts',
  module: {
    rules: [
      {
        test: /\.tsx?$/,
        use: 'ts-loader',
        exclude: /node_modules/,
      },
    ],
  },
  resolve: {
    extensions: ['.tsx', '.ts', '.js'],
  },
  output: {
    filename: 'bundle.js',
    path: path.resolve(__dirname, 'dist'),
  },
};
```

### Использование TypeScript с Rollup

```javascript
// rollup.config.js
import typescript from '@rollup/plugin-typescript';

export default {
  input: 'src/main.ts',
  output: {
    dir: 'dist',
    format: 'esm'
  },
  plugins: [
    typescript({ 
      tsconfig: './tsconfig.json' 
    })
  ]
};
```

## Стратегии деплоя

### Деплой на GitHub Pages

```yaml
name: Deploy to GitHub Pages
on:
  push:
    branches: [main]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    - name: Install dependencies
      run: npm ci
    - name: Build
      run: npm run build
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
```

### Деплой в Docker контейнере

```dockerfile
# Dockerfile
FROM node:18-alpine AS builder

WORKDIR /app
COPY package*.json ./
RUN npm ci

COPY . .
RUN npm run build

FROM node:18-alpine AS runtime

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY --from=builder /app/dist ./dist
COPY --from=builder /app/public ./public

EXPOSE 3000
CMD ["node", "dist/index.js"]
```

### Деплой на облачные платформы

#### AWS Lambda

```yaml
# serverless.yml
service: my-typescript-service

provider:
  name: aws
  runtime: nodejs18.x
  stage: ${opt:stage, 'dev'}

functions:
  hello:
    handler: dist/handler.hello
    events:
      - http:
          path: hello
          method: get

plugins:
  - serverless-plugin-typescript

package:
  exclude:
    - 'src/**'
    - 'node_modules/**'
```

#### Vercel

```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/node",
      "config": {
        "includeFiles": ["dist/**"]
      }
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "dist/index.js"
    }
  ]
}
```

## CI/CD конфигурации

### GitHub Actions

```yaml
name: Build and Deploy
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x]

    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    - name: Install dependencies
      run: npm ci
    - name: Run tests
      run: npm run test
    - name: Run linting
      run: npm run lint
    - name: Build
      run: npm run build
    - name: Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: build-files
        path: dist/
        retention-days: 30

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v3
      with:
        name: build-files
        path: dist/
    - name: Deploy to production
      run: |
        # Код деплоя в продакшен
        echo "Deploying to production..."
```

### GitLab CI

```yaml
stages:
  - test
  - build
  - deploy

variables:
  NODE_VERSION: '18'
  BUILD_PATH: './dist'

.test_template: &test_definition
  script:
    - npm ci
    - npm run test
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

build:
  stage: build
  image: node:${NODE_VERSION}
  script:
    - npm ci
    - npm run build
  artifacts:
    paths:
      - $BUILD_PATH/
    expire_in: 1 week
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/

deploy_staging:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "Deploying to staging environment..."
    - # Команды деплоя в staging
  environment:
    name: staging
  when: manual
  only:
    - develop

deploy_production:
  stage: deploy
  image: node:${NODE_VERSION}
  script:
    - echo "Deploying to production environment..."
    - # Команды деплоя в production
  environment:
    name: production
  when: manual
  only:
    - main
  dependencies:
    - build
```

### Jenkins Pipeline

```groovy
pipeline {
    agent any
    
    tools {
        nodejs "NodeJS-18"
    }
    
    environment {
        BUILD_PATH = 'dist'
        NODE_ENV = 'production'
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Install Dependencies') {
            steps {
                sh 'npm ci'
            }
        }
        
        stage('Lint') {
            steps {
                sh 'npm run lint'
            }
        }
        
        stage('Test') {
            steps {
                sh 'npm run test:ci'
            }
        }
        
        stage('Build') {
            steps {
                sh 'npm run build'
            }
            post {
                always {
                    archiveArtifacts artifacts: "${BUILD_PATH}/**", fingerprint: true
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'develop'
            }
            steps {
                sh 'npm run deploy:staging'
            }
        }
        
        stage('Deploy to Production') {
            when {
                branch 'main'
            }
            steps {
                input message: 'Deploy to production?', ok: 'Deploy'
                sh 'npm run deploy:production'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
        success {
            echo 'Build and deployment successful!'
        }
        failure {
            echo 'Build or deployment failed!'
        }
    }
}
```

## Оптимизация сборки

### Уменьшение времени сборки

1. **Использование incremental compilation**:
   ```json
   {
     "compilerOptions": {
       "incremental": true,
       "tsBuildInfoFile": ".tsbuildinfo"
     }
   }
   ```

2. **Параллельная сборка**:
   ```bash
   # Использование esbuild для быстрой сборки
   npx esbuild src/index.ts --bundle --outfile=dist/index.js --target=es2020
   ```

3. **Кэширование зависимостей**:
   - В CI/CD системах использовать кэширование `node_modules`
   - Использовать `npm ci` вместо `npm install`

### Tree Shaking

Для уменьшения размера конечного бандла:

```javascript
// webpack.config.js
module.exports = {
  mode: 'production', // Включает tree shaking
  optimization: {
    usedExports: true,
    sideEffects: false
  }
};
```

## Лучшие практики

1. **Разделяйте конфигурации для разных сред**
2. **Используйте environment variables для конфигурации**
3. **Оптимизируйте размер конечного бандла**
4. **Тестируйте сборку перед деплоем**
5. **Используйте артефакты сборки в последующих этапах**
6. **Реализуйте безопасный деплой (blue-green, canary)**
7. **Мониторьте успешность сборки и деплоя**

## Связанные темы

- [[Проверка-типов]]
- [[Тестирование-и-линтинг]]
- [[Мониторинг-при-развертывании]]
- [[Откат-изменений]]
- [[Конфигурация-TypeScript]]