---
aliases: [Линтинг, Testing and Linting, Тестирование и Линтинг]
tags: [typescript, ci-cd, testing, linting, code-quality]
---

# Тестирование и линтинг в CI/CD процессах TypeScript-проектов

## Обзор

Тестирование и линтинг являются неотъемлемыми частями CI/CD процесса для TypeScript-проектов. Они обеспечивают качество кода, согласованность стиля и выявление потенциальных проблем до развертывания.

## Типы тестирования

### Модульное тестирование (Unit Testing)

Для TypeScript проектов часто используются:

- **Jest** с поддержкой TypeScript
- **Vitest** - быстрый тестовый раннер
- **Mocha** с **Chai** и **ts-node**

#### Пример конфигурации Jest

```json
{
  "name": "my-typescript-project",
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage"
  },
  "devDependencies": {
    "jest": "^29.0.0",
    "@types/jest": "^29.0.0",
    "ts-jest": "^29.0.0",
    "typescript": "^5.0.0"
  }
}
```

Файл `jest.config.js`:

```javascript
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/src'],
  testMatch: ['**/__tests__/**/*.+(ts|tsx|js)', '**/?(*.)+(spec|test).+(ts|tsx|js)'],
  transform: {
    '^.+\\.(ts|tsx)$': 'ts-jest',
  },
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json', 'node'],
};
```

#### Пример теста

```typescript
// calculator.ts
export class Calculator {
  add(a: number, b: number): number {
    return a + b;
  }

  divide(a: number, b: number): number {
    if (b === 0) {
      throw new Error('Division by zero');
    }
    return a / b;
  }
}

// calculator.test.ts
import { Calculator } from './calculator';

describe('Calculator', () => {
  let calculator: Calculator;

  beforeEach(() => {
    calculator = new Calculator();
  });

  test('should add two numbers correctly', () => {
    expect(calculator.add(2, 3)).toBe(5);
  });

  test('should throw error when dividing by zero', () => {
    expect(() => calculator.divide(10, 0)).toThrow('Division by zero');
  });
});
```

### Интеграционное тестирование

Тестирование взаимодействия между модулями:

```typescript
// api.service.test.ts
import { ApiService } from './api.service';
import { MockHttpService } from '../__mocks__/http.service';

describe('ApiService Integration', () => {
  let apiService: ApiService;
  let mockHttpService: MockHttpService;

  beforeEach(() => {
    mockHttpService = new MockHttpService();
    apiService = new ApiService(mockHttpService);
  });

  test('should fetch user data', async () => {
    const mockUser = { id: 1, name: 'John Doe' };
    mockHttpService.mockResponse = mockUser;

    const user = await apiService.getUser(1);

    expect(user).toEqual(mockUser);
    expect(mockHttpService.get).toHaveBeenCalledWith('/users/1');
  });
});
```

## Линтинг TypeScript кода

### ESLint с TypeScript

ESLint является стандартом для линтинга JavaScript и TypeScript кода.

#### Установка зависимостей

```bash
npm install --save-dev eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin
```

#### Конфигурация ESLint

Файл `.eslintrc.js`:

```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  extends: [
    '@typescript-eslint/recommended',
  ],
  plugins: [
    '@typescript-eslint',
  ],
  parserOptions: {
    ecmaVersion: 2020,
    sourceType: 'module',
  },
  rules: {
    // Пользовательские правила
    '@typescript-eslint/explicit-function-return-type': 'warn',
    '@typescript-eslint/no-explicit-any': 'error',
    '@typescript-eslint/no-unused-vars': 'error',
    '@typescript-eslint/semi': ['error'],
    'quotes': ['error', 'single'],
    'semi': ['error', 'always'],
  },
  env: {
    jest: true,
  },
};
```

### Popular TypeScript ESLint Rules

- `@typescript-eslint/no-explicit-any` - Запрещает использование типа `any`
- `@typescript-eslint/explicit-function-return-type` - Требует явного указания возвращаемого типа функций
- `@typescript-eslint/no-unused-vars` - Обнаруживает неиспользуемые переменные
- `@typescript-eslint/prefer-const` - Предпочитает `const` вместо `let` когда возможно

## Интеграция с CI/CD

### GitHub Actions

```yaml
name: Testing and Linting
on: [push, pull_request]
jobs:
  test-and-lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [16.x, 18.x, 20.x]
    steps:
    - uses: actions/checkout@v3
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install dependencies
      run: npm ci
    - name: Run linting
      run: npm run lint
    - name: Run tests
      run: npm run test:ci
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
```

### GitLab CI

```yaml
stages:
  - test
  - lint

variables:
  NODE_VERSION: '18'

before_script:
  - npm ci

test:
  stage: test
  script:
    - npm run test:ci
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  coverage: '/Statements\s+:\s+(\d+.\d+\%)/'

lint:
  stage: lint
  script:
    - npm run lint
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
```

## Продвинутые практики

### Использование Prettier для форматирования

```bash
npm install --save-dev prettier
```

`.prettierrc`:

```json
{
  "semi": true,
  "trailingComma": "all",
  "singleQuote": true,
  "printWidth": 80,
  "tabWidth": 2
}
```

Интеграция с ESLint:

```bash
npm install --save-dev eslint-config-prettier eslint-plugin-prettier
```

Обновленный `.eslintrc.js`:

```javascript
module.exports = {
  parser: '@typescript-eslint/parser',
  extends: [
    '@typescript-eslint/recommended',
    'plugin:prettier/recommended', // Добавляет правила Prettier
  ],
  plugins: [
    '@typescript-eslint',
    'prettier',
  ],
  rules: {
    'prettier/prettier': 'error',
    // Другие правила
  },
};
```

### Использование Husky для pre-commit хуков

```bash
npm install --save-dev husky lint-staged
npx husky install
npx husky add .husky/pre-commit "npx lint-staged"
```

`package.json`:

```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write",
      "git add"
    ]
  }
}
```

### Покрытие кода тестами

Для Jest:

```json
{
  "scripts": {
    "test:coverage": "jest --coverage",
    "test:ci": "jest --ci --coverage --coverageReporters=text-lcov | node_modules/.bin/codecov"
  }
}
```

## Лучшие практики

1. **Тестирование должно быть быстрым и надежным**
2. **Каждый коммит должен проходить проверки линтинга**
3. **Использовать строгие настройки ESLint для TypeScript**
4. **Обеспечивать минимальный порог покрытия тестами (например, 80%)**
5. **Использовать форматирование кода (Prettier) для согласованности**
6. **Выполнять тесты и линтинг в CI перед слиянием**

## Связанные темы

- [[Проверка-типов]]
- [[Сборка-и-деплой]]
- [[Тип-безопасность]]
- [[Мониторинг-при-развертывании]]