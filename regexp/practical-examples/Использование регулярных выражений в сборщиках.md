---
aliases: ["Регулярные выражения в сборщиках", "Regex in Build Tools"]
tags: [regexp, webpack, vite, build-tools, configuration]
---

# Использование регулярных выражений в сборщиках (Webpack, Vite)

## Общие принципы использования регулярных выражений в сборщиках

Сборщики модулей, такие как Webpack и Vite, активно используют регулярные выражения для определения файлов, которые нужно обработать определенным образом. Это позволяет гибко настраивать правила обработки ресурсов в зависимости от их расширения, расположения или других признаков.

## Использование в Webpack

### 1. Правила загрузки файлов (module.rules)

```javascript
// webpack.config.js
const path = require('path');

module.exports = {
  entry: './src/index.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js'
  },
  module: {
    rules: [
      // Загрузка JavaScript файлов
      {
        test: /\.js$/,  // Регулярное выражение для JS файлов
        exclude: /node_modules/,  // Исключаем node_modules
        use: {
          loader: 'babel-loader',
          options: {
            presets: ['@babel/preset-env']
          }
        }
      },
      
      // Загрузка TypeScript файлов
      {
        test: /\.tsx?$/,  // Регулярное выражение для TS/TSX файлов
        exclude: /node_modules/,
        use: 'ts-loader'
      },
      
      // Загрузка CSS файлов
      {
        test: /\.css$/,  // Регулярное выражение для CSS файлов
        use: ['style-loader', 'css-loader']
      },
      
      // Загрузка SASS/SCSS файлов
      {
        test: /\.s[ac]ss$/i,  // Регулярное выражение для SASS/SCSS файлов
        use: [
          'style-loader',
          'css-loader',
          'sass-loader'
        ]
      },
      
      // Загрузка изображений
      {
        test: /\.(png|jpe?g|gif|svg|webp)$/i,  // Регулярное выражение для изображений
        type: 'asset/resource',
        generator: {
          filename: 'images/[name].[hash:8][ext]'
        }
      },
      
      // Загрузка шрифтов
      {
        test: /\.(woff|woff2|eot|ttf|otf)$/i,  // Регулярное выражение для шрифтов
        type: 'asset/resource',
        generator: {
          filename: 'fonts/[name].[hash:8][ext]'
        }
      },
      
      // Загрузка JSON файлов
      {
        test: /\.json$/,  // Регулярное выражение для JSON файлов
        type: 'json'
      }
    ]
  },
  resolve: {
    extensions: ['.js', '.jsx', '.ts', '.tsx', '.json']  // Регулярные выражения для расширений
  }
};
```

### 2. Именование файлов и генерация

```javascript
// webpack.config.js - пример с регулярными выражениями для именования
const path = require('path');

module.exports = {
  entry: './src/index.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: '[name].[contenthash:8].js',  // Использование хеша в имени
    chunkFilename: '[name].[contenthash:8].chunk.js'
  },
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          {
            loader: 'file-loader',
            options: {
              name: '[name].[contenthash:8].[ext]',  // Регулярное выражение для формата имени
              outputPath: 'css/'
            }
          },
          'extract-css-loader'
        ]
      }
    ]
  }
};
```

### 3. Условия и исключения

```javascript
// webpack.config.js - сложные условия с регулярными выражениями
module.exports = {
  module: {
    rules: [
      // Обработка файлов в определенных директориях
      {
        test: /\.js$/,
        include: path.resolve(__dirname, 'src/components'),  // Включаем только файлы из компонентов
        use: {
          loader: 'babel-loader',
          options: {
            presets: ['@babel/preset-react']
          }
        }
      },
      
      // Исключение файлов из обработки
      {
        test: /\.js$/,
        exclude: [
          /node_modules/,  // Регулярное выражение для исключения node_modules
          /vendor/  // Регулярное выражение для исключения vendor директории
        ],
        use: 'eslint-loader'
      },
      
      // Обработка файлов с определенными суффиксами
      {
        test: /.*\.test\.js$/,  // Регулярное выражение для тестовых файлов
        use: 'jest-loader'
      }
    ]
  }
};
```

### 4. Плагины, использующие регулярные выражения

```javascript
const HtmlWebpackPlugin = require('html-webpack-plugin');
const MiniCssExtractPlugin = require('mini-css-extract-plugin');
const path = require('path');

module.exports = {
  plugins: [
    new HtmlWebpackPlugin({
      template: './src/index.html'
    }),
    new MiniCssExtractPlugin({
      filename: 'css/[name].[contenthash:8].css',  // Регулярное выражение для формата имени
      chunkFilename: 'css/[id].[contenthash:8].css'
    })
  ],
  module: {
    rules: [
      {
        test: /\.css$/,
        use: [
          MiniCssExtractPlugin.loader,
          'css-loader'
        ]
      },
      {
        test: /\.(js|jsx)$/,
        exclude: /node_modules/,
        use: {
          loader: 'babel-loader',
          options: {
            presets: ['@babel/preset-env', '@babel/preset-react'],
            plugins: [
              // Условная загрузка плагинов на основе регулярных выражений
              ['@babel/plugin-transform-runtime', {
                regenerator: true
              }]
            ]
          }
        }
      }
    ]
  }
};
```

## Использование в Vite

### 1. Конфигурация Vite с регулярными выражениями

```javascript
// vite.config.js
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  build: {
    rollupOptions: {
      input: {
        main: './index.html',
        nested: './nested/index.html'
      },
      output: {
        assetFileNames: (assetInfo) => {
          // Регулярное выражение для определения типа ресурса
          if (assetInfo.name.endsWith('.css')) {
            return 'css/[name].[hash][extname]';
          }
          
          if (/\.(png|jpe?g|gif|svg|webp)$/i.test(assetInfo.name)) {
            return 'images/[name].[hash][extname]';
          }
          
          if (/\.(woff|woff2|eot|ttf|otf)$/i.test(assetInfo.name)) {
            return 'fonts/[name].[hash][extname]';
          }
          
          return '[name].[hash][extname]';
        }
      }
    }
  },
  css: {
    preprocessorOptions: {
      scss: {
        additionalData: `@import "src/styles/variables.scss";`
      }
    }
  }
});
```

### 2. Пользовательские плагины с регулярными выражениями

```javascript
// vite-plugin-custom-regex.js
import { createFilter } from '@rollup/pluginutils';

export default function customRegexPlugin(options = {}) {
  // Создание фильтра с использованием регулярных выражений
  const filter = createFilter(
    options.include || [/\.(custom)$/],  // Регулярное выражение для включения файлов
    options.exclude || [/node_modules/]   // Регулярное выражение для исключения файлов
  );

  return {
    name: 'custom-regex',
    transform(code, id) {
      if (filter(id)) {
        // Обработка файла с использованием регулярных выражений
        const processedCode = code
          .replace(/CUSTOM_IMPORT\(([^)]+)\)/g, (match, path) => {
            // Регулярное выражение для замены специальных импортов
            return `import ${path.replace(/\W/g, '_')} from '${path}';`;
          });
        
        return {
          code: processedCode,
          map: null
        };
      }
    }
  };
}
```

### 3. Обработка файлов по регулярным выражениям

```javascript
// vite.config.js - пример с обработкой файлов по регулярным выражениям
import { defineConfig } from 'vite';
import { ViteEjsPlugin } from 'vite-plugin-ejs';

export default defineConfig({
  plugins: [
    ViteEjsPlugin((viteDevServer) => {
      return {
        title: 'My App',
        // Условия с регулярными выражениями для разных окружений
        isDev: /localhost|127\.0\.0\.1/.test(viteDevServer.config.server.host)
      };
    }),
    {
      name: 'regex-processor',
      transform(code, id) {
        // Обработка файлов с определенными расширениями
        if (/\.(txt|md)$/.test(id)) {
          // Замена специальных тегов с помощью регулярных выражений
          const transformed = code
            .replace(/<%=(.+?)%>/g, (match, expression) => {
              return `\${${expression}}`;
            });
          
          return {
            code: transformed,
            map: null
          };
        }
      }
    }
  ]
});
```

## Практические примеры

### 1. Условная обработка файлов

```javascript
// webpack.config.js - условная обработка в зависимости от окружения
const path = require('path');

module.exports = (env, argv) => {
  const isProduction = argv.mode === 'production';
  
  return {
    module: {
      rules: [
        {
          test: /\.js$/,
          exclude: /node_modules/,
          use: {
            loader: 'babel-loader',
            options: {
              presets: [
                ['@babel/preset-env', {
                  targets: {
                    browsers: isProduction 
                      ? ['> 1%', 'last 2 versions']  // Регулярное выражение для целевых браузеров
                      : 'defaults'
                  }
                }]
              ]
            }
          }
        },
        // Условная обработка CSS в зависимости от окружения
        {
          test: /\.css$/,
          use: isProduction 
            ? [MiniCssExtractPlugin.loader, 'css-loader', 'postcss-loader']
            : ['style-loader', 'css-loader', 'postcss-loader']
        }
      ]
    }
  };
};
```

### 2. Замена переменных среды

```javascript
// webpack.config.js - замена переменных среды с регулярными выражениями
const webpack = require('webpack');

module.exports = {
  plugins: [
    new webpack.DefinePlugin({
      'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),
      '__API_URL__': JSON.stringify(process.env.API_URL)
    })
  ],
  module: {
    rules: [
      {
        test: /\.js$/,
        use: {
          loader: 'string-replace-loader',
          options: {
            multiple: [
              {
                search: /__VERSION__/g,  // Регулярное выражение для версии
                replace: process.env.npm_package_version,
                flags: 'g'
              },
              {
                search: /__BUILD_TIME__/g,  // Регулярное выражение для времени сборки
                replace: new Date().toISOString(),
                flags: 'g'
              }
            ]
          }
        }
      }
    ]
  }
};
```

### 3. Обработка изображений с оптимизацией

```javascript
// webpack.config.js - обработка изображений с оптимизацией
module.exports = {
  module: {
    rules: [
      {
        test: /\.(png|jpe?g|gif|svg)$/i,
        oneOf: [
          // Оптимизация изображений в продакшене
          {
            test: (assetPath) => {
              // Регулярное выражение для проверки пути к изображению
              return /assets\/images\/optimized/.test(assetPath);
            },
            use: [
              {
                loader: 'image-webpack-loader',
                options: {
                  mozjpeg: { progressive: true, quality: 65 },
                  optipng: { enabled: false },
                  pngquant: { quality: [0.65, 0.90], speed: 4 },
                  gifsicle: { interlaced: false }
                }
              },
              {
                loader: 'file-loader',
                options: {
                  name: 'images/optimized/[name].[hash:7].[ext]'
                }
              }
            ]
          },
          // Обычная обработка остальных изображений
          {
            use: {
              loader: 'file-loader',
              options: {
                name: 'images/[name].[hash:7].[ext]'
              }
            }
          }
        ]
      }
    ]
  }
};
```

### 4. Обработка шаблонов

```javascript
// webpack.config.js - обработка шаблонов с регулярными выражениями
module.exports = {
  module: {
    rules: [
      {
        test: /\.template\.js$/,
        use: [
          {
            loader: 'babel-loader'
          },
          {
            loader: 'template-regex-loader',  // Пользовательский лоадер
            options: {
              patterns: [
                {
                  // Регулярное выражение для замены переменных в шаблонах
                  regex: /{{\s*(\w+)\s*}}/g,
                  replacement: (match, variable) => {
                    return `\${process.env.${variable}}`;
                  }
                },
                {
                  // Регулярное выражение для обработки условий
                  regex: /{%\s*if\s+(\w+)\s*%}(.*?){%\s*endif\s*%}/gs,
                  replacement: (match, variable, content) => {
                    return `\${${variable} ? \`${content}\` : ''}`;
                  }
                }
              ]
            }
          }
        ]
      }
    ]
  }
};
```

## Рекомендации по использованию

### 1. Производительность
- Используйте максимально специфичные регулярные выражения
- Избегайте чрезмерно сложных выражений
- Кэшируйте результаты, когда это возможно

### 2. Поддерживаемость
- Комментируйте сложные регулярные выражения
- Используйте именованные константы для сложных выражений

```javascript
// Пример хорошей практики
const IMAGE_FILE_REGEX = /\.(png|jpe?g|gif|svg|webp)$/i;
const JS_FILE_REGEX = /\.js$/;
const EXCLUDE_NODE_MODULES_REGEX = /node_modules/;

module.exports = {
  module: {
    rules: [
      {
        test: JS_FILE_REGEX,
        exclude: EXCLUDE_NODE_MODULES_REGEX,
        use: 'babel-loader'
      },
      {
        test: IMAGE_FILE_REGEX,
        type: 'asset/resource'
      }
    ]
  }
};
```

### 3. Отладка
- Используйте инструменты для тестирования регулярных выражений
- Включайте подробный лог сборки для отладки проблем с матчингом файлов

## Заключение

Регулярные выражения в сборщиках модулей позволяют гибко настраивать обработку файлов в зависимости от их типа, расположения и других признаков. Они обеспечивают мощный инструмент для кастомизации процесса сборки, позволяя оптимизировать производительность и улучшить организацию проекта.

Ключевые моменты:
- Используйте регулярные выражения для определения типов файлов
- Применяйте условия и исключения для точной настройки
- Оптимизируйте производительность, избегая сложных выражений
- Комментируйте сложные регулярные выражения для лучшей поддерживаемости