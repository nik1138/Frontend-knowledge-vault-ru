---
aliases: ["Сбор метрик", "Метрики производительности", "Frontend Metrics Collection"]
tags: 
  - monitoring
  - metrics
  - frontend
  - performance
---

# Сбор метрик фронтенд-приложений

## Обзор

Сбор метрик фронтенд-приложений - это процесс измерения и регистрации различных показателей производительности, взаимодействия пользователя и состояния приложения. Эти метрики позволяют разработчикам понимать, как пользователи взаимодействуют с приложением, и выявлять потенциальные проблемы с производительностью.

## Типы метрик

### 1. Метрики производительности (Web Vitals)

#### Core Web Vitals

- **Largest Contentful Paint (LCP)** - время загрузки основного контента
- **First Input Delay (FID)** - задержка первого взаимодействия
- **Cumulative Layout Shift (CLS)** - стабильность макета

```javascript
// Сбор Core Web Vitals с помощью Web Vitals библиотеки
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

function sendToAnalytics(metric) {
  // Отправляем метрики на нашу систему мониторинга
  navigator.sendBeacon('/analytics', JSON.stringify(metric));
}

getCLS(sendToAnalytics);
getFID(sendToAnalytics);
getFCP(sendToAnalytics);
getLCP(sendToAnalytics);
getTTFB(sendToAnalytics);
```

#### Дополнительные метрики

- **First Contentful Paint (FCP)** - первая отрисовка контента
- **Time to First Byte (TTFB)** - время до первого байта
- **DOMContentLoaded** - загрузка DOM
- **Load Event** - полная загрузка страницы

### 2. Метрики взаимодействия

- **Interaction to Next Paint (INP)** - время отклика на взаимодействие
- **Total Blocking Time (TBT)** - общее время блокировки
- **Long Tasks** - длительные задачи в основном потоке

### 3. Бизнес-метрики

- **Conversion Rate** - коэффициент конверсии
- **Time on Page** - время на странице
- **Click-through Rate** - процент переходов
- **Session Duration** - продолжительность сессии

## API для сбора метрик

### 1. Navigation Timing API

```javascript
// Сбор метрик времени загрузки страницы
function getNavigationMetrics() {
  const perfData = performance.getEntriesByType('navigation')[0];
  
  return {
    dnsTime: perfData.domainLookupEnd - perfData.domainLookupStart,
    tcpTime: perfData.connectEnd - perfData.connectStart,
    responseTime: perfData.responseEnd - perfData.responseStart,
    domLoadTime: perfData.domContentLoadedEventEnd - perfData.navigationStart,
    pageLoadTime: perfData.loadEventEnd - perfData.navigationStart
  };
}
```

### 2. Resource Timing API

```javascript
// Сбор метрик загрузки ресурсов
function getResourceMetrics() {
  const resources = performance.getEntriesByType('resource');
  
  return resources.map(resource => ({
    name: resource.name,
    duration: resource.duration,
    transferSize: resource.transferSize,
    contentType: resource.responseEnd - resource.responseStart
  }));
}
```

### 3. Paint Timing API

```javascript
// Сбор метрик отрисовки
function getPaintMetrics() {
  const paintEntries = performance.getEntriesByType('paint');
  
  const metrics = {};
  paintEntries.forEach(entry => {
    metrics[entry.name] = entry.startTime;
  });
  
  return metrics; // { 'first-paint': 123.45, 'first-contentful-paint': 234.56 }
}
```

### 4. Long Tasks API

```javascript
// Отслеживание длительных задач
function observeLongTasks() {
  if ('PerformanceObserver' in window) {
    const observer = new PerformanceObserver((list) => {
      list.getEntries().forEach(entry => {
        if (entry.duration > 50) { // Долгая задача > 50мс
          console.warn('Long task detected:', {
            duration: entry.duration,
            startTime: entry.startTime
          });
        }
      });
    });
    
    observer.observe({ entryTypes: ['longtask'] });
  }
}
```

## Практические рекомендации

### 1. Асинхронная отправка метрик

```javascript
// Отправка метрик без блокировки основного потока
function sendMetricsAsync(metrics) {
  // Используем requestIdleCallback для отправки данных
  if ('requestIdleCallback' in window) {
    requestIdleCallback(() => {
      navigator.sendBeacon('/metrics', JSON.stringify(metrics));
    });
  } else {
    // Резервный вариант для старых браузеров
    setTimeout(() => {
      navigator.sendBeacon('/metrics', JSON.stringify(metrics));
    }, 0);
  }
}
```

### 2. Батчинг метрик

```javascript
// Группировка метрик для оптимизации отправки
class MetricsBatcher {
  constructor(batchSize = 10, timeout = 5000) {
    this.batchSize = batchSize;
    this.timeout = timeout;
    this.queue = [];
    this.timer = null;
  }
  
  add(metric) {
    this.queue.push(metric);
    
    if (this.queue.length >= this.batchSize) {
      this.flush();
    } else if (!this.timer) {
      this.timer = setTimeout(() => this.flush(), this.timeout);
    }
  }
  
  flush() {
    if (this.queue.length > 0) {
      navigator.sendBeacon('/metrics', JSON.stringify(this.queue));
      this.queue = [];
    }
    
    if (this.timer) {
      clearTimeout(this.timer);
      this.timer = null;
    }
  }
}

const batcher = new MetricsBatcher();
```

### 3. Фильтрация и нормализация данных

```javascript
// Нормализация метрик перед отправкой
function normalizeMetrics(metrics) {
  return {
    ...metrics,
    timestamp: Date.now(),
    url: window.location.href,
    userAgent: navigator.userAgent,
    viewport: {
      width: window.innerWidth,
      height: window.innerHeight
    },
    connection: navigator.connection ? {
      effectiveType: navigator.connection.effectiveType,
      rtt: navigator.connection.rtt
    } : undefined
  };
}
```

## Кастомные метрики

Кроме стандартных метрик, можно собирать кастомные показатели:

```javascript
// Отслеживание времени до первого взаимодействия с конкретным элементом
function trackFirstInteraction(selector) {
  const element = document.querySelector(selector);
  if (!element) return;
  
  const startTime = performance.now();
  
  const handler = () => {
    const interactionTime = performance.now() - startTime;
    
    sendMetricsAsync({
      metric: 'first_interaction',
      element: selector,
      time: interactionTime,
      timestamp: Date.now()
    });
    
    element.removeEventListener('click', handler);
    element.removeEventListener('focus', handler);
  };
  
  element.addEventListener('click', handler);
  element.addEventListener('focus', handler);
}
```

## Мониторинг ошибок и исключений

```javascript
// Сбор метрик об ошибках
function setupErrorMetrics() {
  window.addEventListener('error', (event) => {
    sendMetricsAsync({
      type: 'javascript_error',
      message: event.message,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
      stack: event.error?.stack
    });
  });
  
  window.addEventListener('unhandledrejection', (event) => {
    sendMetricsAsync({
      type: 'unhandled_rejection',
      reason: event.reason?.message || event.reason
    });
  });
}
```

## Заключение

Сбор метрик фронтенд-приложений - ключевой компонент системы мониторинга, позволяющий получать объективные данные о производительности и пользовательском опыте. Правильная реализация позволяет быстро реагировать на проблемы и принимать обоснованные решения по оптимизации приложения.

## См. также

- [[Архитектура-мониторинга]]
- [[Логирование]]
- [[Алертинг]]
- [[Аналитика]]