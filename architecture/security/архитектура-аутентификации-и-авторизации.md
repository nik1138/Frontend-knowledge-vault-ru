---
aliases: [Authentication and Authorization, Auth Architecture, Identity Management]
tags: [architecture, authentication, authorization, security, identity, jwt, oauth, session-management]
---

# Единая архитектура аутентификации и авторизации

## Обзор

Архитектура аутентификации и авторизации (AuthN/AuthZ) представляет собой систему управления идентичностью пользователей и контролем доступа к ресурсам приложения. Эта архитектура обеспечивает безопасность приложений, проверяя личность пользователей и определяя, какие действия они могут выполнять.

## Основные компоненты архитектуры

### 1. Система аутентификации

Система аутентификации отвечает за проверку личности пользователя. Она реализует различные методы проверки подлинности:

#### JWT (JSON Web Tokens)

JWT - это открытый стандарт (RFC 7519) для создания токенов доступа, которые обеспечивают безопасную передачу информации между сторонами в виде JSON-объекта.

```javascript
// Пример middleware для проверки JWT токенов
const jwt = require('jsonwebtoken');

class JwtAuthMiddleware {
  constructor(secret) {
    this.secret = secret;
  }

  authenticate(req, res, next) {
    const token = req.headers.authorization?.split(' ')[1];
    
    if (!token) {
      return res.status(401).json({ error: 'Access token required' });
    }

    try {
      const decoded = jwt.verify(token, this.secret);
      req.user = decoded;
      next();
    } catch (error) {
      return res.status(403).json({ error: 'Invalid or expired token' });
    }
  }
}
```

#### OAuth 2.0

OAuth 2.0 - это протокол авторизации, который позволяет сторонним приложениям получить ограниченный доступ к пользовательским аккаунтам HTTP-сервиса.

```javascript
// Пример использования OAuth 2.0
const OAuth2Strategy = require('passport-oauth2');

passport.use(new OAuth2Strategy({
  authorizationURL: 'https://auth.example.com/oauth/authorize',
  tokenURL: 'https://auth.example.com/oauth/token',
  clientID: process.env.OAUTH_CLIENT_ID,
  clientSecret: process.env.OAUTH_CLIENT_SECRET,
  callbackURL: 'https://myapp.com/auth/callback'
}, (accessToken, refreshToken, profile, done) => {
  // Обработка профиля пользователя
  return done(null, profile);
}));
```

#### Управление сессиями

Система управления сессиями отслеживает состояние аутентифицированных пользователей:

```javascript
// Пример сессионного middleware
const session = require('express-session');

app.use(session({
  secret: process.env.SESSION_SECRET,
  resave: false,
  saveUninitialized: false,
  cookie: { 
    secure: process.env.NODE_ENV === 'production',
    httpOnly: true,
    maxAge: 24 * 60 * 60 * 1000 // 24 часа
  }
}));
```

### 2. Система авторизации

Система авторизации определяет, какие действия может выполнять аутентифицированный пользователь:

#### Ролевая модель доступа (RBAC)

```javascript
// Пример RBAC системы
class AuthorizationService {
  constructor() {
    this.rolePermissions = new Map([
      ['admin', ['read', 'write', 'delete', 'manage_users']],
      ['editor', ['read', 'write']],
      ['viewer', ['read']]
    ]);
  }

  hasPermission(user, resource, action) {
    const userRoles = user.roles || [];
    
    for (const role of userRoles) {
      const permissions = this.rolePermissions.get(role) || [];
      if (permissions.includes(action)) {
        return true;
      }
    }
    
    return false;
  }
}
```

#### Проверка токенов JWT

```java
// Пример проверки JWT токенов в Java
@Component
public class JwtAuthenticationFilter implements Filter {

    @Autowired
    private JwtDecoder jwtDecoder;

    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) 
            throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        String authHeader = httpRequest.getHeader("Authorization");

        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            
            try {
                Jwt jwt = jwtDecoder.decode(token);
                // Добавление информации о пользователе в контекст безопасности
                SecurityContext context = SecurityContextHolder.createEmptyContext();
                // Установка аутентификации...
            } catch (JwtException e) {
                // Обработка ошибки JWT
            }
        }
        
        chain.doFilter(request, response);
    }
}
```

## Архитектурные паттерны

### 1. API Gateway с аутентификацией

API Gateway может обрабатывать аутентификацию на уровне шлюза:

```yaml
# Пример конфигурации аутентификации в API Gateway
apiVersion: gateway.example.com/v1
kind: APIGateway
metadata:
  name: auth-gateway
spec:
  routes:
    - path: /api/**
      authentication:
        method: jwt
        required: true
      authorization:
        roles: ["user", "admin"]
```

### 2. Многоуровневая аутентификация

```javascript
// Пример многоуровневой аутентификации
class MultiFactorAuth {
  async authenticate(username, password, secondFactor) {
    // Проверка основных учетных данных
    const user = await this.validateCredentials(username, password);
    
    if (!user) {
      throw new Error('Invalid credentials');
    }
    
    // Проверка второго фактора
    const isValidSecondFactor = await this.validateSecondFactor(
      user.id, 
      secondFactor
    );
    
    if (!isValidSecondFactor) {
      throw new Error('Invalid second factor');
    }
    
    // Генерация токена
    return this.generateToken(user);
  }
}
```

## Безопасность архитектуры

### Защита от атак

- Хранение токенов в безопасном месте (например, в HttpOnly cookies)
- Использование HTTPS для всех аутентификационных запросов
- Ограничение времени жизни токенов
- Правильная обработка ошибок аутентификации

### Рекомендации по безопасности

- Использование strong secrets для подписи токенов
- Регулярная ротация секретов
- Логирование попыток аутентификации
- Мониторинг подозрительной активности

## Тестирование архитектуры аутентификации

### Модульное тестирование

```javascript
// Пример теста для JWT middleware
describe('JwtAuthMiddleware', () => {
  it('should authenticate valid token', () => {
    const middleware = new JwtAuthMiddleware('test-secret');
    const req = { headers: { authorization: 'Bearer valid-token' } };
    const res = { status: jest.fn().mockReturnThis(), json: jest.fn() };
    const next = jest.fn();
    
    // Подделываем jwt.verify
    jwt.verify = jest.fn().mockReturnValue({ userId: 1 });
    
    middleware.authenticate(req, res, next);
    
    expect(next).toHaveBeenCalled();
    expect(req.user).toEqual({ userId: 1 });
  });
});
```

## Мониторинг и наблюдаемость

### Метрики безопасности

- Частота попыток аутентификации
- Количество успешных/неудачных попыток
- Время жизни сессий
- Использование различных методов аутентификации

## Связанные архитектурные концепции

- [[../security/unified-security-architecture]] - архитектура безопасности
- [[../api/unified-api-integration-architecture]] - архитектура интеграции API
- [[../observability/unified-observability-architecture]] - архитектура наблюдаемости

## Заключение

Архитектура аутентификации и авторизации является критическим компонентом безопасности приложений. Правильная реализация этой архитектуры обеспечивает защиту данных пользователей и предотвращает несанкционированный доступ к ресурсам.

#authentication #authorization #security #jwt #oauth #session-management #identity #frontend-security #api-security #security-architecture #security-patterns #security-best-practices #security-testing #security-monitoring